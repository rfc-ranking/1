<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ ë§¤ë‹ˆì € (v3.30 Seoul Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .rank-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rank-up { color: #dc2626; font-weight: 800; } .rank-down { color: #2563eb; font-weight: 800; } .rank-keep { color: #9ca3af; }
        .style-checkbox:checked + label { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        .tab-btn { @apply text-slate-500 border-b-2 border-transparent hover:text-slate-700 font-medium transition-colors; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 font-bold; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .rank-num-1 { color: #f59e0b; font-size: 1.2rem; text-shadow: 0 1px 2px rgba(245, 158, 11, 0.2); }
        .rank-num-2 { color: #94a3b8; font-size: 1.1rem; }
        .rank-num-3 { color: #ad8a56; font-size: 1.0rem; }
        .rank-num-normal { color: #64748b; font-size: 1.0rem; font-weight: 800; }
        .rank-unranked { color: #cbd5e1; font-size: 1.0rem; font-weight: 800; }
        
        /* Color Preset Styling */
        .color-preset { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .color-preset:hover { transform: scale(1.1); }
        .color-preset.active { border-color: #3b82f6; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3b82f6; }
        .color-preset.active::after { content: 'âœ”'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="text-slate-800 relative min-h-screen">

    <button id="undoBtn" onclick="executeUndo()" class="fixed bottom-6 right-6 z-50 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl font-bold flex items-center gap-2 transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed hidden">
        <span class="text-lg">â†©ï¸</span> ì‹¤í–‰ ì·¨ì†Œ (<span id="undoCount">0</span>)
    </button>

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-slate-200">
            <div class="text-4xl mb-2">ğŸ¥Š</div>
            <h2 class="text-2xl font-black text-slate-800 mb-6">RFC Admin Security</h2>
            <input type="email" id="adminEmail" placeholder="admin@rfc.com" class="w-full p-3 border border-slate-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
            <input type="password" id="adminPw" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
            <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg transition transform active:scale-95 shadow-lg shadow-blue-500/30">ì‹œìŠ¤í…œ ì ‘ì†</button>
        </div>
    </div>

    <div id="mainContent" class="max-w-6xl mx-auto p-4 hidden min-h-screen flex flex-col">
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">RFC ë§¤ë‹ˆì €</h1>
                <span id="currentSeasonBadge" class="bg-slate-800 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">Loading...</span>
                <span id="saveStatus" class="text-xs font-medium text-emerald-500 transition-opacity opacity-0">âœ… ì €ì¥ë¨ (Secure)</span>
            </div>
            <div class="mt-2 md:mt-0 text-xs text-slate-400 font-medium">v3.30 Seoul Fix</div>
        </header>

        <div class="bg-white rounded-t-2xl border-b border-slate-200 px-4 flex gap-6 mb-4 shadow-sm overflow-x-auto">
            <button onclick="switchTab('main')" id="tabMain" class="tab-btn active py-4 whitespace-nowrap">ğŸ”¥ ë­í‚¹/ê²½ê¸°</button>
            <button onclick="switchTab('season')" id="tabSeason" class="tab-btn py-4 whitespace-nowrap">ğŸ“… ì‹œì¦Œ ê´€ë¦¬</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn py-4 whitespace-nowrap">ğŸ› ï¸ ë°ì´í„°/ë°±ì—…</button>
            <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn py-4 whitespace-nowrap">âš™ï¸ ì„¤ì •/ë©”ëª¨</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <div class="lg:col-span-4 space-y-6">
                <div id="mainSection" class="tab-content">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-700">âš”ï¸ ê²½ê¸° ê²°ê³¼ ì…ë ¥</h3></div>
                        <div class="p-5">
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-blue-600 mb-1 pl-1">ğŸ”µ Blue</label>
                                        <div class="flex items-center gap-2">
                                            <select id="p1Select" class="w-full text-sm border-slate-200 rounded-lg p-2.5 bg-blue-50/50 outline-none"></select>
                                            <div id="p1TrunkIndicator" class="w-8 h-8 rounded-full border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="ë°”ì§€ ìƒ‰ìƒ"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-red-600 mb-1 pl-1">ğŸ”´ Red</label>
                                        <div class="flex items-center gap-2">
                                            <select id="p2Select" class="w-full text-sm border-slate-200 rounded-lg p-2.5 bg-red-50/50 outline-none"></select>
                                            <div id="p2TrunkIndicator" class="w-8 h-8 rounded-full border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="ë°”ì§€ ìƒ‰ìƒ"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-2 rounded-xl border border-slate-200">
                                    <label class="cursor-pointer flex flex-col items-center gap-1 p-3 rounded-lg hover:bg-blue-100 transition border border-transparent has-[:checked]:bg-blue-100 has-[:checked]:border-blue-300"><input type="radio" name="winner" value="blue" class="w-5 h-5 accent-blue-600"><span class="text-sm font-bold text-blue-600">Blue ìŠ¹</span></label>
                                    <label class="cursor-pointer flex flex-col items-center gap-1 p-3 rounded-lg hover:bg-red-100 transition border border-transparent has-[:checked]:bg-red-100 has-[:checked]:border-red-300"><input type="radio" name="winner" value="red" class="w-5 h-5 accent-red-600"><span class="text-sm font-bold text-red-600">Red ìŠ¹</span></label>
                                </div>
                                <div id="matchPreview" class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 border border-gray-200 hidden"><div id="previewContent" class="space-y-1"></div></div>
                                <button onclick="applyMatch()" class="w-full bg-gradient-to-r from-slate-800 to-slate-900 hover:from-black text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">ê²½ê¸° í™•ì •</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">ğŸ‘¤ ì„ ìˆ˜ ê´€ë¦¬ ë„êµ¬</h3>
                        <button onclick="addNewPlayer()" class="w-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-3 rounded-xl border border-emerald-100 mb-3 transition">+ ìƒˆ ì„ ìˆ˜ ë“±ë¡</button>
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-3">
                            <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-orange-700">ğŸ’€ íŒ¨ë„í‹° ë¶€ì—¬ (-30ì )</h4></div>
                            <div class="flex gap-2"><select id="penaltyTargetSelect" class="w-full text-xs border border-orange-200 rounded p-2 focus:outline-none bg-white"><option value="">ëŒ€ìƒ ì„ íƒ...</option></select><button onclick="applyManualPenalty()" class="bg-white text-orange-700 font-bold px-3 py-2 rounded-lg text-xs border border-orange-200 transition hover:bg-orange-100 whitespace-nowrap">ì‹¤í–‰</button></div>
                        </div>
                        <button onclick="updateRankBaseline()" class="w-full bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold py-3 rounded-xl text-xs transition">ğŸ“‰ ìˆœìœ„ ë³€ë™(â–²â–¼) ë¦¬ì…‹</button>
                    </div>
                </div>

                <div id="seasonSection" class="tab-content hidden">
                    <div class="space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><h3 class="font-bold text-slate-700 mb-3 border-b pb-2">ğŸ“… ì‹œì¦Œ ëª©ë¡</h3><div id="seasonListContainer" class="space-y-2 max-h-60 overflow-y-auto mb-2"></div><p class="text-[10px] text-slate-400 mt-2">* ëª©ë¡ì—ì„œ ì‚­ì œí•˜ë©´ ì‚¬ìš©ì í™”ë©´ì—ì„œë„ ì¦‰ì‹œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p></div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700">ğŸ˜´ ë¯¸ì°¸ì—¬ ì„ ìˆ˜</h3><span id="seasonInactiveCount" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">0ëª…</span></div><div class="text-xs text-slate-500 mb-3">í˜„ì¬ ì‹œì¦Œ(<span class="currentSeasonName font-bold"></span>) ê²½ê¸° ê¸°ë¡ ì—†ìŒ</div><button onclick="toggleInactiveList()" class="text-xs text-blue-500 font-bold underline mb-2">ëª©ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button><ul id="seasonInactiveList" class="hidden bg-slate-50 p-2 rounded text-xs text-slate-600 space-y-1 mb-3 max-h-40 overflow-y-auto border border-slate-200"></ul></div>
                        <div class="bg-purple-50 rounded-2xl shadow-sm border border-purple-100 overflow-hidden p-5"><h3 class="font-bold text-purple-800 mb-2">ğŸš€ ì‹œì¦Œ ì¢…ë£Œ ë° ì‹œì‘</h3><p class="text-xs text-purple-600 mb-4">í˜„ì¬ ì‹œì¦Œì„ ë§ˆê°í•˜ê³  ìƒˆ ì‹œì¦Œì„ ì‹œì‘í•©ë‹ˆë‹¤.</p><div class="flex gap-2"><input type="text" id="newSeasonNameInput" class="flex-grow border border-purple-200 rounded-lg p-2 text-sm focus:outline-none focus:border-purple-400" placeholder="ìƒˆ ì‹œì¦Œ ì´ë¦„"><button onclick="finishAndStartNewSeason()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg text-xs shadow transition whitespace-nowrap">ì‹œì¦Œ ì‹œì‘</button></div></div>
                    </div>
                </div>

                <div id="toolsSection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 space-y-4">
                        <h3 class="font-bold text-slate-700">ğŸ› ï¸ ë°ì´í„° ë„êµ¬</h3>
                        <div class="grid grid-cols-2 gap-2"><input type="file" id="importFile" accept=".json" class="hidden"><button onclick="document.getElementById('importFile').click()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg text-xs">ğŸ“‚ ë°ì´í„° ë³µì›</button><button onclick="backupData()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg text-xs">ğŸ’¾ ë°ì´í„° ë°±ì—…</button></div>
                        <div class="pt-4 border-t border-slate-100 space-y-2">
                            <h4 class="text-xs font-bold text-red-500">ì´ˆê¸°í™” (ì£¼ì˜)</h4>
                            <button onclick="resetAllStats()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">ğŸ“Š í˜„ì¬ ì‹œì¦Œ ì „ì  ì´ˆê¸°í™”</button>
                            <button onclick="resetAllElo()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">âš¡ í˜„ì¬ ì‹œì¦Œ ELO ì´ˆê¸°í™”</button>
                            
                            <button onclick="resetAllPasswords()" class="w-full bg-orange-50 text-orange-600 hover:bg-orange-100 font-bold py-3 rounded-lg text-xs border border-orange-200 mt-2">ğŸ”‘ ì „ì²´ ë¹„ë°€ë²ˆí˜¸ ì¬ë°œê¸‰ (ëª…ë‹¨ ë³µì‚¬)</button>
                            
                            <button onclick="resetEverything()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-lg text-xs border border-red-200 mt-2">ğŸ§¨ ì‹œìŠ¤í…œ ì „ì²´ ë¦¬ì…‹</button>
                        </div>
                    </div>
                </div>

                <div id="settingsSection" class="tab-content hidden">
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                            <h3 class="font-bold text-slate-700 mb-2">ğŸ“œ ê·œì¹™ HTML í¸ì§‘</h3>
                            <p class="text-[10px] text-slate-400 mb-3">HTML ì½”ë“œë¡œ ë””ìì¸ëœ ê·œì¹™ì„ ìˆ˜ì •í•©ë‹ˆë‹¤.</p>
                            <textarea id="ruleHtmlInput" class="w-full h-48 p-3 text-xs font-mono border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 resize-none mb-3" placeholder="HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="loadDefaultRuleHtml()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-2.5 rounded-lg text-xs hover:bg-slate-200 transition">â†º ê¸°ë³¸ ë””ìì¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                                <button onclick="saveRules()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg text-xs transition">ê·œì¹™ ì €ì¥í•˜ê¸°</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 flex flex-col h-[400px]">
                            <h3 class="font-bold text-slate-700 mb-3 flex justify-between">
                                ğŸ“ ê´€ë¦¬ì ë©”ëª¨ì¥
                                <span class="text-[10px] font-normal text-slate-400">ê´€ë¦¬ìê°„ ê³µìœ ìš©</span>
                            </h3>
                            <div id="memoListContainer" class="flex-grow overflow-y-auto space-y-2 mb-3 pr-1 bg-slate-50 rounded-lg p-2 border border-slate-100"><div class="text-center text-xs text-gray-400 py-4">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
                            <div class="flex gap-2"><input type="text" id="newMemoInput" class="flex-grow border border-slate-200 rounded-lg p-2.5 text-sm focus:outline-none focus:border-blue-500" placeholder="ë©”ì„¸ì§€ ë‚¨ê¸°ê¸°..." onkeypress="if(event.key==='Enter') addMemo()"><button onclick="addMemo()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold px-4 rounded-lg text-xs transition whitespace-nowrap">ë“±ë¡</button></div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[calc(100vh-140px)]">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                    <div><h3 class="font-bold text-slate-700">ğŸ”¥ ì‹¤ì‹œê°„ ë­í‚¹</h3><p class="text-[10px] text-slate-400 font-medium mt-0.5">í˜„ì¬ í™œì„± ì‹œì¦Œ: <span class="currentSeasonName text-blue-600 font-bold"></span></p></div>
                    <div class="flex-grow mx-4"><input type="text" id="searchInput" placeholder="ğŸ” ì„ ìˆ˜ ê²€ìƒ‰..." class="w-full text-xs border border-slate-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition"></div>
                    <div class="flex gap-2"><button onclick="window.open('index.html')" class="bg-white border border-slate-200 text-slate-600 text-xs font-bold py-2 px-3 rounded-lg hover:bg-slate-50">ğŸŒ ì‚¬ì´íŠ¸ ë³´ê¸°</button><button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow hover:bg-indigo-700">ğŸ’¾ ì €ì¥</button></div>
                </div>
                <div id="rankingList" class="flex-grow overflow-y-auto p-2 space-y-1.5 bg-slate-50/50"></div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="editPlayerId"><input type="hidden" id="editOriginalName">
            <div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-xs text-gray-500 block mb-1">ì´ë¦„</label><input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold"></div><div><label class="text-xs text-gray-500 block mb-1">ë°©ì–´ì „ íšŸìˆ˜ (ë¯¸ì‚¬ìš©)</label><input type="number" id="editDefenses" class="w-full border p-2 rounded text-sm bg-gray-100 text-gray-400" disabled></div></div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <div><label class="text-xs text-gray-500 block mb-1">Game ID</label><input type="text" id="editGameId" class="w-full border p-2 rounded text-sm" placeholder="ID ì…ë ¥"></div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1 font-bold text-blue-600">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="flex gap-1">
                        <input type="text" id="editPassword" class="w-full border p-2 rounded text-sm font-mono font-bold bg-blue-50 text-blue-700" placeholder="ìˆ˜ì • ì‹œ ì…ë ¥">
                        <button onclick="resetIndividualPassword()" class="bg-slate-200 text-slate-700 px-2 rounded-lg text-xs hover:bg-slate-300 font-bold transition flex items-center justify-center shadow-sm" title="ëœë¤ ì´ˆê¸°í™” & ë³µì‚¬">ğŸ”„</button>
                    </div>
                </div>

                <div><label class="text-xs text-gray-500 block mb-1">ELO (ìˆ˜ë™)</label><input type="number" id="editElo" class="w-full border p-2 rounded text-sm text-amber-600 font-bold bg-amber-50"></div>
            </div>
            <div class="mb-3 p-3 bg-gray-50 rounded border border-gray-200"><label class="block text-xs font-bold text-gray-600 mb-2">ğŸ“Š ì‹œì¦Œ ì „ì  ìˆ˜ë™ ì¡°ì ˆ</label><div class="grid grid-cols-2 gap-3"><div><label class="text-xs text-gray-400">ìŠ¹ (Wins)</label><input type="number" id="editWins" class="w-full border p-2 rounded text-sm text-center font-bold text-green-600"></div><div><label class="text-xs text-gray-400">íŒ¨ (Losses)</label><input type="number" id="editLosses" class="w-full border p-2 rounded text-sm text-center font-bold text-red-600"></div></div></div>
            
            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-1">í”„ë¡œí•„ ì´ë¯¸ì§€ (URL ì£¼ì†Œ)</label>
                <div class="flex items-start gap-4">
                    <div class="relative w-16 h-16 shrink-0"><img id="previewImage" src="" class="w-full h-full rounded-2xl object-cover border border-gray-200 bg-gray-50" onerror="this.src='https://placehold.co/150?text=No+Img'"><button onclick="removeImage()" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm hover:bg-red-600" title="ì§€ìš°ê¸°"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div>
                    <div class="flex-grow"><input type="text" id="editImageUrlInput" placeholder="ì˜ˆ: https://imgur.com/..." class="w-full border p-2 rounded text-sm bg-slate-50 focus:bg-white transition" oninput="updatePreview(this.value)"><p class="text-[10px] text-gray-400 mt-1.5 leading-snug">* <strong>ì‚¬ìš©ë²•:</strong> ë””ìŠ¤ì½”ë“œë‚˜ ì¹´í†¡ì— ì‚¬ì§„ì„ ì˜¬ë¦° ë’¤, ìš°í´ë¦­í•˜ì—¬ <strong>'ì´ë¯¸ì§€ ì£¼ì†Œ ë³µì‚¬'</strong> í›„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.</p></div>
                </div>
            </div>

            <div class="grid grid-cols-4 gap-3 mb-3">
                <div class="col-span-1"><label class="text-xs text-gray-500 block mb-1">í‚¤ (cm)</label><input type="text" id="editHeight" class="w-full border p-2 rounded text-sm"></div>
                <div class="col-span-1"><label class="text-xs text-gray-500 block mb-1">ë¦¬ì¹˜ (cm)</label><input type="text" id="editReach" class="w-full border p-2 rounded text-sm"></div>
                <div class="col-span-2"><label class="text-xs text-gray-500 block mb-1">ìŠ¤íƒ ìŠ¤</label><select id="editStance" class="w-full border p-2 rounded text-sm bg-white"><option value="Orthodox">Orthodox</option><option value="Southpaw">Southpaw</option><option value="Switch">Switch</option></select></div>
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-2">ë°”ì§€ ìƒ‰ìƒ (10ê°€ì§€ í”„ë¦¬ì…‹)</label>
                <div id="trunkColorPresets" class="flex flex-wrap gap-2">
                    </div>
                <input type="hidden" id="editTrunkColor">
            </div>

            <div class="mb-6 p-3 bg-slate-50 rounded border border-slate-200"><label class="block text-xs font-bold text-slate-600 mb-2">ğŸ¥Š ìŠ¤íƒ€ì¼ íƒœê·¸</label><div id="styleTagsContainer" class="flex flex-wrap gap-2"></div></div>
            
            <div class="flex justify-between items-center">
                <button onclick="deletePlayer()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold transition border border-red-200">ğŸ—‘ï¸ ì„ ìˆ˜ ì‚­ì œ</button>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button>
                    <button onclick="savePlayerDetails()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk", authDomain: "rfk-ranking.firebaseapp.com", projectId: "rfk-ranking", storageBucket: "rfk-ranking.firebasestorage.app", messagingSenderId: "675366165774", appId: "1:675366165774:web:795d34c56eab630b4dcb5f", measurementId: "G-CXPDZQ8GTL" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = 'ranking-manager-default';
        
        let rankingsData = []; let matchHistoryData = []; let seasonArchives = {}; let activeSeason = "ì‹œì¦Œ 1"; let adminMemos = []; let ruleHtml = "";
        let undoStack = []; const MAX_UNDO = 10;
        let searchQuery = "";

        const STYLE_OPTIONS = ["ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "í•˜ë“œ í€ì²˜", "ë°”ë”” ìŠ¤ë‚´ì²˜", "ë³¼ë¥¨ í€ì²˜", "ìŠ¤ìœ„ì¹˜ íˆí„°", "ë¸Œë¡¤ëŸ¬", "ì¹´ìš´í„° í€ì²˜", "ë³µì„œ-í€ì²˜", "ìŠ¬ë¦­", "ìƒ¤í”„ìŠˆí„°", "íŒ¨ìŠ¤íŠ¸ í•¸ë“œ"];
        const COLOR_PRESETS = [
            { name: "Black", code: "#1f2937" }, { name: "White", code: "#f8fafc" },
            { name: "Red", code: "#ef4444" }, { name: "Blue", code: "#3b82f6" },
            { name: "Green", code: "#22c55e" }, { name: "Yellow", code: "#eab308" },
            { name: "Purple", code: "#a855f7" }, { name: "Orange", code: "#f97316" },
            { name: "Pink", code: "#ec4899" }, { name: "Gray", code: "#94a3b8" }
        ];

        const DEFAULT_RULE_HTML = `<div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><h3 class="font-bold text-blue-700 mb-2 text-base">1. ì ìˆ˜ ê³„ì‚° ê³µì‹</h3><ol class="list-decimal pl-4 space-y-2 text-xs"><li><strong>ê¸°ë³¸ ì›ë¦¬:</strong> ìƒëŒ€ì™€ì˜ ì ìˆ˜ ì°¨ì´ì— ë”°ë¼ íšë“/ì°¨ê° ì ìˆ˜ê°€ ë‹¬ë¼ì§‘ë‹ˆë‹¤. (ELO ì‹œìŠ¤í…œ)</li><li><strong>í‹°ì–´ ë°°ìœ¨ ì ìš©:</strong> ì „ì (íŒìˆ˜)ì— ë”°ë¼ ìŠ¹ë¦¬/íŒ¨ë°° ë°°ìœ¨ì´ ë‹¤ë¥´ê²Œ ì ìš©ë©ë‹ˆë‹¤.</li><li><strong>ğŸ”¥ ì°¸ì—¬ ë³´ë„ˆìŠ¤:</strong> í™œë°œí•œ ì°¸ì—¬ë¥¼ ìœ„í•´ ê²°ê³¼ì— ë¬´ì¡°ê±´ <span class="text-red-500 font-bold">+5ì </span>ì„ ë”í•´ì¤ë‹ˆë‹¤.</li></ol></div><div><h3 class="font-bold text-slate-800 mb-2">2. ìˆ™ë ¨ë„(íŒìˆ˜)ë³„ í˜œíƒ</h3><ul class="list-disc pl-4 space-y-1 text-xs"><li><span class="font-bold text-amber-700">ğŸ¥‰ ë¸Œë¡ ì¦ˆ (0~2ì „):</span> ê¸°ë³¸ ì ìˆ˜ (x1.0)</li><li><span class="font-bold text-slate-500">ğŸ¥ˆ ì‹¤ë²„ (3~6ì „):</span> ìŠ¹ë¦¬ ì‹œ <span class="text-blue-600">1.1ë°°</span> / íŒ¨ë°° ì‹œ <span class="text-red-500">0.9ë°°</span></li><li><span class="font-bold text-amber-500">ğŸ¥‡ ê³¨ë“œ (7ì „ ì´ìƒ):</span> ìŠ¹ë¦¬ ì‹œ <span class="text-blue-600">1.2ë°°</span> / íŒ¨ë°° ì‹œ <span class="text-red-500">0.8ë°°</span></li></ul></div><div class="grid grid-cols-2 gap-3"><div class="p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="font-bold text-xs block mb-1">ğŸ ì°¸ì—¬ ì¥ë ¤</span><span class="text-[11px] leading-tight block">ìŠ¹íŒ¨ì™€ ìƒê´€ì—†ì´ ê¸°ë³¸ <span class="text-blue-600 font-bold">+5ì </span>ì„ ì¶”ê°€ë¡œ ì§€ê¸‰í•©ë‹ˆë‹¤.</span></div><div class="p-3 bg-orange-50 rounded-xl border border-orange-100"><span class="font-bold text-xs text-orange-700 block mb-1">ğŸ“‰ ë¶ˆì°¸ íŒ¨ë„í‹°</span><span class="text-[11px] leading-tight block">ë­í‚¹ì „ <span class="font-bold">níšŒ ì´ìƒ ë¶ˆì°¸ ì‹œ</span> ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ <span class="text-red-600 font-bold">-30ì </span> ì°¨ê°ë©ë‹ˆë‹¤.</span></div></div>`;

        // [KST Date Helper] v3.30 ìˆ˜ì •ë¨: ê³„ì‚°ì‹ì´ ì•„ë‹Œ ë¸Œë¼ìš°ì € ë‚´ì¥ ê¸°ëŠ¥(Intl) ì‚¬ìš©
        function getKSTDate() {
            // ì´ ë°©ì‹ì€ ë¸Œë¼ìš°ì €ì—ê²Œ "Asia/Seoul ì‹œê°„ëŒ€ë¡œ YYYY-MM-DD í¬ë§·ì„ ë‚´ë†”ë¼"ê³  ê°•ì œí•©ë‹ˆë‹¤.
            // ì‹œê°„ì°¨ê°€ ë°œìƒí•  ì—¬ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
            return new Date().toLocaleDateString("en-CA", { 
                timeZone: "Asia/Seoul" 
            });
        }

        // [Security] SHA-256 Hash Function
        async function hashPin(pin) {
            if (!pin) return "";
            const msgBuffer = new TextEncoder().encode(pin);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.getElementById('btnLogin').addEventListener('click', () => { const email = document.getElementById('adminEmail').value; const pw = document.getElementById('adminPw').value; signInWithEmailAndPassword(auth, email, pw).catch((e) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message)); });
        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('loginOverlay').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); loadData(); } });

        document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value.toLowerCase(); renderRankings(); });
        
        // Generate Color Presets in Modal
        const presetContainer = document.getElementById('trunkColorPresets');
        COLOR_PRESETS.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-preset shadow-sm';
            div.style.backgroundColor = color.code;
            div.title = color.name;
            div.onclick = () => selectPresetColor(color.code, div);
            presetContainer.appendChild(div);
        });

        function selectPresetColor(code, element) {
            document.getElementById('editTrunkColor').value = code;
            document.querySelectorAll('.color-preset').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        function loadData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data(); rankingsData = data.rankings || []; matchHistoryData = data.matchHistory || []; seasonArchives = data.seasonArchives || {}; activeSeason = data.activeSeason || "ì‹œì¦Œ 1"; adminMemos = data.adminMemos || []; ruleHtml = data.ruleHtml || DEFAULT_RULE_HTML;
                    updateSeasonUI(); renderMemos(); document.getElementById('ruleHtmlInput').value = ruleHtml;
                    rankingsData.forEach((p, i) => { if(p.defenseCount === undefined) p.defenseCount = 0; if(p.previousRank === undefined) p.previousRank = i + 1; if(p.careerHighRank === undefined) p.careerHighRank = i + 1; if(p.elo === undefined) p.elo = 1000; if(p.careerHighElo === undefined) p.careerHighElo = p.elo; });
                    renderRankings(); populateMatchSelectors(); renderSeasonList(); checkSeasonInactive();
                }
            });
        }

        function captureState() {
            const currentState = { rankings: JSON.parse(JSON.stringify(rankingsData)), matchHistory: JSON.parse(JSON.stringify(matchHistoryData)), seasonArchives: JSON.parse(JSON.stringify(seasonArchives)), activeSeason: activeSeason };
            undoStack.push(currentState); if (undoStack.length > MAX_UNDO) undoStack.shift(); updateUndoUI();
        }
        window.executeUndo = async () => { if (undoStack.length === 0) return; const prevState = undoStack.pop(); rankingsData = prevState.rankings; matchHistoryData = prevState.matchHistory; seasonArchives = prevState.seasonArchives; activeSeason = prevState.activeSeason; await saveRankings(true); renderRankings(); updateUndoUI(); alert("ì´ì „ ìƒíƒœë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤."); };
        function updateUndoUI() { const btn = document.getElementById('undoBtn'); const cnt = document.getElementById('undoCount'); if (undoStack.length > 0) { btn.classList.remove('hidden'); btn.classList.add('pop-in'); btn.disabled = false; cnt.textContent = undoStack.length; } else { btn.classList.add('hidden'); } }
        
        window.saveRankings = async function(isUndo = false) { 
            const statusEl = document.getElementById('saveStatus'); 
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); 
            try { 
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) throw "Document does not exist!";
                    
                    const payload = { rankings: rankingsData, matchHistory: matchHistoryData, seasonArchives: seasonArchives, activeSeason: activeSeason, date: new Date().toISOString() }; 
                    if(!isUndo) { payload.adminMemos = adminMemos; payload.ruleHtml = ruleHtml; } 
                    
                    transaction.set(docRef, payload, { merge: true });
                });

                statusEl.style.opacity = 1; setTimeout(() => statusEl.style.opacity = 0, 2000); 
            } catch (e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); } 
        }

        window.saveRules = () => { ruleHtml = document.getElementById('ruleHtmlInput').value; saveRankings(); alert("ê·œì¹™ ë””ìì¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); };
        window.loadDefaultRuleHtml = () => { if(confirm("ê¸°ë³¸ ì˜ˆìœ ë””ìì¸ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) { document.getElementById('ruleHtmlInput').value = DEFAULT_RULE_HTML; } };
        window.addMemo = () => { const input = document.getElementById('newMemoInput'); const content = input.value.trim(); if (!content) return; adminMemos.unshift({ id: Date.now(), content: content, date: new Date().toLocaleString() }); input.value = ''; saveRankings(); renderMemos(); };
        window.deleteMemo = (id) => { if(!confirm("ì‚­ì œ?")) return; adminMemos = adminMemos.filter(m => m.id !== id); saveRankings(); renderMemos(); };
        function renderMemos() { const container = document.getElementById('memoListContainer'); if(adminMemos.length === 0) { container.innerHTML = '<div class="text-center text-xs text-gray-400 py-4">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } container.innerHTML = ''; adminMemos.forEach(m => { const el = document.createElement('div'); el.className = 'bg-white border border-slate-200 rounded p-2 text-sm shadow-sm flex justify-between items-start group'; el.innerHTML = `<div><div class="text-[10px] text-slate-400 font-medium mb-0.5">${m.date}</div><div class="text-slate-700 whitespace-pre-wrap">${m.content}</div></div><button onclick="deleteMemo(${m.id})" class="text-slate-300 hover:text-red-500 text-xs px-1 opacity-0 group-hover:opacity-100 transition">âœ•</button>`; container.appendChild(el); }); }
        window.switchTab = (tab) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(tab + 'Section').classList.remove('hidden'); document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active'); };
        function updateSeasonUI() { document.getElementById('currentSeasonBadge').textContent = activeSeason; document.querySelectorAll('.currentSeasonName').forEach(el => el.textContent = activeSeason); const num = parseInt(activeSeason.replace(/[^0-9]/g, '')) || 0; document.getElementById('newSeasonNameInput').value = `ì‹œì¦Œ ${num + 1}`; }
        function renderSeasonList() { const container = document.getElementById('seasonListContainer'); container.innerHTML = ''; const seasons = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)]; seasons.forEach(sName => { const isActive = sName === activeSeason; const div = document.createElement('div'); div.className = `flex justify-between items-center p-3 rounded-lg border ${isActive ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200'}`; div.innerHTML = `<div class="flex items-center gap-2"><span class="${isActive ? 'text-blue-700 font-bold' : 'text-slate-600'} text-sm">${sName}</span>${isActive ? '<span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded">Active</span>' : ''}</div><div class="flex gap-1">${!isActive ? `<button onclick="switchActiveSeason('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 rounded border border-slate-200">ì„ íƒ</button>` : ''}<button onclick="renameSeason('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-500 px-2 py-1 rounded border border-slate-200">ì´ë¦„ë³€ê²½</button>${!isActive ? `<button onclick="deleteSeason('${sName}')" class="text-xs bg-red-50 hover:bg-red-100 text-red-500 px-2 py-1 rounded border border-red-100">ì‚­ì œ</button>` : ''}</div>`; container.appendChild(div); }); }
        window.deleteSeason = (targetName) => { if (targetName === activeSeason) return alert("í˜„ì¬ í™œì„± ì‹œì¦Œì€ ì‚­ì œ ë¶ˆê°€"); if (!confirm(`[${targetName}] ë° ê¸°ë¡ ì‚­ì œ?`)) return; delete seasonArchives[targetName]; matchHistoryData = matchHistoryData.filter(m => m.season !== targetName); saveRankings().then(() => { renderSeasonList(); alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }); };
        window.switchActiveSeason = (targetName) => { if (!confirm(`[${targetName}] ì „í™˜?`)) return; captureState(); seasonArchives[activeSeason] = { rankings: JSON.parse(JSON.stringify(rankingsData)) }; const t = seasonArchives[targetName]; if (t) rankingsData = t.rankings || []; delete seasonArchives[targetName]; activeSeason = targetName; saveRankings(); alert("ì „í™˜ ì™„ë£Œ"); };
        window.renameSeason = (old) => { const n = prompt("ìƒˆ ì´ë¦„:", old); if(!n||n===old)return; if(n===activeSeason||seasonArchives[n])return alert("ì¤‘ë³µ ì´ë¦„"); if(old===activeSeason)activeSeason=n; else { seasonArchives[n]=seasonArchives[old]; delete seasonArchives[old]; } matchHistoryData.forEach(m => { if(m.season===old) m.season=n; }); saveRankings(); };
        window.finishAndStartNewSeason = () => { const n = document.getElementById('newSeasonNameInput').value.trim(); if(!n)return alert("ì´ë¦„ ì…ë ¥"); if(n===activeSeason||seasonArchives[n])return alert("ì¤‘ë³µ ì´ë¦„"); if(!confirm(`[${activeSeason}] ì¢…ë£Œ í›„ [${n}] ì‹œì‘?`))return; captureState(); seasonArchives[activeSeason]={rankings:JSON.parse(JSON.stringify(rankingsData))}; activeSeason=n; rankingsData.forEach(p => { p.previousRank=p.rank||rankingsData.indexOf(p)+1; p.wins=0; p.losses=0; p.draws=0; p.defenseCount=0; p.elo=1000; }); saveRankings(); alert("ì‹œì‘ë¨"); };

        function getTierBonus(matchCount) { if (matchCount < 3) return { winMult: 1.0, lossMult: 1.0, tier: 'ğŸ¥‰Bronze' }; else if (matchCount < 7) return { winMult: 1.1, lossMult: 0.9, tier: 'ğŸ¥ˆSilver' }; else return { winMult: 1.2, lossMult: 0.8, tier: 'ğŸ¥‡Gold' }; }
        function calculateHybridEloChange(p1Elo, p2Elo, isWin, p1Stats) { 
            const matchCount = (p1Stats.wins || 0) + (p1Stats.losses || 0); 
            const K = 60; 
            const expected = 1 / (1 + Math.pow(10, (p2Elo - p1Elo) / 400)); 
            const { winMult, lossMult, tier } = getTierBonus(matchCount); 
            let finalChange = 0; let breakdown = ""; 
            if (isWin) { let baseGain = K * (1 - expected); finalChange = (baseGain * winMult) + 5; breakdown = `${tier}ìŠ¹(x${winMult}) + 5`; } 
            else { let baseLoss = K * (0 - expected); finalChange = (baseLoss * lossMult) + 5; breakdown = `${tier}íŒ¨(x${lossMult}) + 5`; } 
            return { change: Math.round(finalChange), msg: breakdown }; 
        }

        // [KST Patch] applyMatch ë‚ ì§œ ë¡œì§ ìˆ˜ì •
        window.applyMatch = () => { 
            const p1Idx = parseInt(document.getElementById('p1Select').value); 
            const p2Idx = parseInt(document.getElementById('p2Select').value); 
            const winnerVal = document.querySelector('input[name="winner"]:checked')?.value; 
            if (!winnerVal || isNaN(p1Idx) || isNaN(p2Idx)) return alert("ì„ íƒ ì˜¤ë¥˜"); 
            if (p1Idx === p2Idx) return alert("ë™ì¼ ì„ ìˆ˜"); 
            const p1 = rankingsData[p1Idx]; 
            const p2 = rankingsData[p2Idx]; 
            const isBlueWin = winnerVal === 'blue'; 
            const winner = isBlueWin ? p1 : p2; 
            const loser = isBlueWin ? p2 : p1; 
            captureState(); 
            const winCalc = calculateHybridEloChange(winner.elo, loser.elo, true, winner); 
            const loseCalc = calculateHybridEloChange(loser.elo, winner.elo, false, loser); 
            winner.elo += winCalc.change; 
            loser.elo += loseCalc.change; 
            if (winner.elo > (winner.careerHighElo || 0)) winner.careerHighElo = winner.elo; 
            if (loser.elo > (loser.careerHighElo || 0)) loser.careerHighElo = loser.elo; 
            let type = 'ranking'; 
            winner.wins++; 
            loser.losses++; 
            
            // [ì¤‘ìš”] í•œêµ­ ì‹œê°„ ì ìš© (v3.30)
            const today = getKSTDate(); 
            
            winner.lastMatchDate = today; 
            loser.lastMatchDate = today; 
            rankingsData.sort((a, b) => b.elo - a.elo); 
            matchHistoryData.unshift({ date: today, winner: isBlueWin ? p1.name : p2.name, loser: isBlueWin ? p2.name : p1.name, type, season: activeSeason, blue: p1.name }); 
            saveRankings(); 
            renderRankings(); 
            alert(`ë°˜ì˜ ì™„ë£Œ!\n${winner.name}: +${winCalc.change}\n${loser.name}: ${loseCalc.change}`); 
        };
        
        function updateMatchPreview() { 
            const p1Idx = document.getElementById('p1Select').value; 
            const p2Idx = document.getElementById('p2Select').value; 
            
            // Update Trunk Colors in Match Input
            const p1Ind = document.getElementById('p1TrunkIndicator');
            const p2Ind = document.getElementById('p2TrunkIndicator');
            
            if (p1Idx !== "") p1Ind.style.backgroundColor = rankingsData[p1Idx].trunkColor || '#f1f5f9';
            else p1Ind.style.backgroundColor = '#f1f5f9';

            if (p2Idx !== "") p2Ind.style.backgroundColor = rankingsData[p2Idx].trunkColor || '#f1f5f9';
            else p2Ind.style.backgroundColor = '#f1f5f9';

            if (p1Idx === "" || p2Idx === "" || p1Idx === p2Idx) { document.getElementById('matchPreview').classList.add('hidden'); return; } 
            
            document.getElementById('matchPreview').classList.remove('hidden'); const p1 = rankingsData[parseInt(p1Idx)]; const p2 = rankingsData[parseInt(p2Idx)]; const blueWin = calculateHybridEloChange(p1.elo, p2.elo, true, p1); const redLose = calculateHybridEloChange(p2.elo, p1.elo, false, p2); const redWin = calculateHybridEloChange(p2.elo, p1.elo, true, p2); const blueLose = calculateHybridEloChange(p1.elo, p2.elo, false, p1); document.getElementById('previewContent').innerHTML = `<div class="font-bold text-blue-600">ğŸ”µ BlueìŠ¹: +${blueWin.change} / ğŸ”´ RedíŒ¨: ${redLose.change}</div><div class="font-bold text-red-600 mt-1">ğŸ”´ RedìŠ¹: +${redWin.change} / ğŸ”µ BlueíŒ¨: ${blueLose.change}</div>`; 
        }
        document.getElementById('p1Select').addEventListener('change', updateMatchPreview); document.getElementById('p2Select').addEventListener('change', updateMatchPreview);
        window.resetAllElo = () => { if(!confirm("ELO 1000 ì´ˆê¸°í™”?")) return; captureState(); rankingsData.forEach(p => p.elo = 1000); saveRankings(); renderRankings(); };
        window.resetAllStats = () => { if(!confirm("âš ï¸ ì£¼ì˜: í˜„ì¬ ì‹œì¦Œì˜ [ìŠ¹/íŒ¨ ìˆ«ì]ì™€ [ëª¨ë“  ê²½ê¸° ê¸°ë¡]ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ìµœê·¼ ì „ì  í‘œì‹œë„ ì‚¬ë¼ì§‘ë‹ˆë‹¤)")) return; captureState(); rankingsData.forEach(p => { p.wins = 0; p.losses = 0; }); matchHistoryData = matchHistoryData.filter(m => m.season !== activeSeason); saveRankings(); renderRankings(); alert("í˜„ì¬ ì‹œì¦Œ ì „ì ê³¼ ê¸°ë¡ì´ ëª¨ë‘ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); };
        window.resetEverything = () => { if(!confirm("ğŸš¨ ì „ì²´ ë¦¬ì…‹?")) return; matchHistoryData = []; seasonArchives = {}; activeSeason = "ì‹œì¦Œ 1"; rankingsData.forEach(p => { p.wins=0; p.losses=0; p.defenseCount=0; p.elo=1000; p.careerHighElo=1000; }); saveRankings(); location.reload(); };
        
        // [New Function] Reset All Passwords
        window.resetAllPasswords = async () => {
            if (!confirm("âš ï¸ ì •ë§ ëª¨ë“  ì„ ìˆ˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n1. ëª¨ë“  ì„ ìˆ˜ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ëœë¤í•œ 4ìë¦¬ ìˆ«ìë¡œ ë³€ê²½ë©ë‹ˆë‹¤.\n2. ë³€ê²½ëœ ëª…ë‹¨(ì´ë¦„: ë²ˆí˜¸)ì´ ê´€ë¦¬ìì˜ í´ë¦½ë³´ë“œì— ìë™ ë³µì‚¬ë©ë‹ˆë‹¤.\n3. ë‹¨í†¡ë°© ë“±ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return;

            captureState();
            
            let reportList = "ğŸ“¢ [RFC] ë¹„ë°€ë²ˆí˜¸ ì „ì²´ ì´ˆê¸°í™” ëª…ë‹¨\n(ê°œì¸ ì •ë³´ì´ë¯€ë¡œ ë³¸ì¸ ê²ƒë§Œ í™•ì¸í•˜ì„¸ìš”)\n\n";
            
            // Use Promise.all to wait for all hashing to complete
            const updatePromises = rankingsData.map(async (p) => {
                const plainPin = Math.floor(1000 + Math.random() * 9000).toString();
                reportList += `${p.name}: ${plainPin}\n`;
                // Store Hashed PIN in DB
                p.password = await hashPin(plainPin);
            });

            await Promise.all(updatePromises);
            
            await saveRankings();
            
            try {
                await navigator.clipboard.writeText(reportList);
                alert("âœ… ì „ì²´ ë¹„ë°€ë²ˆí˜¸ê°€ ì¬ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nëª…ë‹¨ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¨í†¡ë°©ì— 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”.");
            } catch (err) {
                console.error('Clipboard failed', err);
                alert("ì¬ë°œê¸‰ì€ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)");
            }
        };

        // [New Function] Individual Password Reset
        window.resetIndividualPassword = async () => {
            const randomPin = Math.floor(1000 + Math.random() * 9000).toString();
            const pwInput = document.getElementById('editPassword');
            if(pwInput) pwInput.value = randomPin;

            try {
                await navigator.clipboard.writeText(randomPin);
                alert(`âœ… ìƒˆ ë¹„ë°€ë²ˆí˜¸ [${randomPin}] ìƒì„± ì™„ë£Œ!\n\ní´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nê¼­ í•˜ë‹¨ì˜ [ì €ì¥í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.`);
            } catch (err) {
                alert(`ìƒˆ ë¹„ë°€ë²ˆí˜¸: ${randomPin}\n(ë³µì‚¬ ì‹¤íŒ¨, ìˆ˜ë™ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”)\n\nê¼­ [ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.`);
            }
        };

        window.updateRankBaseline = () => { if(confirm("ë³€ë™í­ ë¦¬ì…‹?")) { rankingsData.forEach((p, i) => p.previousRank = i + 1); saveRankings(); renderRankings(); } };
        window.applyManualPenalty = () => { const idx = document.getElementById('penaltyTargetSelect').value; if (idx === "") return alert("ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); const p = rankingsData[idx]; if (!confirm(`[${p.name}] ì„ ìˆ˜ì—ê²Œ íŒ¨ë„í‹°(-30ì )ë¥¼ ë¶€ì—¬í•©ë‹ˆê¹Œ?\ní˜„ì¬ ì ìˆ˜: ${p.elo}`)) return; captureState(); p.elo -= 30; rankingsData.sort((a, b) => b.elo - a.elo); saveRankings(); renderRankings(); alert(`[${p.name}] -30ì  ì°¨ê° ì™„ë£Œ.\ní˜„ì¬ ì ìˆ˜: ${p.elo}`); };
        function checkSeasonInactive() { const list = document.getElementById('seasonInactiveList'); list.innerHTML = ''; const m = matchHistoryData.filter(m => m.season === activeSeason); const an = new Set(); m.forEach(m => { an.add(m.winner); an.add(m.loser); }); const inact = rankingsData.filter(p => !an.has(p.name)); document.getElementById('seasonInactiveCount').textContent = inact.length + "ëª…"; inact.forEach(p => { list.innerHTML += `<li>${p.name}</li>`; }); }
        window.toggleInactiveList = () => document.getElementById('seasonInactiveList').classList.toggle('hidden');
        
        function renderRankings() { 
            const list = document.getElementById('rankingList'); list.innerHTML = ''; 
            const filteredData = rankingsData.filter(p => p.name.toLowerCase().includes(searchQuery));
            const ranked = filteredData.filter(p => (p.wins + p.losses) > 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
            const unranked = filteredData.filter(p => (p.wins + p.losses) === 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
            
            ranked.forEach((item, index) => { 
                const globalIndex = rankingsData.indexOf(item);
                const diff = (item.previousRank || (index + 1)) - (index + 1); 
                let ch = diff > 0 ? `<span class="rank-up">â–²${diff}</span>` : (diff < 0 ? `<span class="rank-down">â–¼${Math.abs(diff)}</span>` : '<span class="rank-keep">-</span>'); 
                let rankClass = "rank-num-normal";
                if(index === 0) rankClass = "rank-num-1";
                else if(index === 1) rankClass = "rank-num-2";
                else if(index === 2) rankClass = "rank-num-3";
                
                list.innerHTML += `
                    <div class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-white hover:shadow-md">
                        <div class="w-10 text-center mr-2"><span class="${rankClass}">${index+1}</span><div class="text-[10px]">${ch}</div></div>
                        <div class="shrink-0 relative mr-3">
                            <img src="${item.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100" onerror="this.src='https://placehold.co/150?text=No+Img'">
                            ${index === 0 ? `<div class="absolute -top-1 -right-1 text-sm">ğŸ‘‘</div>` : ''}
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="font-bold text-sm text-slate-800 flex items-center gap-1">
                                <span class="truncate">${item.name}</span>
                            </div>
                            <div class="flex items-center gap-1.5 mt-0.5">
                                <span class="bg-amber-100 text-amber-800 text-[10px] px-1.5 py-0.5 rounded border border-amber-200 font-bold">âš¡${item.elo}</span>
                                <span class="text-xs text-slate-400">| ${item.wins}ìŠ¹ ${item.losses}íŒ¨</span>
                            </div>
                        </div>
                        <button onclick="openEditModal(${globalIndex})" class="p-2 text-slate-300 hover:text-blue-600 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                    </div>`; 
            }); 
            if(unranked.length > 0) {
                list.innerHTML += `<div class="text-center text-xs text-slate-300 font-bold my-4">- Unranked / Search Results -</div>`;
                unranked.forEach((item) => {
                    const globalIndex = rankingsData.indexOf(item);
                    list.innerHTML += `
                        <div class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-slate-50 opacity-80 hover:opacity-100">
                            <div class="w-10 text-center mr-2"><span class="rank-unranked">-</span></div>
                            <div class="shrink-0 relative mr-3">
                                <img src="${item.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100 grayscale" onerror="this.src='https://placehold.co/150?text=No+Img'">
                            </div>
                            <div class="flex-grow min-w-0">
                                <div class="font-bold text-sm text-slate-500 flex items-center gap-1">
                                    <span class="truncate">${item.name}</span>
                                </div>
                                <div class="flex items-center gap-1.5 mt-0.5">
                                    <span class="bg-slate-100 text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-slate-200 font-bold">New</span>
                                    <span class="text-xs text-slate-400">| 0ìŠ¹ 0íŒ¨</span>
                                </div>
                            </div>
                            <button onclick="openEditModal(${globalIndex})" class="p-2 text-slate-300 hover:text-blue-600 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                            </button>
                        </div>`;
                });
            }
            populateMatchSelectors(); 
        }

        window.populateMatchSelectors = () => { const s1 = document.getElementById('p1Select'); const s2 = document.getElementById('p2Select'); const sPen = document.getElementById('penaltyTargetSelect'); let opts = '<option value="">ì„ ìˆ˜ ì„ íƒ</option>'; rankingsData.forEach((p, i) => opts += `<option value="${i}">${p.name} (${p.elo})</option>`); s1.innerHTML = opts; s2.innerHTML = opts; if(sPen) sPen.innerHTML = opts; };
        
        window.savePlayerDetails = async () => { 
            const idInput = document.getElementById('editPlayerId'); if(!idInput) return;
            captureState();
            const idx = idInput.value; const p = rankingsData[idx]; 
            const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '';

            const newName = getVal('editName');
            const oldName = p.name;
            if (oldName !== newName) {
                if(confirm(`ì´ë¦„ì„ [${oldName}] -> [${newName}] (ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  ê³¼ê±° ê²½ê¸° ê¸°ë¡ì˜ ì´ë¦„ë„ í•¨ê»˜ ë³€ê²½ë©ë‹ˆë‹¤.`)) {
                    matchHistoryData.forEach(m => {
                        if (m.winner === oldName) m.winner = newName;
                        if (m.loser === oldName) m.loser = newName;
                        if (m.blue === oldName) m.blue = newName;
                    });
                } else { return; }
            }

            p.name = newName; 
            p.defenseCount = 0; p.gameId = getVal('editGameId'); 
            
            // [Security] Hash password if it's new
            const inputPw = getVal('editPassword');
            if (inputPw && inputPw !== p.password) {
                if (inputPw.length <= 8) { 
                    p.password = await hashPin(inputPw);
                } else {
                    p.password = inputPw; 
                }
            }

            p.height = getVal('editHeight'); p.reach = getVal('editReach'); p.stance = getVal('editStance'); 
            p.trunkColor = getVal('editTrunkColor'); // Save Trunk Color
            
            p.elo = parseInt(getVal('editElo'))||1000; if(p.elo > (p.careerHighElo || 0)) p.careerHighElo = p.elo; p.wins = parseInt(getVal('editWins'))||0; p.losses = parseInt(getVal('editLosses'))||0; p.imageUrl = getVal('editImageUrlInput').trim(); const ct = document.querySelectorAll('.style-checkbox:checked'); p.tags = Array.from(ct).map(cb => cb.value); 
            
            rankingsData.sort((a, b) => b.elo - a.elo); await saveRankings(); document.getElementById('editModal').classList.add('hidden'); renderRankings(); 
        };

        window.addNewPlayer = async () => { 
            const name = prompt("ì´ë¦„:"); 
            if(name) { 
                const randomPin = Math.floor(1000 + Math.random() * 9000).toString(); 
                const hashedPin = await hashPin(randomPin); // [Security] Hash immediately
                captureState(); 
                
                // [KST Patch] ê°€ì…ì¼ë„ í•œêµ­ ì‹œê°„ìœ¼ë¡œ
                const today = getKSTDate();

                rankingsData.push({ id: crypto.randomUUID(), name, wins:0, losses:0, defenseCount:0, previousRank: rankingsData.length+1, careerHighRank: rankingsData.length+1, elo: 1000, careerHighElo: 1000, lastMatchDate: today, password: hashedPin, trunkColor: '#1f2937' }); 
                saveRankings(); renderRankings(); 
                alert(`âœ… [${name}] ì„ ìˆ˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: ${randomPin}\n(ì €ì¥ì€ ì•”í˜¸í™”ë˜ì–´ ë©ë‹ˆë‹¤)\n\nì„ ìˆ˜ì—ê²Œ ì´ ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`); 
            } 
        };
        
        window.openEditModal = (idx) => { 
            const p = rankingsData[idx]; 
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
            setVal('editPlayerId', idx); setVal('editName', p.name); setVal('editOriginalName', p.name); setVal('editDefenses', 0); setVal('editGameId', p.gameId || ''); 
            setVal('editPassword', p.password || ''); 
            setVal('editHeight', p.height || ''); setVal('editReach', p.reach || ''); setVal('editStance', p.stance || 'Orthodox'); setVal('editElo', p.elo || 1000); setVal('editWins', p.wins || 0); setVal('editLosses', p.losses || 0);
            
            // Trunk Color Init
            const tc = p.trunkColor || '#1f2937';
            setVal('editTrunkColor', tc);
            
            // Highlight Preset
            document.querySelectorAll('.color-preset').forEach(el => {
                if(el.style.backgroundColor === tc || (tc.toUpperCase() === el.style.backgroundColor.toUpperCase())) { // Basic check
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            const urlInput = document.getElementById('editImageUrlInput'); urlInput.value = p.imageUrl || ''; document.getElementById('previewImage').src = p.imageUrl || 'https://placehold.co/150?text=No+Img';
            const c = document.getElementById('styleTagsContainer'); c.innerHTML = ''; const cT = p.tags || [];
            STYLE_OPTIONS.forEach(s => { const safeId = `style-${s.replace(/\s+/g, '-')}`; const isChecked = cT.includes(s) ? 'checked' : ''; c.innerHTML += `<div><input type="checkbox" id="${safeId}" value="${s}" class="style-checkbox absolute opacity-0 w-0 h-0" ${isChecked}><label for="${safeId}" class="inline-block px-3 py-1 text-xs font-bold border border-slate-300 rounded-full cursor-pointer text-slate-500 hover:bg-slate-100 transition select-none ${isChecked?'bg-blue-500 text-white border-blue-500':''}">${s}</label></div>`; }); 
            const modal = document.getElementById('editModal'); if(modal) modal.classList.remove('hidden');
        };

        window.updatePreview = (url) => { document.getElementById('previewImage').src = url || 'https://placehold.co/150?text=No+Img'; };
        window.removeImage = () => { document.getElementById('editImageUrlInput').value = ''; document.getElementById('previewImage').src = 'https://placehold.co/150?text=No+Img'; };
        
        window.deletePlayer = async () => {
            if(!confirm("âš ï¸ ê²½ê³ : ì •ë§ ì´ ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;
            captureState();
            const idx = document.getElementById('editPlayerId').value;
            if(idx === undefined || idx === null || idx === "") return;
            rankingsData.splice(idx, 1); await saveRankings(); 
            document.getElementById('editModal').classList.add('hidden'); renderRankings(); alert("ì„ ìˆ˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        };
        
        window.backupData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ rankings: rankingsData, history: matchHistoryData, archives: seasonArchives, activeSeason: activeSeason }, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `RFC_BACKUP_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(dl); dl.click(); dl.remove(); };
    </script>
</body>
</html>
