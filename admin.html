<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë§¤ë‹ˆì €</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .rank-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; border-bottom: 1px solid #f1f5f9; }
        .rank-card:last-child { border-bottom: none; }
        
        .rank-up { color: #dc2626; font-weight: 800; }   /* Red-600 */
        .rank-down { color: #2563eb; font-weight: 800; } /* Blue-600 */
        .rank-keep { color: #9ca3af; }
        
        .tier-bronze, .tier-silver, .tier-gold, .tier-platinum { background: #ffffff; border-left: none; }

        .rank-1-glow {
            background: linear-gradient(90deg, #ffffff 30%, #fffbeb 100%) !important;
            box-shadow: 0 10px 25px -5px rgba(234, 179, 8, 0.3), 0 8px 10px -6px rgba(234, 179, 8, 0.2) !important;
            border: 1px solid #fef08a !important;
            border-left: 5px solid #f59e0b !important;
            z-index: 20 !important;
        }
        .rank-2-glow {
            background: linear-gradient(120deg, #ffffff 0%, #f8fafc 40%, #e2e8f0 100%) !important;
            box-shadow: 0 10px 25px -5px rgba(148, 163, 184, 0.3), 0 8px 10px -6px rgba(148, 163, 184, 0.1) !important;
            border: 1px solid #cbd5e1 !important;
            border-left: 5px solid #94a3b8 !important;
            z-index: 9 !important;
        }
        .rank-3-glow {
            background: linear-gradient(90deg, #ffffff 30%, #fff7ed 100%) !important;
            box-shadow: 0 10px 25px -5px rgba(173, 138, 86, 0.15), 0 8px 10px -6px rgba(173, 138, 86, 0.1) !important;
            border: 1px solid #ffedd5 !important;
            border-left: 5px solid #ad8a56 !important;
            z-index: 8 !important;
        }

        .v-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            font-size: 9px;
            font-weight: 900;
            border-radius: 4px;
            margin-left: 4px;
            vertical-align: middle;
            line-height: 1;
            cursor: help;
        }
        .v-gold { 
            background: linear-gradient(135deg, #fbbf24, #d97706); 
            color: white; 
            text-shadow: 0 1px 1px rgba(0,0,0,0.1); 
            border: 1px solid #f59e0b; 
        }

        .bounty-pill-dark {
            font-size: 13px;
            background-color: #1f2937;
            color: #fbbf24;
            padding: 1px 5px;
            border-radius: 4px;
            margin-left: 3px;
            font-weight: 800;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
            gap: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .rank-num-1 { color: #f59e0b; font-size: 1.5rem !important; font-weight: 900; font-style: italic; letter-spacing: -1px; text-shadow: 0 1px 2px rgba(245, 158, 11, 0.2); }
        .rank-num-2 { color: #64748b; font-size: 1.3rem !important; font-weight: 800; font-style: italic; letter-spacing: -1px; text-shadow: 0 1px 2px rgba(148, 163, 184, 0.2); }
        .rank-num-3 { color: #ad8a56; font-size: 1.2rem !important; font-weight: 800; font-style: italic; letter-spacing: -1px; }
        .rank-num-top10 { color: #047857; font-size: 1.1rem; font-weight: 800; } 
        .rank-num-normal { color: #94a3b8; font-size: 1.0rem; font-weight: 700; }
        .rank-unranked { color: #cbd5e1; font-size: 1.0rem; font-weight: 700; }
        
        .style-checkbox:checked + label { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        .boxrec-win { background: linear-gradient(180deg, #16a34a 0%, #15803d 100%); }
        .boxrec-loss { background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%); }

        .tab-btn { @apply text-slate-500 border-b-2 border-transparent hover:text-slate-700 font-medium transition-colors; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 font-bold; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-enter { animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .color-preset { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .color-preset:hover { transform: scale(1.1); }
        .color-preset.active { border-color: #3b82f6; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3b82f6; }
        .color-preset.active::after { content: 'âœ”'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .ts-control { border-radius: 0.5rem !important; border-color: #e2e8f0 !important; padding: 0.6rem 0.75rem !important; box-shadow: none !important; font-size: 0.875rem !important; background-color: #fff !important; display: flex !important; align-items: center !important; flex-wrap: nowrap !important; overflow: hidden !important; }
        .ts-control.focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important; }
        .ts-control .item { white-space: nowrap !important; overflow: hidden !important; text-overflow: clip !important; max-width: 100% !important; padding-right: 2px !important; }
        .ts-wrapper.has-items .ts-control > input { width: 1px !important; flex: 0 0 1px !important; min-width: 0 !important; opacity: 0; }
        .ts-wrapper:not(.has-items) .ts-control > input { width: 100% !important; }
        .ts-dropdown { border-radius: 0.5rem !important; border-color: #e2e8f0 !important; margin-top: 4px !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important; overflow: hidden !important; z-index: 50 !important; width: max-content !important; min-width: 100% !important; }
        .ts-dropdown .ts-dropdown-content { max-height: 500px !important; }
        .ts-dropdown .option { padding: 0.5rem 0.75rem !important; font-size: 0.875rem !important; white-space: nowrap !important; }
        .ts-dropdown .active { background-color: #eff6ff !important; color: #1e40af !important; }

        @keyframes slowFade {
            0% { transform: scale(1); background-color: #ffffff; z-index: 1; }
            0.5% { transform: scale(1.03); background-color: #93c5fd !important; box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); z-index: 50; border-color: #2563eb; }
            5% { transform: scale(1.01); background-color: #bfdbfe !important; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); z-index: 50; border-color: #60a5fa; }
            100% { transform: scale(1); background-color: #ffffff !important; z-index: 1; border-color: #e2e8f0; }
        }
        .highlight-slow { animation: slowFade 60s cubic-bezier(0.22, 1, 0.36, 1) forwards !important; }

        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cline x1='18' y1='6' x2='6' y2='18'%3e%3c/line%3e%3cline x1='6' y1='6' x2='18' y2='18'%3e%3c/line%3e%3c/svg%3e") no-repeat center center;
            cursor: pointer;
            margin-left: 8px;
        }

        .red-theme .ts-dropdown .active { background-color: #fee2e2 !important; color: #b91c1c !important; }

        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.3s ease-out; opacity: 0; }
        .accordion-content.open { max-height: 250px; opacity: 1; }

        /* [INSPECTOR] Z-Index Fix */
        #inspector-tooltip {
            position: fixed; pointer-events: none; 
            z-index: 2147483647 !important; 
            background: rgba(15, 23, 42, 0.95); color: white;
            padding: 8px 12px; border-radius: 8px;
            font-size: 11px; font-family: monospace;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            border: 1px solid #334155;
            transition: opacity 0.1s;
            display: none;
        }
        .tooltip-row { display: flex; justify-content: space-between; gap: 12px; margin-bottom: 2px; }
        .tooltip-label { color: #94a3b8; }
        .tooltip-value { color: #60a5fa; font-weight: bold; }
    </style>
</head>
<body class="text-slate-800 relative min-h-screen">

    <div id="inspector-tooltip">
        <div class="tooltip-row"><span class="tooltip-label">Tag</span><span class="tooltip-value" id="tt-tag">DIV</span></div>
        <div class="tooltip-row"><span class="tooltip-label">Font</span><span class="tooltip-value" id="tt-font">16px</span></div>
        <div class="tooltip-row"><span class="tooltip-label">Color</span><span class="tooltip-value" id="tt-color">#000</span></div>
        <div class="tooltip-row"><span class="tooltip-label">Class</span><span class="tooltip-value" id="tt-class" style="max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">-</span></div>
    </div>

    <div id="customAlertModal" class="fixed inset-0 bg-slate-900/80 z-[10001] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeAlertModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 mb-4"><svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div><h3 class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3><p id="alertMessage" class="text-sm text-slate-600 mb-6 whitespace-pre-wrap leading-relaxed">ë‚´ìš©</p><button onclick="closeAlertModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg transition">í™•ì¸</button></div></div>
    </div>

    <div id="customConfirmModal" class="fixed inset-0 bg-slate-900/80 z-[10000] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeConfirmModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100"><div class="text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div><h3 class="text-lg font-bold text-slate-800 mb-2">âš ï¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3><p id="confirmMessage" class="text-sm text-slate-600 mb-6 whitespace-pre-wrap">ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p><div class="flex justify-center gap-3"><button onclick="closeConfirmModal()" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-5 py-2.5 rounded-xl text-sm font-bold transition">ì·¨ì†Œ</button><button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-red-500/30 transition">í™•ì¸ (ì‹¤í–‰)</button></div></div></div>
    </div>

    <button id="undoBtn" onclick="executeUndo()" class="fixed bottom-6 right-6 z-50 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl font-bold flex items-center gap-2 transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed hidden"><span class="text-lg">â†©ï¸</span> ì‹¤í–‰ ì·¨ì†Œ (<span id="undoCount">0</span>)</button>

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-slate-200">
            <div class="text-4xl mb-2">ğŸ¥Š</div><h2 class="text-2xl font-black text-slate-800 mb-6">RFC Admin Security</h2>
            <div id="loginFormContainer"><input type="email" id="adminEmail" placeholder="admin@rfc.com" class="w-full p-3 border border-slate-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition"><input type="password" id="adminPw" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition"><button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg transition transform active:scale-95 shadow-lg shadow-blue-500/30">ì‹œìŠ¤í…œ ì ‘ì†</button></div>
            <div id="autoLoginMsg" class="hidden mt-4 text-emerald-600 font-bold text-sm animate-pulse">âš¡ ê°œë°œì ìë™ ë¡œê·¸ì¸ ì¤‘...</div>
        </div>
    </div>

    <div id="mainContent" class="max-w-6xl mx-auto p-4 hidden min-h-screen flex flex-col">
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center gap-3"><h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">RFC ë§¤ë‹ˆì €</h1><span id="currentSeasonBadge" class="bg-slate-800 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">Loading...</span><span id="saveStatus" class="text-xs font-medium text-emerald-500 transition-opacity opacity-0">âœ… ì €ì¥ë¨ (Secure)</span></div>
            <div class="mt-2 md:mt-0 text-xs text-slate-400 font-medium"><span id="adminVersionDisplay">v?.??</span></div>
        </header>

        <div class="bg-white rounded-t-2xl border-b border-slate-200 px-4 flex gap-6 mb-4 shadow-sm overflow-x-auto">
            <button onclick="switchTab('main')" id="tabMain" class="tab-btn active py-4 whitespace-nowrap">ğŸ”¥ ë­í‚¹/ê²½ê¸°</button>
            <button onclick="switchTab('history')" id="tabHistory" class="tab-btn py-4 whitespace-nowrap">âš”ï¸ ê²½ê¸° ê¸°ë¡</button>
            <button onclick="switchTab('season')" id="tabSeason" class="tab-btn py-4 whitespace-nowrap">ğŸ“… ì‹œì¦Œ ê´€ë¦¬</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn py-4 whitespace-nowrap">ğŸ› ï¸ ë°ì´í„°/ë°±ì—…</button>
            <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn py-4 whitespace-nowrap">âš™ï¸ ì„¤ì •/ë©”ëª¨</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <div class="lg:col-span-4 space-y-6">
                <div id="mainSection" class="tab-content">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 mb-6 relative z-30">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                            <h3 class="font-bold text-slate-700">âš”ï¸ ê²½ê¸° ê²°ê³¼ ì…ë ¥</h3>
                            <button onclick="resetMatchInputs()" class="text-xs bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 px-2.5 py-1.5 rounded-lg font-bold transition flex items-center gap-1 shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg> ì´ˆê¸°í™”</button>
                        </div>
                        <div class="p-5">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 pl-1">ğŸ“… ê²½ê¸° ë‚ ì§œ</label>
                                    <div class="flex gap-2"><input type="date" id="matchDateInput" class="flex-grow border border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 bg-white"><button onclick="setMatchDate('yesterday')" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">ì–´ì œ</button><button onclick="setMatchDate('today')" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">ì˜¤ëŠ˜</button></div>
                                </div>
                                <div class="flex items-center justify-end mb-2 px-1">
    <label class="inline-flex items-center cursor-pointer relative group">
        <input type="checkbox" id="isTitleMatch" class="sr-only peer">
        <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-yellow-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
        <span class="ml-2 text-xs font-bold text-slate-600 group-hover:text-yellow-600 transition">ğŸ‘‘ íƒ€ì´í‹€ ë§¤ì¹˜</span>
    </label>
</div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div><label class="block text-xs font-bold text-blue-600 mb-1 pl-1">ğŸ”µ Blue (ê²€ìƒ‰ê°€ëŠ¥)</label><div class="flex items-center gap-2"><div class="flex-grow min-w-0"><select id="p1Select" class="w-full text-sm outline-none" placeholder="ì„ ìˆ˜ ê²€ìƒ‰..."></select></div><div id="p1TrunkIndicator" class="w-3 h-6 rounded border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="ë°”ì§€ ìƒ‰ìƒ"></div></div></div>
                                    <div><label class="block text-xs font-bold text-red-600 mb-1 pl-1">ğŸ”´ Red (ê²€ìƒ‰ê°€ëŠ¥)</label><div class="flex items-center gap-2"><div class="flex-grow min-w-0"><select id="p2Select" class="w-full text-sm outline-none" placeholder="ì„ ìˆ˜ ê²€ìƒ‰..."></select></div><div id="p2TrunkIndicator" class="w-3 h-6 rounded border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="ë°”ì§€ ìƒ‰ìƒ"></div></div></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-200">
                                    <label class="cursor-pointer flex items-center justify-center gap-2 p-2.5 rounded-lg hover:bg-blue-50 transition border border-transparent has-[:checked]:bg-blue-100 has-[:checked]:border-blue-300 has-[:checked]:shadow-sm"><input type="radio" name="winner" value="blue" class="w-4 h-4 accent-blue-600" onchange="updateMatchPreview()"><span class="text-xs font-bold text-blue-700">Blue ìŠ¹</span></label>
                                    <label class="cursor-pointer flex items-center justify-center gap-2 p-2.5 rounded-lg hover:bg-red-50 transition border border-transparent has-[:checked]:bg-red-100 has-[:checked]:border-red-300 has-[:checked]:shadow-sm"><input type="radio" name="winner" value="red" class="w-4 h-4 accent-red-600" onchange="updateMatchPreview()"><span class="text-xs font-bold text-red-700">Red ìŠ¹</span></label>
                                </div>
                                <div id="matchPreview" class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 border border-gray-200 hidden"><div id="previewContent" class="space-y-1"></div></div>
                                <button onclick="applyMatch()" class="w-full bg-gradient-to-r from-slate-800 to-slate-900 hover:from-black text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">ê²½ê¸° í™•ì •</button>
                                <button onclick="updateRankBaseline()" class="w-full bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold py-3 rounded-xl text-xs transition border border-slate-200">ğŸ“‰ ìˆœìœ„ ë³€ë™(â–²â–¼) ë¦¬ì…‹</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">ğŸ‘¤ ì„ ìˆ˜ ê´€ë¦¬ ë„êµ¬ <span id="totalPlayerCount" class="font-normal ml-1">(0ëª…)</span></h3>
                        <div class="flex gap-2 mb-3"><button onclick="openNewPlayerModal()" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-3 rounded-xl border border-emerald-100 transition">+ ì„ ìˆ˜ ë“±ë¡</button><button onclick="openDeletePlayersModal()" class="flex-1 bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-xl border border-red-100 transition flex items-center justify-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg> ì„ ìˆ˜ ì‚­ì œ</button></div>
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-3"><div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-orange-700">ğŸ’€ íŒ¨ë„í‹° ë¶€ì—¬ (-30ì )</h4></div><div class="flex gap-2"><div class="flex-grow min-w-0"><select id="penaltyTargetSelect" class="w-full text-xs outline-none" placeholder="ëŒ€ìƒ ì„ íƒ..."></select></div><button onclick="applyManualPenalty()" class="bg-white text-orange-700 font-bold px-3 py-2 rounded-lg text-xs border border-orange-200 transition hover:bg-orange-100 whitespace-nowrap">ì‹¤í–‰</button></div></div>
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-3"><h4 class="text-xs font-bold text-slate-700 mb-2 flex items-center gap-1"><span>ğŸ’¤</span> ì¥ê¸° ë¯¸ì°¸ì—¬ì ê´€ë¦¬</h4><div class="flex gap-2 items-center mb-2"><div class="flex items-center gap-1"><input type="number" id="inactiveDaysInput" value="30" class="w-14 border border-slate-300 p-1.5 rounded text-xs text-center font-bold outline-none focus:border-blue-500" min="1"><span class="text-[11px] text-slate-500 font-bold">ì¼</span></div><span class="text-slate-300">|</span><div class="flex items-center gap-1"><span class="text-red-500 font-bold text-xs">-</span><input type="number" id="penaltyScoreInput" value="30" class="w-14 border border-red-200 bg-white p-1.5 rounded text-xs text-center font-bold text-red-600 outline-none focus:border-red-500" min="1"><span class="text-[11px] text-slate-500 font-bold">ì </span></div><div class="flex-grow"></div><button onclick="checkBatchInactiveUsers()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">ì¡°íšŒ</button><button onclick="resetBatchInactiveForm()" class="bg-white border border-slate-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100 font-bold px-2 py-1.5 rounded-lg text-xs transition shadow-sm" title="ì´ˆê¸°í™”">ğŸ”„</button></div><div id="inactiveListArea" class="hidden mt-3 pt-3 border-t border-slate-200"><p class="text-[10px] text-slate-400 mb-2 font-bold">ê²€ìƒ‰ëœ ëŒ€ìƒì (<span id="inactiveCountDisplay">0</span>ëª…)</p><ul id="inactiveUserList" class="max-h-32 overflow-y-auto bg-white border border-slate-200 rounded-lg p-2 text-[11px] text-slate-600 space-y-1 mb-3 shadow-inner"></ul><button id="btnApplyBatchPenalty" class="w-full bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 font-bold py-2.5 rounded-lg text-xs transition shadow-sm flex justify-center items-center gap-1"><span>ğŸ’€</span> íŒ¨ë„í‹° ì ìš©í•˜ê¸°</button></div></div>
                    </div>
                </div>

                <div id="historySection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-[calc(100vh-180px)]"><div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center"><h3 class="font-bold text-slate-700">âš”ï¸ ê²½ê¸° ê¸°ë¡ Log</h3><button onclick="openMatchExportModal()" class="bg-white border border-slate-200 text-slate-600 hover:text-blue-600 text-xs font-bold px-3 py-1.5 rounded-lg transition shadow-sm flex items-center gap-1"><span>ğŸ“¤</span> í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸°</button></div><div class="p-3 border-b border-slate-100"><select id="adminHistorySeason" class="w-full text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500"></select></div><div id="adminMatchListContainer" class="flex-grow overflow-y-auto p-3 space-y-3 bg-slate-50/50"><div class="text-center text-xs text-slate-400 py-10">ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div></div>
                </div>

                <div id="seasonSection" class="tab-content hidden">
                    <div class="space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><h3 class="font-bold text-slate-700 mb-3 border-b pb-2">ğŸ“… ì‹œì¦Œ ëª©ë¡</h3><div id="seasonListContainer" class="space-y-2 max-h-60 overflow-y-auto mb-2"></div><p class="text-[10px] text-slate-400 mt-2">* ëª©ë¡ì—ì„œ ì‚­ì œí•˜ë©´ ì‚¬ìš©ì í™”ë©´ì—ì„œë„ ì¦‰ì‹œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p></div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700">ğŸ˜´ ë¯¸ì°¸ì—¬ ì„ ìˆ˜</h3><span id="seasonInactiveCount" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">0ëª…</span></div><div class="text-xs text-slate-500 mb-3">í˜„ì¬ ì‹œì¦Œ(<span class="currentSeasonName font-bold"></span>) ê²½ê¸° ê¸°ë¡ ì—†ìŒ</div><button onclick="toggleInactiveList()" class="text-xs text-blue-500 font-bold underline mb-2">ëª©ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button><ul id="seasonInactiveList" class="hidden bg-slate-50 p-2 rounded text-xs text-slate-600 space-y-1 mb-3 max-h-40 overflow-y-auto border border-slate-200"></ul></div>
                        <div class="bg-purple-50 rounded-2xl shadow-sm border border-purple-100 overflow-hidden p-5"><h3 class="font-bold text-purple-800 mb-2">ğŸš€ ì‹œì¦Œ ì¢…ë£Œ ë° ì‹œì‘</h3><p class="text-xs text-purple-600 mb-4">í˜„ì¬ ì‹œì¦Œì„ ë§ˆê°í•˜ê³  ìƒˆ ì‹œì¦Œì„ ì‹œì‘í•©ë‹ˆë‹¤.</p><div class="flex gap-2"><input type="text" id="newSeasonNameInput" class="flex-grow border border-purple-200 rounded-lg p-2 text-sm focus:outline-none focus:border-purple-400" placeholder="ìƒˆ ì‹œì¦Œ ì´ë¦„"><button onclick="finishAndStartNewSeason()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg text-xs shadow transition whitespace-nowrap">ì‹œì¦Œ ì‹œì‘</button></div></div>
                    </div>
                </div>

                <div id="toolsSection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 space-y-4">
                        <h3 class="font-bold text-slate-700">ğŸ› ï¸ ë°ì´í„° ë„êµ¬</h3>
                        <div class="grid grid-cols-2 gap-2"><input type="file" id="importFile" accept=".json" class="hidden"><button onclick="document.getElementById('importFile').click()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg text-xs">ğŸ“‚ ë°ì´í„° ë³µì›</button><button onclick="backupData()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg text-xs">ğŸ’¾ ë°ì´í„° ë°±ì—…</button></div>
                        <div class="pt-4 border-t border-slate-100 space-y-2"><h4 class="text-xs font-bold text-indigo-600">ğŸ”§ ë°ì´í„° ë³´ì •</h4><div class="bg-indigo-50 border border-indigo-100 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-xs font-bold text-indigo-800">ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬ ë° ìˆ˜ì •</span></div><p class="text-[10px] text-indigo-600 mb-2 leading-snug">1. ê³¼ë„í•œ ìˆœìœ„ ë³€ë™í­(ì˜ˆ: +34) ì´ˆê¸°í™”<br>2. 3ì „ ì„ ìˆ˜ë“¤ì˜ ëˆ„ë½ëœ 'ì§„ì… ë‚ ì§œ' ë³µêµ¬<br><span class="text-emerald-600">3. ë² í…Œë‘ ë‹¬ì„± ì‹œ í˜„ìƒê¸ˆ ìë™ ë¶€ì—¬ (10ì )</span></p><button onclick="fixDataIntegrity()" class="w-full bg-white text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs border border-indigo-200 shadow-sm transition">âœ¨ ë°ì´í„° ì§„ë‹¨ ë° ë³µêµ¬ ì‹¤í–‰</button></div></div>
                        <div class="pt-4 border-t border-slate-100 space-y-2"><h4 class="text-xs font-bold text-blue-600">ğŸ‘¥ ì„ ìˆ˜ ëª…ë‹¨ ì¶”ì¶œ</h4><div class="grid grid-cols-1 gap-2"><button onclick="copyRankerList()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-3 rounded-lg text-xs border border-blue-100">ğŸ† ë­ì»¤ ëª…ë‹¨</button><button onclick="copyAllPlayerList()" class="bg-slate-50 text-slate-600 hover:bg-slate-100 font-bold py-3 rounded-lg text-xs border border-slate-200">ğŸ“‹ ì „ì²´ ì„ ìˆ˜ ëª…ë‹¨</button></div></div>
                        <div class="pt-4 border-t border-slate-100 space-y-2"><h4 class="text-xs font-bold text-red-500">ì´ˆê¸°í™” (ì£¼ì˜)</h4><button onclick="resetAllStats()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">ğŸ“Š í˜„ì¬ ì‹œì¦Œ ì „ì  ì´ˆê¸°í™”</button><button onclick="resetAllElo()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">âš¡ í˜„ì¬ ì‹œì¦Œ ELO ì´ˆê¸°í™”</button><button onclick="resetAllPasswords()" class="w-full bg-orange-50 text-orange-600 hover:bg-orange-100 font-bold py-3 rounded-lg text-xs border border-orange-200 mt-2">ğŸ”‘ ì „ì²´ ë¹„ë°€ë²ˆí˜¸ ì¬ë°œê¸‰ (ëª…ë‹¨ ë³µì‚¬)</button><button onclick="resetEverything()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-lg text-xs border border-red-200 mt-2">ğŸ§¨ ì‹œìŠ¤í…œ ì „ì²´ ë¦¬ì…‹</button></div>
                    </div>
                </div>

                <div id="settingsSection" class="tab-content hidden">
                    <div class="space-y-6">
                        <!-- Inspector Toggle -->
                        <div class="bg-slate-800 rounded-2xl shadow-sm border border-slate-700 overflow-hidden p-5 text-white">
                            <div class="flex justify-between items-center"><h3 class="font-bold flex items-center gap-2">ğŸ› ï¸ ìŠ¤íƒ€ì¼ ì¸ìŠ¤í™í„° (ê°œë°œì ëª¨ë“œ)</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="inspectorToggle" class="sr-only peer" onchange="toggleInspector()"><div class="w-9 h-5 bg-slate-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-500"></div></label></div>
                            <p class="text-xs text-slate-400 mt-2">í™œì„±í™” ì‹œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ìœ„ì¹˜ì— í•´ë‹¹ ìš”ì†Œì˜ í°íŠ¸, ìƒ‰ìƒ, í¬ê¸° ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-slate-700">ğŸ“¢ ì‚¬ìš©ì ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="noticeActiveToggle" class="sr-only peer" onchange="saveNoticeSettings()"><div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div><span class="ml-2 text-xs font-bold text-slate-600">ê³µì§€ í™œì„±í™”</span></label></div><textarea id="noticeContentInput" class="w-full h-24 p-3 text-xs border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 resize-none mb-3" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea><button onclick="saveNoticeSettings()" class="w-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs border border-indigo-100 transition">ê³µì§€ ì €ì¥í•˜ê¸°</button></div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><h3 class="font-bold text-slate-700 mb-2">ğŸ“œ ê·œì¹™ HTML í¸ì§‘</h3><textarea id="ruleHtmlInput" class="w-full h-48 p-3 text-xs font-mono border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 resize-none mb-3" placeholder="HTML ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea><div class="flex gap-2"><button onclick="loadDefaultRuleHtml()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-2.5 rounded-lg text-xs hover:bg-slate-200 transition">â†º ê¸°ë³¸ ë””ìì¸ ë¶ˆëŸ¬ì˜¤ê¸°</button><button onclick="saveRules()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg text-xs transition">ê·œì¹™ ì €ì¥í•˜ê¸°</button></div></div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 flex flex-col h-[400px]"><h3 class="font-bold text-slate-700 mb-3 flex justify-between">ğŸ“ ê´€ë¦¬ì ë©”ëª¨ì¥</h3><div id="memoListContainer" class="flex-grow overflow-y-auto space-y-2 mb-3 pr-1 bg-slate-50 rounded-lg p-2 border border-slate-100"><div class="text-center text-xs text-gray-400 py-4">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div><div class="flex gap-2"><input type="text" id="newMemoInput" class="flex-grow border border-slate-200 rounded-lg p-2.5 text-sm focus:outline-none focus:border-blue-500" placeholder="ë©”ì„¸ì§€ ë‚¨ê¸°ê¸°..." onkeypress="if(event.key==='Enter') addMemo()"><button onclick="addMemo()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold px-4 rounded-lg text-xs transition whitespace-nowrap">ë“±ë¡</button></div></div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[calc(100vh-140px)]">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                    <div><h3 class="font-bold text-slate-700">ğŸ”¥ ì‹¤ì‹œê°„ ë­í‚¹</h3><p class="text-[10px] text-slate-400 font-medium mt-0.5">í˜„ì¬ í™œì„± ì‹œì¦Œ: <span class="currentSeasonName text-blue-600 font-bold"></span></p></div>
                    <div class="flex items-center gap-2">
                        <div class="relative"><input type="search" id="searchInput" placeholder="ì„ ìˆ˜/ì´ˆì„± ê²€ìƒ‰" class="w-[155px] text-xs border border-slate-200 rounded-lg pl-9 pr-2 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition"><div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs">ğŸ”</div></div>
                        <div class="flex gap-2"><button onclick="window.open('index.html')" class="bg-white border border-slate-200 text-slate-600 text-xs font-bold py-2 px-3 rounded-lg hover:bg-slate-50">ğŸŒ ì‚¬ì´íŠ¸ ë³´ê¸°</button><button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow hover:bg-indigo-700">ğŸ’¾ ì €ì¥</button></div>
                    </div>
                </div>
                <div id="rankingList" class="flex-grow overflow-y-auto p-2 space-y-1.5 bg-slate-50/50"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="deletePlayersModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) closeDeletePlayersModal()">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2"><div class="flex items-center gap-2"><h3 class="text-lg font-bold text-slate-800">ğŸ—‘ï¸ ì„ ìˆ˜ ì‚­ì œ</h3><span id="deleteCountBadge" class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full whitespace-nowrap">0ëª… ì„ íƒë¨</span></div><div class="relative"><input type="search" id="deleteSearchInput" placeholder="ì´ë¦„/ì´ˆì„± ê²€ìƒ‰" class="w-[155px] border p-2 pl-9 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition" oninput="renderDeleteList()"><div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-sm">ğŸ”</div></div></div>
            <div class="flex items-center gap-2 mb-2 px-1"><input type="checkbox" id="deleteAllCheckbox" class="w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" onchange="toggleDeleteSelectAll()"><label for="deleteAllCheckbox" class="text-xs text-slate-500 font-bold cursor-pointer select-none">ì „ì²´ ì„ íƒ</label></div>
            <div id="deletePlayerList" class="flex-grow overflow-y-auto border border-slate-200 rounded-lg p-2 space-y-1 bg-slate-50 min-h-[200px]"></div>
            <div class="mt-3 bg-red-50 p-3 rounded-lg border border-red-100"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="deleteHistoryCheckbox" class="w-4 h-4 text-red-600 rounded border-red-300 focus:ring-red-500"><div class="text-xs text-red-700 font-bold"><span>ê²½ê¸° ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œ</span><p class="text-[10px] font-normal text-red-500 mt-0.5 leading-snug">ì„ íƒ ì‹œ, í•´ë‹¹ ì„ ìˆ˜ê°€ í¬í•¨ëœ ëª¨ë“  ê³¼ê±° ê²½ê¸° ë¡œê·¸ê°€ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤. (ìƒëŒ€ë°©ì˜ ì „ì  íšŸìˆ˜ëŠ” ìœ ì§€ë˜ì§€ë§Œ ë¡œê·¸ëŠ” ì‚¬ë¼ì§)</p></div></label></div>
            <div class="flex justify-end gap-2 mt-4 pt-2 border-t"><button onclick="closeDeletePlayersModal()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button><button onclick="confirmDeletePlayers()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ì‚­ì œí•˜ê¸°</button></div>
        </div>
    </div>

    <div id="newPlayerModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('newPlayerModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm"><h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">ğŸ‘¤ ìƒˆ ì„ ìˆ˜ ë“±ë¡</h3><p class="text-xs text-gray-500 mb-3">ë“±ë¡í•  ì„ ìˆ˜ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p><input type="text" id="newPlayerNameInput" class="w-full border p-3 rounded-lg text-sm mb-4 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="ì„ ìˆ˜ ì´ë¦„" onkeypress="if(event.key==='Enter') confirmNewPlayer()"><div class="flex justify-end gap-2"><button onclick="document.getElementById('newPlayerModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button><button onclick="confirmNewPlayer()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ë“±ë¡í•˜ê¸°</button></div></div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('editModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</h3>
            
            <input type="hidden" id="editPlayerId">
            <input type="hidden" id="editOriginalName">
            
            <div class="flex gap-6 mb-6">
                <div class="relative w-48 h-48 shrink-0 group">
                    <img id="previewImage" src="" class="w-full h-full rounded-2xl object-cover border border-slate-200 bg-slate-50 shadow-sm" onerror="this.src='https://placehold.co/150?text=No+Img'">
                    <button onclick="removeImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 shadow-md hover:bg-red-600 transition opacity-0 group-hover:opacity-100" title="ì´ë¯¸ì§€ ì‚­ì œ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414-1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                
                <div class="flex-grow flex flex-col justify-between py-1">
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1.5 block">í”„ë¡œí•„ ì´ë¯¸ì§€ URL</label>
                        <input type="text" id="editImageUrlInput" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°..." class="w-full border border-slate-300 p-2.5 rounded-lg text-xs bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="updatePreview(this.value)">
                        <p class="text-[10px] text-gray-400 mt-1.5 leading-snug">* ë””ìŠ¤ì½”ë“œ/ì¹´í†¡ ì´ë¯¸ì§€ ìš°í´ë¦­ â†’ <strong>'ì£¼ì†Œ ë³µì‚¬'</strong></p>
                    </div>
                    
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1.5 block">ì‹œì¦Œ ì „ì  & ì ìˆ˜ & í˜„ìƒê¸ˆ (ìˆ˜ë™ ì¡°ì ˆ)</label>
                        <div class="flex gap-2">
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="number" id="editWins" class="w-full border border-emerald-200 bg-emerald-50 p-2.5 rounded-lg text-sm text-center font-bold text-emerald-700 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-emerald-400 font-medium select-none">ìŠ¹</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="number" id="editLosses" class="w-full border border-rose-200 bg-rose-50 p-2.5 rounded-lg text-sm text-center font-bold text-rose-700 focus:outline-none focus:border-rose-500 focus:ring-1 focus:ring-rose-500">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-rose-400 font-medium select-none">íŒ¨</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="number" id="editElo" class="w-full border border-amber-200 bg-amber-50 p-2.5 rounded-lg text-sm text-center font-bold text-amber-700 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                                    <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-amber-400 font-medium select-none">ì </span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="number" id="editBounty" class="w-full border border-orange-200 bg-orange-50 p-2.5 rounded-lg text-sm text-center font-bold text-orange-700 focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500" placeholder="0">
                                    <span class="absolute right-1 top-1/2 -translate-y-1/2 text-[9px] text-orange-400 font-medium select-none">Bounty</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-12 gap-3 mb-3">
                <div class="col-span-4">
                    <label class="text-xs text-gray-500 block mb-1">ì´ë¦„</label>
                    <input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold bg-white focus:outline-none focus:border-blue-500">
                </div>
                <div class="col-span-4">
                    <label class="text-xs text-gray-500 block mb-1">Game ID</label>
                    <input type="text" id="editGameId" class="w-full border p-2 rounded text-sm bg-white focus:outline-none focus:border-blue-500" placeholder="ID ì…ë ¥">
                </div>
                <div class="col-span-4">
                    <label class="text-xs text-gray-500 block mb-1 font-bold text-blue-600">ë¹„ë°€ë²ˆí˜¸</label>
                    <div class="flex gap-1">
                        <input type="text" id="editPassword" class="w-full border p-2 rounded text-sm font-mono font-bold bg-blue-50 text-blue-700 focus:outline-none focus:border-blue-500" placeholder="ë³€ê²½ ì‹œ ì…ë ¥">
                        <button onclick="resetIndividualPassword()" class="bg-slate-200 text-slate-700 px-2 rounded-lg text-xs hover:bg-slate-300 font-bold transition flex items-center justify-center shadow-sm" title="ëœë¤ ì´ˆê¸°í™”">ğŸ”„</button>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">í‚¤ (cm)</label>
                    <input type="text" id="editHeight" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">ë¦¬ì¹˜ (cm)</label>
                    <input type="text" id="editReach" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-blue-500">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">ìŠ¤íƒ ìŠ¤</label>
                    <select id="editStance" class="w-full border p-2 rounded text-sm bg-white focus:outline-none focus:border-blue-500">
                        <option value="Orthodox">Orthodox</option>
                        <option value="Southpaw">Southpaw</option>
                        <option value="Switch">Switch</option>
                    </select>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="text-xs text-gray-500 block mb-2">ë°”ì§€ ìƒ‰ìƒ (10ê°€ì§€ í”„ë¦¬ì…‹)</label>
                <div id="trunkColorPresets" class="flex flex-wrap gap-2"></div>
                <input type="hidden" id="editTrunkColor">
            </div>
            
            <div class="mb-6 p-3 bg-slate-50 rounded border border-slate-200">
                <label class="block text-xs font-bold text-slate-600 mb-2">ğŸ¥Š ìŠ¤íƒ€ì¼ íƒœê·¸</label>
                <div id="styleTagsContainer" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="flex justify-between items-center">
                <button type="button" onclick="tryDeletePlayer()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold transition border border-red-200">ğŸ—‘ï¸ ì„ ìˆ˜ ì‚­ì œ</button>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button>
                    <button onclick="savePlayerDetails()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="renameModal" class="fixed inset-0 bg-slate-900/80 z-[10002] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeRenameModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100"><h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">âœï¸ ì‹œì¦Œ ì´ë¦„ ë³€ê²½</h3><input type="hidden" id="renameOldName"><input type="text" id="renameInput" class="w-full border p-3 rounded-lg text-sm mb-6 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" placeholder="ìƒˆ ì‹œì¦Œ ì´ë¦„" onkeypress="if(event.key==='Enter') confirmRenameSeason()"><div class="flex justify-end gap-2"><button onclick="closeRenameModal()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button><button onclick="confirmRenameSeason()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ë³€ê²½</button></div></div>
    </div>

    <div id="exportModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('exportModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
            <h3 id="exportModalTitle" class="text-lg font-bold text-slate-800 mb-2 border-b pb-2">ğŸ“¤ í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸° / ìˆ˜ì •</h3>
            <p class="text-[11px] text-slate-500 mb-3">í…ìŠ¤íŠ¸ë¥¼ ììœ ë¡­ê²Œ ìˆ˜ì • í›„ ë³µì‚¬í•˜ê±°ë‚˜, <strong>[ì´ë¦„ ID]</strong> í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ ì¼ê´„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <div id="exportMatchOptions" class="flex gap-2 mb-3 hidden"></div>
            <textarea id="exportTextarea" class="w-full h-64 p-3 text-xs font-mono border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white resize-none mb-4" placeholder="ìƒë‹¨ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê¸°ë¡ì„ ìƒì„±í•˜ì„¸ìš”..."></textarea>
            <div class="flex justify-between items-center gap-2"><button onclick="document.getElementById('exportModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ë‹«ê¸°</button><div class="flex gap-2"><button onclick="applyBatchIdUpdate()" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-1"><span>ğŸ’¾</span> ID ì¼ê´„ ì ìš©</button><button onclick="copyExportText()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1"><span>ğŸ“‹</span> ë³µì‚¬</button></div></div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-[10000] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeProfile()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] max-w-3xl mx-auto h-[92vh] overflow-y-auto modal-enter flex flex-col">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center cursor-pointer border-b border-slate-100" onclick="closeProfile()"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-5 pb-8 relative mt-2">
                <div class="absolute top-0 right-4 flex gap-3 z-20">
                    <button id="profileEditBtn" class="text-blue-600 hover:text-blue-800 p-2 text-sm font-bold flex items-center gap-1 bg-blue-50 rounded-lg px-3 py-2 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> ì •ë³´ ìˆ˜ì •</button>
                    <button onclick="closeProfile()" class="text-slate-400 hover:text-slate-600 p-2 text-2xl font-bold">âœ•</button>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-center mb-4"><h2 class="text-3xl font-black text-slate-800 flex items-center justify-center gap-2 tracking-tight"><span id="pModalCrown" class="text-2xl hidden">ğŸ‘‘</span><span id="pModalName">Name</span></h2><div class="flex items-center justify-center gap-2 mt-1"><span id="pModalGameId" class="text-xs text-slate-500 font-bold bg-slate-100 px-2 py-0.5 rounded">ID: -</span><span id="pModalTierBadge" class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-400">Tier</span></div></div>
                    <div class="mb-5 relative"><img id="pModalImg" src="" class="w-48 h-48 rounded-2xl object-cover border-4 border-white shadow-xl bg-slate-50" onerror="this.src='https://placehold.co/150?text=No+Img'"></div>
                    <div class="w-full max-w-sm mb-6">
                        <div class="flex justify-end mb-2"><select id="pModalSeason" class="text-xs font-bold text-slate-600 bg-slate-100 border border-slate-200 rounded px-2 py-1 outline-none focus:border-blue-500"><option value="all">ì „ì²´ ê¸°ë¡ (All Time)</option><option value="current">í˜„ì¬ ì‹œì¦Œ (Current)</option></select></div>
                        <div class="flex w-full rounded-lg overflow-hidden shadow-md"><div class="flex-1 boxrec-win text-white p-1.5 text-center border-r border-white/20"><div class="text-3xl font-black leading-none" id="pBigWins">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Wins</div></div><div class="flex-1 boxrec-loss text-white p-1.5 text-center"><div class="text-3xl font-black leading-none" id="pBigLosses">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Losses</div></div></div>
                        <div class="flex bg-slate-50 border border-slate-200 border-t-0 rounded-b-lg divide-x divide-slate-200 text-center py-2 shadow-sm"><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Win Rate</div><div class="text-sm font-black text-slate-700" id="pModalWinRate">0%</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Elo Rating</div><div class="text-sm font-black text-amber-600" id="pModalElo">1000</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Career High</div><div class="text-sm font-black text-slate-700" id="pModalHighElo">1000</div></div></div>
                    </div>
                    <div class="w-full space-y-6"><div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm"><div class="grid grid-cols-3 gap-4 text-center"><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Height</div><div id="pModalHeight" class="font-bold text-slate-700 text-sm">-</div></div><div class="border-x border-slate-100"><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Reach</div><div id="pModalReach" class="font-bold text-slate-700 text-sm">-</div></div><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Stance</div><div id="pModalStance" class="font-bold text-slate-700 text-sm">-</div></div></div><div id="pModalTags" class="flex flex-wrap gap-1.5 justify-center mt-3"></div></div><div><h3 class="text-xs font-bold text-slate-400 uppercase mb-2 pl-1">Bout History</h3><div id="pModalMatchList" class="space-y-2 pb-10"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const AUTO_LOGIN_EMAIL = ""; 
        const AUTO_LOGIN_PW = "";
        
        const ADMIN_CONFIG = {
            version: "v4.72",
            updateNote: "Inspector Z-Index & ê°€ë…ì„± ê°œì„ ",
            title: "RFC ë§¤ë‹ˆì €"
        };

        function initVersionUI() {
            try {
                document.title = `${ADMIN_CONFIG.title} [${ADMIN_CONFIG.version}]`;
                const adminVerEl = document.getElementById('adminVersionDisplay');
                if(adminVerEl) {
                    adminVerEl.innerHTML = `<span class="font-bold text-slate-600">${ADMIN_CONFIG.version}</span> <span class="text-slate-400 font-normal ml-1 text-[11px]">${ADMIN_CONFIG.updateNote}</span>`;
                }
            } catch (e) {
                console.warn("Version UI Update Failed", e);
            }
        }
        initVersionUI();

        const firebaseConfig = { apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk", authDomain: "rfk-ranking.firebaseapp.com", projectId: "rfk-ranking", storageBucket: "rfk-ranking.firebasestorage.app", messagingSenderId: "675366165774", appId: "1:675366165774:web:795d34c56eab630b4dcb5f", measurementId: "G-CXPDZQ8GTL" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = 'ranking-manager-default';
        
        let rankingsData = []; let matchHistoryData = []; let seasonArchives = {}; let activeSeason = "ì‹œì¦Œ 1"; let adminMemos = []; let ruleHtml = "";
        let undoStack = []; const MAX_UNDO = 10;
        let searchQuery = "";
        let enrichedHistory = [];
        let viewHistorySeason = "";
        let currentProfileId = null;
        let p1Tom, p2Tom, pPenTom;
        let activeHighlight = { ids: [], endTime: 0 };
        let deleteSelectedIds = new Set();
        let lastCheckedIndex = null; 
        let batchPenaltyTargets = [];

        // [New] Inspector State & Logic
        let isInspectorActive = false;
        const tooltipEl = document.getElementById('inspector-tooltip');

        window.toggleInspector = () => {
            isInspectorActive = document.getElementById('inspectorToggle').checked;
            if (isInspectorActive) {
                document.body.appendChild(tooltipEl);
                tooltipEl.style.display = 'block'; 
            } else {
                tooltipEl.style.display = 'none';
            }
        };

        function rgbToHex(rgb) {
            if (!rgb) return '';
            if (rgb.startsWith('#')) return rgb;
            const rgbMatch = rgb.match(/\d+/g);
            if (!rgbMatch) return rgb;
            const r = parseInt(rgbMatch[0]);
            const g = parseInt(rgbMatch[1]);
            const b = parseInt(rgbMatch[2]);
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        }

        document.addEventListener('mousemove', (e) => {
            if (!isInspectorActive) return;
            const target = e.target;
            if (target.closest('#inspector-tooltip') || target.closest('#inspectorToggle')) return;

            const styles = window.getComputedStyle(target);
            const tag = target.tagName.toLowerCase();
            const fontSize = styles.fontSize;
            const fontWeight = styles.fontWeight;
            const color = styles.color;
            const hexColor = rgbToHex(color);
            const classes = target.className && typeof target.className === 'string' ? target.className.split(' ').slice(0, 2).join('.') : '';

            tooltipEl.style.display = 'block';
            tooltipEl.style.top = (e.clientY + 15) + 'px'; 
            tooltipEl.style.left = (e.clientX + 15) + 'px';
            
            document.getElementById('tt-tag').textContent = tag;
            document.getElementById('tt-font').textContent = `${fontSize} (${fontWeight})`;
            document.getElementById('tt-color').textContent = hexColor;
            document.getElementById('tt-color').style.color = hexColor;
            document.getElementById('tt-class').textContent = classes ? '.' + classes : '-';
        });

        document.addEventListener('mouseout', () => {
            if (isInspectorActive) tooltipEl.style.display = 'none';
        });

        const Hangul = {
            CHO: ["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"],
            JUNG: ["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"],
            JONG: ["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"],
            COMPLEX_JONG: {'ã„³':'ã„±ã……', 'ã„µ':'ã„´ã…ˆ', 'ã„¶':'ã„´ã…', 'ã„º':'ã„¹ã„±', 'ã„»':'ã„¹ã…', 'ã„¼':'ã„¹ã…‚', 'ã„½':'ã„¹ã……', 'ã„¾':'ã„¹ã…Œ', 'ã„¿':'ã„¹ã…', 'ã…€':'ã„¹ã…', 'ã…„':'ã…‚ã……'},
            JAMO_MAP: {'ã„³':'ã„±ã……', 'ã„µ':'ã„´ã…ˆ', 'ã„¶':'ã„´ã…', 'ã„º':'ã„¹ã„±', 'ã„»':'ã„¹ã…', 'ã„¼':'ã„¹ã…‚', 'ã„½':'ã„¹ã……', 'ã„¾':'ã„¹ã…Œ', 'ã„¿':'ã„¹ã…', 'ã…€':'ã„¹ã…', 'ã…„':'ã…‚ã……'},
            getCho: function(str) { let result = ""; for(let i=0; i<str.length; i++) { const code = str.charCodeAt(i) - 44032; if(code > -1 && code < 11172) result += this.CHO[Math.floor(code / 588)]; else result += str.charAt(i); } return result; },
            disassemble: function(str) { let result = ""; for (let i = 0; i < str.length; i++) { const char = str.charAt(i); const code = char.charCodeAt(0) - 44032; if (code > -1 && code < 11172) { const choIdx = Math.floor(code / 588); const jungIdx = Math.floor((code - (choIdx * 588)) / 28); const jongIdx = code % 28; const cho = this.CHO[choIdx]; const jung = this.JUNG[jungIdx]; let jong = this.JONG[jongIdx]; if(this.COMPLEX_JONG[jong]) { jong = this.COMPLEX_JONG[jong]; } result += cho + jung + jong; } else { if (this.JAMO_MAP[char]) { result += this.JAMO_MAP[char]; } else { result += char; } } } return result; }
        };

    
        function getKSTDate() { return new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Seoul" }); }
        
        function isRecentRankIn(dateStr) {
            if (!dateStr) return false;
            const today = new Date(getKSTDate());
            const rankIn = new Date(dateStr);
            const diffTime = today - rankIn;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 2; 
        }
        
        function scrollToTarget(id) {
            setTimeout(() => {
                const el = document.getElementById(`rank-card-${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    el.classList.add('highlight-slow'); 
                }
            }, 100); 
        }
        window.scrollToTarget = scrollToTarget; 

        window.toggleAccordion = (id) => {
            const el = document.getElementById(id);
            if(!el) return;
            el.classList.toggle('open');
            const btn = document.getElementById('btn-' + id);
            if(btn) {
                 const span = btn.querySelector('span');
                 if(el.classList.contains('open')) span.textContent = 'ğŸ”¼ ì ‘ê¸°';
                 else span.textContent = 'ğŸ”½ ìƒì„¸ ê³„ì‚°ì‹ ë³´ê¸°';
            }
        };

        function setMatchDate(type) {
            const input = document.getElementById('matchDateInput');
            const today = new Date(getKSTDate()); 
            if(type === 'today') {
                input.value = today.toISOString().split('T')[0];
            } else if(type === 'yesterday') {
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                input.value = yesterday.toISOString().split('T')[0];
            }
        }
        window.setMatchDate = setMatchDate; 

        // [ìˆ˜ì •] ì±”í”¼ì–¸ > ì±Œë¦°ì € > ì¼ë°˜ ë“±ê¸‰ ìˆœìœ¼ë¡œ íŒë³„
function getTier(wins, losses, elo = 0, isChampion = false) { 
    // 1ìˆœìœ„: ì±”í”¼ì–¸ (ì ìˆ˜/ì „ì  ë¬´ê´€)
    if (isChampion) {
        return { 
            name: 'ğŸ‘‘CHAMPION', 
            class: 'tier-champion', 
            color: 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white border border-yellow-600 shadow-md' 
        };
    }

    // 2ìˆœìœ„: ì±Œë¦°ì € (1300ì  ì´ìƒ)
    if (elo >= 1300) {
        return { 
            name: 'ğŸ¦…CHALLENGER', 
            class: 'tier-challenger', 
            color: 'bg-slate-900 border border-amber-400 text-amber-400 shadow-md ring-1 ring-amber-400/30' 
        };
    }

    // 3ìˆœìœ„: ì¼ë°˜ ë“±ê¸‰ (íŒìˆ˜ ê¸°ì¤€)
    const matches = (wins || 0) + (losses || 0);
    if (matches < 3) return { name: 'BRONZE', class: 'tier-bronze', color: 'bg-white border border-amber-600 text-amber-700' };
    if (matches < 7) return { name: 'SILVER', class: 'tier-silver', color: 'bg-white border border-slate-400 text-slate-500' };
    if (matches < 13) return { name: 'GOLD', class: 'tier-gold', color: 'bg-white border border-yellow-500 text-yellow-600' };
    return { name: 'PLATINUM', class: 'tier-platinum', color: 'bg-white border border-cyan-500 text-cyan-600' };
}
        
        function getTierBonus(matchCount, currentElo) { 
            // 1. ì±Œë¦°ì € ì „ìš© ë£° (1300ì  ì´ìƒ)
            // - ìŠ¹íŒ¨ ë°°ìœ¨ 1:1 (ë³´ì • ì—†ìŒ)
            // - ê¸°ë³¸ ì ìˆ˜(Base) 5ì  (ê¸°ì¡´ í”Œë˜í‹°ë„˜ 13ì ë³´ë‹¤ ë‚®ì•„ì ¸ì„œ ì ìˆ˜ ì˜¬ë¦¬ê¸° ë” í˜ë“¤ê²Œ ì„¤ì •)
            if (currentElo >= 1300) {
                return { winMult: 1.0, lossMult: 1.0, base: 5, tier: 'ğŸ¦…Challenger' };
            }

            // 2. ê¸°ì¡´ í‹°ì–´ ì‹œìŠ¤í…œ (1300ì  ë¯¸ë§Œ)
            if (matchCount < 3) return { winMult: 1.0, lossMult: 1.0, base: 5, tier: 'ğŸ¥‰Bronze' };
            else if (matchCount < 7) return { winMult: 1.1, lossMult: 0.9, base: 7, tier: 'ğŸ¥ˆSilver' };
            else if (matchCount < 13) return { winMult: 1.2, lossMult: 0.8, base: 9, tier: 'ğŸ¥‡Gold' };
            else return { winMult: 1.2, lossMult: 0.8, base: 13, tier: 'ğŸ’Platinum' };
        }

        function calculateHybridEloChange(p1Elo, p2Elo, isWin, p1Stats, opponentBounty = 0) { 
            const matchCount = (p1Stats.wins || 0) + (p1Stats.losses || 0); 
            let K = 60;
            let isPlacement = false;
            
            if (matchCount < 3) {
                K = 90;
                isPlacement = true;
            }

            const expected = 1 / (1 + Math.pow(10, (p2Elo - p1Elo) / 400)); 
            const expectedPct = Math.round(expected * 100);
            
            // [ì¤‘ìš” ë³€ê²½] p1Elo(í˜„ì¬ ì ìˆ˜)ë¥¼ ë„˜ê²¨ì„œ ì±Œë¦°ì € ì—¬ë¶€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
            const { winMult, lossMult, tier, base } = getTierBonus(matchCount, p1Elo); 
            
            let finalChange = 0; 
            let details = []; 
            // ë°°ì¹˜ê³ ì‚¬ ì¤‘ì´ë©´ 'ë°°ì¹˜' í‘œì‹œ, ì•„ë‹ˆë©´ í‹°ì–´ ì´ë¦„ í‘œì‹œ
            const label = isPlacement ? 'ğŸ£ë°°ì¹˜' : tier;

            let expectedText = `${expectedPct}%`;
            if (isWin) {
                expectedText += expectedPct < 50 ? " (ì—´ì„¸ ê·¹ë³µ)" : " (ìš°ì„¸)";
            } else {
                expectedText += expectedPct > 50 ? " (ìœ ë¦¬í•¨ ë†“ì¹¨)" : " (ì—´ì„¸)";
            }
            details.push({ label: 'ì˜ˆì¸¡ ìŠ¹ë¥  (Elo ê²©ì°¨)', value: expectedText, colorClass: 'text-slate-500', valueClass: 'text-slate-400' });

            if (isWin) { 
                let baseGain = K * (1 - expected); 
                details.push({ label: `ê¸°ë³¸ ë³€ë™ ì ìˆ˜ (K=${K})`, value: `+${baseGain.toFixed(1)}`, colorClass: 'text-slate-600', valueClass: '' });
                
                let winPoints = (baseGain * winMult) + base;
                let tierBonusStr = `x${winMult} + ${base}`;
                
                // ì±Œë¦°ì €ì¼ ê²½ìš° í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ë‹¤ë¥´ê²Œ í‘œì‹œ (Amber)
                const rankColor = p1Elo >= 1300 ? 'text-amber-600 bg-amber-50/50' : 'text-indigo-600 bg-indigo-50/50';

                details.push({ 
                    label: `í‹°ì–´ ê°€ì¤‘ì¹˜ (${label}, ${tierBonusStr})`, 
                    value: `+${winPoints.toFixed(1)}`, 
                    colorClass: `${rankColor} -mx-1 px-1 rounded py-0.5`, 
                    valueClass: 'font-bold' 
                });

                if (opponentBounty > 0) {
                    details.push({ label: 'ğŸ’° í˜„ìƒê¸ˆ ì‚¬ëƒ¥ ë³´ë„ˆìŠ¤', value: `+${opponentBounty}`, colorClass: 'text-amber-600 font-bold', valueClass: '' });
                }
                
                finalChange = winPoints + opponentBounty; 
            } else { 
                let baseLoss = K * (0 - expected); 
                details.push({ label: `ê¸°ë³¸ ë³€ë™ ì ìˆ˜ (K=${K})`, value: `${baseLoss.toFixed(1)}`, colorClass: 'text-slate-600', valueClass: '' });
                
                let lossPoints = (baseLoss * lossMult) + base; 
                let tierBonusStr = `x${lossMult} + ${base}`;
                
                const rankColor = p1Elo >= 1300 ? 'text-amber-700 bg-amber-50/50' : 'text-rose-600 bg-rose-50/50';

                details.push({ 
                    label: `í‹°ì–´ ê°€ì¤‘ì¹˜ (${label}, ${tierBonusStr})`, 
                    value: `${lossPoints.toFixed(1)}`, 
                    colorClass: `${rankColor} -mx-1 px-1 rounded py-0.5`, 
                    valueClass: 'font-bold' 
                });
                
                finalChange = lossPoints; 
            } 
            return { change: Math.round(finalChange), details: details }; 
        }

        async function hashPin(pin) { if (!pin) return ""; try { if (window.crypto && window.crypto.subtle) { const msgBuffer = new TextEncoder().encode(pin); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); } else { return pin; } } catch (e) { return pin; } }
        function generateUUID() { if (typeof crypto !== 'undefined' && crypto.randomUUID) { return crypto.randomUUID(); } return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

        document.getElementById('btnLogin').addEventListener('click', () => { 
            const email = document.getElementById('adminEmail').value; 
            const pw = document.getElementById('adminPw').value; 
            signInWithEmailAndPassword(auth, email, pw).catch((e) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message)); 
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
                setTimeout(() => { if (typeof setMatchDate === 'function') setMatchDate('today'); }, 100);
            } else {
                if(AUTO_LOGIN_EMAIL && AUTO_LOGIN_PW) {
                    document.getElementById('loginFormContainer').classList.add('hidden');
                    document.getElementById('autoLoginMsg').classList.remove('hidden');
                    signInWithEmailAndPassword(auth, AUTO_LOGIN_EMAIL, AUTO_LOGIN_PW).catch((e) => {
                        document.getElementById('loginFormContainer').classList.remove('hidden');
                        document.getElementById('autoLoginMsg').classList.add('hidden');
                    });
                } else {
                    document.getElementById('loginFormContainer').classList.remove('hidden');
                    document.getElementById('autoLoginMsg').classList.add('hidden');
                }
            }
        });

        const STYLE_OPTIONS = ["ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "í•˜ë“œ í€ì²˜", "ë°”ë”” ìŠ¤ë‚´ì²˜", "ë³¼ë¥¨ í€ì²˜", "ìŠ¤ìœ„ì¹˜ íˆí„°", "ë¸Œë¡¤ëŸ¬", "ì¹´ìš´í„° í€ì²˜", "ë³µì„œ-í€ì²˜", "ìŠ¬ë¦­", "ìƒ¤í”„ìŠˆí„°", "íŒ¨ìŠ¤íŠ¸ í•¸ë“œ"];
        const COLOR_PRESETS = [
            { name: "Black", code: "#1f2937" }, { name: "Half B/W", code: "linear-gradient(to bottom, #1f2937 50%, #f8fafc 50%)" },
            { name: "White", code: "#f8fafc" }, { name: "Gray", code: "#94a3b8" },
            { name: "Red", code: "#ef4444" }, { name: "Orange", code: "#f97316" }, { name: "Amber", code: "#f59e0b" },
            { name: "Gold", code: "#FFD700" }, { name: "Yellow", code: "#eab308" }, { name: "Lime", code: "#84cc16" }, 
            { name: "Green", code: "#22c55e" }, { name: "Emerald", code: "#10b981" }, { name: "Teal", code: "#14b8a6" }, 
            { name: "Sky", code: "#0ea5e9" }, { name: "Blue", code: "#3b82f6" }, { name: "Indigo", code: "#6366f1" }, 
            { name: "Purple", code: "#a855f7" }, { name: "Fuchsia", code: "#d946ef" }, { name: "Pink", code: "#ec4899" }, 
            { name: "Rose", code: "#f43f5e" }
        ];
        const DEFAULT_RULE_HTML = `<div class="space-y-5 text-slate-700 font-sans">...</div>`;

        document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value.toLowerCase(); renderRankings(); });
        
        const presetContainer = document.getElementById('trunkColorPresets');
        presetContainer.innerHTML = '';
        COLOR_PRESETS.forEach(color => { const div = document.createElement('div'); div.className = 'color-preset shadow-sm'; div.style.background = color.code; div.dataset.color = color.code; div.title = color.name; div.onclick = () => selectPresetColor(color.code, div); presetContainer.appendChild(div); });
        
        for(let i=1; i<=3; i++) { 
            const wrapper = document.createElement('div'); wrapper.className = 'color-preset shadow-sm flex items-center justify-center bg-white border border-slate-200 custom-picker-slot relative'; 
            const input = document.createElement('input'); input.type = 'color'; input.className = 'opacity-0 absolute inset-0 w-full h-full cursor-pointer'; input.value = '#ffffff'; 
            input.addEventListener('input', (e) => { const newColor = e.target.value; wrapper.style.backgroundColor = newColor; wrapper.dataset.color = newColor; selectPresetColor(newColor, wrapper); }); 
            wrapper.appendChild(input); presetContainer.appendChild(wrapper); 
        }

        function selectPresetColor(code, element) { document.getElementById('editTrunkColor').value = code; document.querySelectorAll('.color-preset').forEach(el => el.classList.remove('active')); if(element) element.classList.add('active'); }

        function renderMemos() { 
            const container = document.getElementById('memoListContainer'); if(!container) return;
            if(adminMemos.length === 0) { container.innerHTML = '<div class="text-center text-xs text-gray-400 py-4">ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } 
            container.innerHTML = ''; 
            adminMemos.forEach(m => { 
                const el = document.createElement('div'); el.className = 'bg-white border border-slate-200 rounded p-2 text-sm shadow-sm flex justify-between items-start group'; 
                el.innerHTML = `<div><div class="text-[10px] text-slate-400 font-medium mb-0.5">${m.date}</div><div class="text-slate-700 whitespace-pre-wrap">${m.content}</div></div><button onclick="deleteMemo(${m.id})" class="text-slate-300 hover:text-red-500 text-xs px-1 opacity-0 group-hover:opacity-100 transition">âœ•</button>`; 
                container.appendChild(el); 
            }); 
        }

        function renderSeasonList() { 
            const container = document.getElementById('seasonListContainer'); if(!container) return;
            container.innerHTML = ''; 
            const seasons = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)]; 
            seasons.forEach(sName => { 
                const isActive = sName === activeSeason; 
                const div = document.createElement('div'); div.className = `flex justify-between items-center p-3 rounded-lg border ${isActive ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200'}`; 
                div.innerHTML = `<div class="flex items-center gap-2"><span class="${isActive ? 'text-blue-700 font-bold' : 'text-slate-600'} text-sm">${sName}</span>${isActive ? '<span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded">Active</span>' : ''}</div><div class="flex gap-1">${!isActive ? `<button onclick="switchActiveSeason('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 rounded border border-slate-200">ì„ íƒ</button>` : ''}<button onclick="openRenameModal('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-500 px-2 py-1 rounded border border-slate-200">ì´ë¦„ë³€ê²½</button>${!isActive ? `<button onclick="deleteSeason('${sName}')" class="text-xs bg-red-50 hover:bg-red-100 text-red-500 px-2 py-1 rounded border border-red-100">ì‚­ì œ</button>` : ''}</div>`; 
                container.appendChild(div); 
            }); 
        }

        function loadData() { 
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); 
    onSnapshot(docRef, (doc) => { 
        if (doc.exists()) { 
            const data = doc.data(); 
            rankingsData = data.rankings || []; matchHistoryData = data.matchHistory || []; seasonArchives = data.seasonArchives || {}; activeSeason = data.activeSeason || "ì‹œì¦Œ 1"; adminMemos = data.adminMemos || []; ruleHtml = data.ruleHtml || DEFAULT_RULE_HTML; 
            if(!viewHistorySeason) viewHistorySeason = activeSeason; 
            
            updateSeasonUI(); renderMemos(); renderSeasonList(); 
            document.getElementById('ruleHtmlInput').value = ruleHtml; 
            if(data.noticeData) { document.getElementById('noticeContentInput').value = data.noticeData.content || ""; document.getElementById('noticeActiveToggle').checked = data.noticeData.active || false; } 
            
            rankingsData.forEach((p, i) => { 
                if(p.defenseCount === undefined) p.defenseCount = 0; 
                if(p.previousRank === undefined) p.previousRank = i + 1; 
                if(p.careerHighRank === undefined) p.careerHighRank = i + 1; 
                if(p.elo === undefined) p.elo = 1000; 
                if(p.careerHighElo === undefined) p.careerHighElo = p.elo; 
                if(!p.trunkColor) p.trunkColor = '#1f2937'; 
                if(p.bounty === undefined) p.bounty = 0;
                
                // [í•„ìˆ˜] ì—°ìŠ¹ ë°ì´í„° ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                if(p.currentStreak === undefined) p.currentStreak = 0;

                p.choseong = Hangul.getCho(p.name); p.jamo = Hangul.disassemble(p.name);
            }); 
            
            renderRankings(); populateMatchSelectors(); checkSeasonInactive(); enrichMatchHistory(); updateAdminHistorySeasonSelector(); renderAdminMatches(); 
            if (currentProfileId) updateProfileStats(currentProfileId, document.getElementById('pModalSeason').value); 
            if(document.getElementById('totalPlayerCount')) document.getElementById('totalPlayerCount').textContent = `(${rankingsData.length}ëª…)`;
        } 
    }); 
}

        function updateSeasonUI() { document.getElementById('currentSeasonBadge').textContent = activeSeason; document.querySelectorAll('.currentSeasonName').forEach(el => el.textContent = activeSeason); const num = parseInt(activeSeason.replace(/[^0-9]/g, '')) || 0; document.getElementById('newSeasonNameInput').value = `ì‹œì¦Œ ${num + 1}`; }
        function resetMatchInputs(keepDate = false) { if(p1Tom) p1Tom.clear(); if(p2Tom) p2Tom.clear(); const radios = document.querySelectorAll('input[name="winner"]'); radios.forEach(r => r.checked = false); const p1Ind = document.getElementById('p1TrunkIndicator'); const p2Ind = document.getElementById('p2TrunkIndicator'); if(p1Ind) p1Ind.style.backgroundColor = '#f1f5f9'; if(p2Ind) p2Ind.style.backgroundColor = '#f1f5f9'; updateMatchPreview(); if (!keepDate) setMatchDate('today'); }
        window.resetMatchInputs = resetMatchInputs;

        function updateMatchPreview() { 
    let p1Idx = ""; if (p1Tom) p1Idx = p1Tom.getValue(); else { const el = document.getElementById('p1Select'); if(el) p1Idx = el.value; } 
    let p2Idx = ""; if (p2Tom) p2Idx = p2Tom.getValue(); else { const el = document.getElementById('p2Select'); if(el) p2Idx = el.value; } 
    
    if(p1Idx !== "") p1Idx = parseInt(p1Idx); 
    if(p2Idx !== "") p2Idx = parseInt(p2Idx); 
    
    const p1Ind = document.getElementById('p1TrunkIndicator'); 
    const p2Ind = document.getElementById('p2TrunkIndicator'); 
    const p1 = (p1Idx !== "" && !isNaN(p1Idx)) ? rankingsData[p1Idx] : null; 
    const p2 = (p2Idx !== "" && !isNaN(p2Idx)) ? rankingsData[p2Idx] : null; 
    
    if (p1Ind) { if (p1 && p1.trunkColor) p1Ind.style.background = p1.trunkColor; else p1Ind.style.background = '#f1f5f9'; }
    if (p2Ind) { if (p2 && p2.trunkColor) p2Ind.style.background = p2.trunkColor; else p2Ind.style.background = '#f1f5f9'; }
    
    if (!p1 || !p2 || p1Idx === p2Idx) { document.getElementById('matchPreview').classList.add('hidden'); return; } 
    const checkedRadio = document.querySelector('input[name="winner"]:checked'); 
    if (!checkedRadio) { document.getElementById('matchPreview').classList.add('hidden'); return; } 
    
    document.getElementById('matchPreview').classList.remove('hidden'); 
    const winnerVal = checkedRadio.value; 
    
    const currentRanked = rankingsData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
    
    const getRankText = (player) => {
        const total = Number(player.wins || 0) + Number(player.losses || 0);
        if (total < 3) return 'ğŸ£ë°°ì¹˜ì¤‘';
        const idx = currentRanked.findIndex(p => p.id === player.id);
        return idx === -1 ? 'Unranked' : `${idx + 1}ìœ„`;
    };

    const curRank1 = getRankText(p1);
    const curRank2 = getRankText(p2);
    
    const simRankings = JSON.parse(JSON.stringify(rankingsData)); 
    const simP1 = simRankings.find(p => p.id === p1.id); 
    const simP2 = simRankings.find(p => p.id === p2.id); 
    let p1Change, p2Change;
    let p1Details = [], p2Details = [];
    
    // [ë³€ê²½] ë² í…Œë‘ ì—¬ë¶€ ìƒê´€ì—†ì´ í˜„ìƒê¸ˆ ê°’ë§Œ ê°€ì ¸ì˜´
    let p1Bounty = parseInt(simP1.bounty || 0, 10);
    let p2Bounty = parseInt(simP2.bounty || 0, 10);

    if (winnerVal === 'blue') { 
        const w = calculateHybridEloChange(simP1.elo, simP2.elo, true, simP1, p2Bounty); 
        const l = calculateHybridEloChange(simP2.elo, simP1.elo, false, simP2, 0); 
        p1Change = w.change;
        p1Details = w.details; 
        p2Change = l.change; 
        p2Details = l.details;
        
        if (p2Bounty > 0) {
            const penalty = Math.floor(p2Bounty / 2);
            p2Change -= penalty;
            p2Details.push({ label: "ğŸ’¸ í˜„ìƒê¸ˆ íŒ¨ë„í‹° (50%)", value: `-${penalty}`, colorClass: "text-rose-600 font-bold bg-rose-50/50 -mx-1 px-1 rounded py-0.5", valueClass: "" });
        }

        simP1.elo += p1Change; simP1.wins++; 
        simP2.elo += p2Change; simP2.losses++; 
    } else { 
        const w = calculateHybridEloChange(simP2.elo, simP1.elo, true, simP2, p1Bounty); 
        const l = calculateHybridEloChange(simP1.elo, simP2.elo, false, simP1, 0); 
        p2Change = w.change;
        p2Details = w.details; 
        p1Change = l.change; 
        p1Details = l.details;
        
        if (p1Bounty > 0) {
            const penalty = Math.floor(p1Bounty / 2);
            p1Change -= penalty;
            p1Details.push({ label: "ğŸ’¸ í˜„ìƒê¸ˆ íŒ¨ë„í‹° (50%)", value: `-${penalty}`, colorClass: "text-rose-600 font-bold bg-rose-50/50 -mx-1 px-1 rounded py-0.5", valueClass: "" });
        }

        simP2.elo += p2Change; simP2.wins++; 
        simP1.elo += p1Change; simP1.losses++; 
    } 
    
    const simRankedList = simRankings.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
    const getNewRankText = (player) => {
        const total = Number(player.wins || 0) + Number(player.losses || 0);
        if (total < 3) return 'ğŸ£ë°°ì¹˜ì¤‘';
        const idx = simRankedList.findIndex(p => p.id === player.id);
        return idx === -1 ? 'Unranked' : `${idx + 1}ìœ„`;
    };
    const newRank1 = getNewRankText(simP1);
    const newRank2 = getNewRankText(simP2);
    const getScoreStyle = (change) => change > 0 ? 'text-red-600' : (change < 0 ? 'text-blue-600' : 'text-slate-500'); 
    const p1ScoreClass = getScoreStyle(p1Change); 
    const p2ScoreClass = getScoreStyle(p2Change); 
    
    const renderDetailBlock = (details, totalChange, themeColor) => {
        const bgClass = themeColor === 'blue' ? 'bg-blue-50/50 border-blue-100 shadow-inner' : 'bg-red-50/50 border-red-100 shadow-inner';
        const finalColor = themeColor === 'blue' ? 'text-blue-700' : 'text-red-700';
        const sign = totalChange > 0 ? '+' : '';
        const dividerColor = themeColor === 'blue' ? 'border-blue-200' : 'border-red-200';
        
        let rows = details.map(d => `
            <div class="flex justify-between items-center ${d.colorClass || ''}">
                <span>${d.label}</span> <span class="${d.valueClass || ''}">${d.value}</span>
            </div>
        `).join('');

        return `
            <div class="${bgClass} rounded-lg p-3 mt-2 border">
                <div class="space-y-1.5 font-mono text-[11px] sm:text-xs">
                    ${rows}
                    <div class="border-t-2 border-dashed ${dividerColor} my-2 pt-2"></div>
                    <div class="flex justify-between items-center text-[13px] font-black ${finalColor}">
                        <span>ìµœì¢… íšë“ ì ìˆ˜</span> <span>${sign}${totalChange}</span>
                    </div>
                </div>
            </div>
        `;
    };

    let htmlContent = `
    <div class="font-bold text-slate-800 mb-2 border-b border-gray-200 pb-2 flex justify-between items-center">
        <span class="text-base">ğŸ¯ ì˜ˆìƒ ê²°ê³¼ (ìˆœìœ„ ë³€ë™ í¬í•¨)</span>
        <span class="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded">Simulation</span>
    </div>
    <div class="space-y-3">
        <div class="flex flex-col">
            <div class="flex justify-between items-center">
                <span class="text-blue-600 font-bold truncate text-base">ğŸ”µ ${p1.name}</span>
                <span class="text-[15px] font-mono text-slate-600 font-bold">${p1.elo} â†’ ${simP1.elo} <span class="${p1ScoreClass}">(${p1Change >= 0 ? '+'+p1Change : p1Change})</span></span>
            </div>
            <div class="text-right text-[15px] text-slate-500 font-medium">ìˆœìœ„: ${curRank1} â” <span class="text-blue-600 font-bold">${newRank1}</span></div>
            
            <button id="btn-acc-p1" onclick="toggleAccordion('acc-p1')" class="text-[10px] text-slate-400 font-bold hover:text-blue-600 flex items-center gap-1 mt-1 ml-auto transition-colors">
                <span>ğŸ”½ ìƒì„¸ ê³„ì‚°ì‹ ë³´ê¸°</span>
            </button>
            <div id="acc-p1" class="accordion-content">
                ${renderDetailBlock(p1Details, p1Change, 'blue')}
            </div>
        </div>
        
        <div class="flex flex-col border-t border-slate-100 pt-2 mt-1">
            <div class="flex justify-between items-center">
                <span class="text-red-600 font-bold truncate text-base">ğŸ”´ ${p2.name}</span>
                <span class="text-[15px] font-mono text-slate-600 font-bold">${p2.elo} â†’ ${simP2.elo} <span class="${p2ScoreClass}">(${p2Change >= 0 ? '+'+p2Change : p2Change})</span></span>
            </div>
            <div class="text-right text-[15px] text-slate-500 font-medium">ìˆœìœ„: ${curRank2} â” <span class="text-blue-600 font-bold">${newRank2}</span></div>
            
            <button id="btn-acc-p2" onclick="toggleAccordion('acc-p2')" class="text-[10px] text-slate-400 font-bold hover:text-red-600 flex items-center gap-1 mt-1 ml-auto transition-colors">
                <span>ğŸ”½ ìƒì„¸ ê³„ì‚°ì‹ ë³´ê¸°</span>
            </button>
            <div id="acc-p2" class="accordion-content">
                ${renderDetailBlock(p2Details, p2Change, 'red')}
            </div>
        </div>
    </div>`; 
    document.getElementById('previewContent').innerHTML = htmlContent; 
}
        window.updateMatchPreview = updateMatchPreview;

        window.applyMatch = () => { 
    let val1 = p1Tom ? p1Tom.getValue() : document.getElementById('p1Select').value;
    let val2 = p2Tom ? p2Tom.getValue() : document.getElementById('p2Select').value;

    if (val1 === "" || val1 === null) return alert("ğŸ”µ Blue ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
    if (val2 === "" || val2 === null) return alert("ğŸ”´ Red ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

    const p1Idx = parseInt(val1); const p2Idx = parseInt(val2);
    const winnerVal = document.querySelector('input[name="winner"]:checked')?.value; 
    if (!winnerVal) return alert("ìŠ¹ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš” (Blue ìŠ¹ / Red ìŠ¹)."); 
    if (p1Idx === p2Idx) return alert("ë™ì¼í•œ ì„ ìˆ˜ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); 
    
    const p1 = rankingsData[p1Idx]; const p2 = rankingsData[p2Idx]; 
    if (!p1 || !p2) return alert("ì„ ìˆ˜ ë°ì´í„° ë§¤ì¹­ ì˜¤ë¥˜: ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");

    const isBlueWin = winnerVal === 'blue'; 
    const winner = isBlueWin ? p1 : p2; const loser = isBlueWin ? p2 : p1; 
    
    captureState(); 

            // [ë¡œì§ ì¶”ê°€] íƒ€ì´í‹€ ë§¤ì¹˜ ì²˜ë¦¬
    const isTitleMatch = document.getElementById('isTitleMatch').checked;
    
    if (isTitleMatch) {
        // ì±Œë¦°ì € ê¸°ì¤€: 1300ì  ì´ìƒ
        const winnerIsChallenger = (winner.elo || 1000) >= 1300;
        const loserIsChallenger = (loser.elo || 1000) >= 1300;
        
        // ê¸°ì¡´ ì±”í”¼ì–¸ ì—¬ë¶€ í™•ì¸
        const winnerWasChamp = winner.isChampion === true;
        const loserWasChamp = loser.isChampion === true;
        
        let newChampionId = null; // nullì´ë©´ ê³µì„, IDê°€ ìˆìœ¼ë©´ ê·¸ ì‚¬ëŒì´ ì±”í”¼ì–¸
        
        // Case 1: ì±Œë¦°ì € vs ì±Œë¦°ì € (ë‘˜ ë‹¤ ì±Œë¦°ì €)
        if (winnerIsChallenger && loserIsChallenger) {
            newChampionId = winner.id; // ìŠ¹ìê°€ ì±”í”¼ì–¸ ë“±ê·¹
        }
        // Case 2: ì±”í”¼ì–¸ vs ì±Œë¦°ì €
        else if (winnerWasChamp && loserIsChallenger) {
            newChampionId = winner.id; // ì±”í”¼ì–¸ ë°©ì–´ ì„±ê³µ
        }
        else if (loserWasChamp && winnerIsChallenger) {
            newChampionId = winner.id; // íƒ€ì´í‹€ ëºê¹€ (ìŠ¹ìê°€ ìƒˆ ì±”í”¼ì–¸)
        }
        // Case 3: ì±”í”¼ì–¸ vs ë¹„ì±Œë¦°ì €
        else if (winnerWasChamp && !loserIsChallenger) {
            newChampionId = winner.id; // ì±”í”¼ì–¸ ë°©ì–´ ì„±ê³µ (íƒ€ì´í‹€ ìœ ì§€)
        }
        else if (loserWasChamp && !winnerIsChallenger) {
            newChampionId = null; // ì±”í”¼ì–¸ íŒ¨ë°°í–ˆìœ¼ë‚˜ ìŠ¹ìê°€ ìê²© ë¯¸ë‹¬ -> ê³µì„(Vacant)
        }
        // ê·¸ ì™¸ (ë¹„ì±Œë¦°ì €ë¼ë¦¬ íƒ€ì´í‹€ë§¤ì¹˜? - ë³´í†µ ë¶ˆê°€ëŠ¥í•˜ì§€ë§Œ ìŠ¹ìê°€ ì±”í”¼ì–¸ ë˜ëŠ” ê±¸ ë§‰ìŒ)
        else {
            newChampionId = null; 
        }

        // ì „ì²´ ì„ ìˆ˜ë‹¨ ì±”í”¼ì–¸ ìƒíƒœ ì´ˆê¸°í™” ë° ì¬ì„¤ì •
        rankingsData.forEach(p => {
            if (p.id === newChampionId) {
                p.isChampion = true;
                // ë°©ì–´ì „ íšŸìˆ˜ ì¦ê°€ (ê¸°ì¡´ ì±”í”¼ì–¸ì´ì—ˆê³  ìœ ì§€í–ˆë‹¤ë©´)
                if (winnerWasChamp && winner.id === newChampionId) {
                    p.defenseCount = (p.defenseCount || 0) + 1;
                } else {
                    p.defenseCount = 0; // ìƒˆë¡œ ì±”í”¼ì–¸ì´ ë˜ë©´ ë°©ì–´ì „ 0ë¶€í„°
                }
            } else {
                p.isChampion = false;
            }
        });

        if (newChampionId === null && loserWasChamp) {
            alert("ğŸš¨ ì±”í”¼ì–¸ì´ íŒ¨ë°°í–ˆì§€ë§Œ ìŠ¹ìê°€ 'ì±Œë¦°ì €' ìê²©ì´ ì—†ì–´ íƒ€ì´í‹€ì´ [ê³µì„] ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else if (newChampionId === winner.id && !winnerWasChamp) {
            alert(`ğŸ‘‘ ìƒˆë¡œìš´ ì±”í”¼ì–¸ íƒ„ìƒ! [${winner.name}]`);
        }
    }
            // --- ê¸°ì¡´ ë¡œì§ ê³„ì† ---
    const currentRankedListForHistory = [...rankingsData].filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
    const getPlayerRankBefore = (player) => { const total = (player.wins || 0) + (player.losses || 0); if (total < 3) return 0; return currentRankedListForHistory.findIndex(p => p.id === player.id) + 1; };
    const winnerRankBefore = getPlayerRankBefore(winner); const loserRankBefore = getPlayerRankBefore(loser);

    // [ë³€ê²½] ë² í…Œë‘ ìƒê´€ì—†ì´ íŒ¨ìì˜ í˜„ìƒê¸ˆ ì¡°íšŒ
    let loserBountyVal = parseInt(loser.bounty || 0, 10);

    // ELO ê³„ì‚°
    const winCalc = calculateHybridEloChange(winner.elo, loser.elo, true, winner, loserBountyVal); 
    const loseCalc = calculateHybridEloChange(loser.elo, winner.elo, false, loser, 0); 
    
    // [ë³€ê²½] ìŠ¹ì: 3ì—°ìŠ¹ë¶€í„° 10ì ì”© í˜„ìƒê¸ˆ ëˆ„ì 
    winner.currentStreak = (winner.currentStreak || 0) + 1;
    if (winner.currentStreak >= 3) {
        winner.bounty = (winner.bounty || 0) + 10;
    }

    // [ë³€ê²½] íŒ¨ì: ì—°ìŠ¹ ë° í˜„ìƒê¸ˆ ì´ˆê¸°í™”
    loser.currentStreak = 0;
    
    if (loserBountyVal > 0) {
        // í˜„ìƒê¸ˆì´ ìˆì—ˆë‹¤ë©´ ì ˆë°˜ ì°¨ê° íŒ¨ë„í‹° ì ìš©
        const penalty = Math.floor(loserBountyVal / 2);
        loseCalc.change -= penalty; 
        loser.bounty = 0; // ëºê¹€
    } else {
        loser.bounty = 0;
    }
    
    winner.elo += winCalc.change; loser.elo += loseCalc.change; 
    if (winner.elo > (winner.careerHighElo || 0)) winner.careerHighElo = winner.elo; 
    if (loser.elo > (loser.careerHighElo || 0)) loser.careerHighElo = loser.elo; 
    
    let type = 'ranking'; winner.wins++; loser.wins = loser.wins || 0; loser.losses++; 
    const dateInput = document.getElementById('matchDateInput').value;
    const matchDate = dateInput || getKSTDate();
    winner.lastMatchDate = matchDate; loser.lastMatchDate = matchDate; 
    
    rankingsData.sort((a, b) => b.elo - a.elo); 
    const rankedPlayersForSync = rankingsData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3);
    
    [winner, loser].forEach(p => {
        const total = (p.wins || 0) + (p.losses || 0);
        if (total === 3) {
            const realRank = rankedPlayersForSync.findIndex(rp => rp.id === p.id) + 1;
            if (realRank > 0) { p.previousRank = realRank; p.rankInDate = matchDate; }
        }
    });

    matchHistoryData.unshift({ 
        date: matchDate, winner: isBlueWin ? p1.name : p2.name, loser: isBlueWin ? p2.name : p1.name, type, season: activeSeason, blue: p1.name, winnerChange: winCalc.change, loserChange: loseCalc.change, winnerRankBefore: winnerRankBefore, loserRankBefore: loserRankBefore
    }); 
    matchHistoryData.sort((a, b) => new Date(b.date) - new Date(a.date));
    activeHighlight = { ids: [winner.id, loser.id], endTime: Date.now() + 60000 };

    saveRankings(); renderRankings(); scrollToTarget(winner.id); resetMatchInputs(true);
};
        window.applyBatchIdUpdate = async () => {
            console.log("applyBatchIdUpdate called");
            const textarea = document.getElementById('exportTextarea');
            if (!textarea) return showCustomAlert("í…ìŠ¤íŠ¸ ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            
            const text = textarea.value;
            if (!text.trim()) return showCustomAlert("ì…ë ¥ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

            const lines = text.split('\n').filter(line => line.trim() !== '');
            const updates = [];
            let notFoundCount = 0;
            let sameIdCount = 0;
            let formatErrorCount = 0;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                const match = trimmedLine.match(/^(.*?)[\s\t]+([^\s\t]+)$/);
                
                if (match) {
                    let name = match[1].trim();
                    let newId = match[2].trim();
                    if (['-', 'undefined', 'null', '(ì—†ìŒ)'].includes(newId)) {
                        newId = '';
                    }
                    const player = rankingsData.find(p => p.name === name);
                    if (player) {
                        const currentId = player.gameId || '';
                        if (currentId !== newId) {
                            updates.push({ player, newId });
                        } else {
                            sameIdCount++;
                        }
                    } else {
                        console.warn(`[Batch Update] Player not found: "${name}"`);
                        notFoundCount++;
                    }
                } else {
                    formatErrorCount++;
                }
            });

            if (updates.length === 0) {
                let msg = "âš ï¸ ë³€ê²½í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
                if (notFoundCount > 0) msg += `\n- ì´ë¦„ ë¶ˆì¼ì¹˜: ${notFoundCount}ëª… (ì„ ìˆ˜ ëª…ë‹¨ í™•ì¸ í•„ìš”)`;
                if (sameIdCount > 0) msg += `\n- ë³€ê²½ì‚¬í•­ ì—†ìŒ: ${sameIdCount}ëª… (ê¸°ì¡´ IDì™€ ë™ì¼)`;
                if (formatErrorCount > 0) msg += `\n- í˜•ì‹ ì˜¤ë¥˜: ${formatErrorCount}ì¤„ ("ì´ë¦„ ID" í˜•ì‹ì´ ì•„ë‹˜)`;
                return showCustomAlert(msg);
            }

            const confirmMsg = `ì´ ${updates.length}ëª…ì˜ Game IDë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?` + 
                               (notFoundCount > 0 ? `\n(ì‹¤íŒ¨: ${notFoundCount}ëª… - ì´ë¦„ ì—†ìŒ)` : '') +
                               `\n\n[ë³€ê²½ ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 5ëª…)]\n${updates.slice(0, 5).map(u => `${u.player.name}: ${u.player.gameId || '(ì—†ìŒ)'} â” ${u.newId || '(ì‚­ì œ)'}`).join('\n')}` +
                               (updates.length > 5 ? `\n...ì™¸ ${updates.length - 5}ëª…` : '');

            showConfirmModal(confirmMsg, async () => {
                captureState(); 
                updates.forEach(u => {
                    u.player.gameId = u.newId;
                });
                await saveRankings();
                renderRankings();
                showCustomAlert(`âœ… ${updates.length}ëª…ì˜ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                document.getElementById('exportModal').classList.add('hidden');
            });
        };
        
        // --- ë³µì›ëœ í•¨ìˆ˜ ì˜ì—­ ì‹œì‘ ---
        function enrichMatchHistory() { 
            const chronological = [...matchHistoryData].reverse(); 
            const statsTracker = {}; 
            enrichedHistory = chronological.map(match => { 
                const winner = match.winner; 
                const loser = match.loser; 
                if (!statsTracker[winner]) statsTracker[winner] = { w: 0, l: 0, h: [] }; 
                if (!statsTracker[loser]) statsTracker[loser] = { w: 0, l: 0, h: [] }; 
                const snapshot = { [winner]: { ...statsTracker[winner] }, [loser]: { ...statsTracker[loser] } }; 
                if (match.type !== 'draw') { 
                    statsTracker[winner].w += 1; 
                    statsTracker[winner].h = [...statsTracker[winner].h, 'W'].slice(-6); 
                    statsTracker[loser].l += 1; 
                    statsTracker[loser].h = [...statsTracker[loser].h, 'L'].slice(-6); 
                } 
                return { ...match, snapshot }; 
            }); 
            enrichedHistory.reverse(); 
        }
        
        function renderAdminMatches() { 
            const container = document.getElementById('adminMatchListContainer'); 
            container.innerHTML = ''; 
            const filtered = enrichedHistory.filter(m => (m.season || "ì‹œì¦Œ 1") === viewHistorySeason && m.type !== 'draw'); 
            if (filtered.length === 0) { 
                container.innerHTML = `<div class="text-center text-xs text-slate-400 py-10">ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                return; 
            } 
            const dateCounts = filtered.reduce((acc, m) => { acc[m.date] = (acc[m.date] || 0) + 1; return acc; }, {});
            let lastDate = "";
            filtered.forEach((m, idx) => { 
                const rawIndex = matchHistoryData.findIndex(raw => raw.date === m.date && raw.winner === m.winner && raw.loser === m.loser); 
                const winStats = m.snapshot[m.winner] || { w:0, l:0, h:[] }; 
                const loseStats = m.snapshot[m.loser] || { w:0, l:0, h:[] }; 
                let winDots = ''; (winStats.h || []).forEach(r => winDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`); 
                let loseDots = ''; (loseStats.h || []).forEach(r => loseDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`); 
                if (m.date !== lastDate) {
                    const count = dateCounts[m.date];
                    const dateHeader = document.createElement('div');
                    dateHeader.className = "text-xs font-bold text-slate-500 mt-4 mb-2 px-1 flex items-center gap-1 sticky top-0 bg-f8fafc/90 backdrop-blur-sm z-10 py-1";
                    dateHeader.style.cssText = "background-color: rgba(248, 250, 252, 0.95); backdrop-filter: blur(2px);";
                    dateHeader.innerHTML = `<span>ğŸ“…</span> ${m.date} <span class="text-slate-400 font-normal text-[11px] ml-1">(ì´ ${count}ê²½ê¸°)</span>`;
                    container.appendChild(dateHeader);
                    lastDate = m.date;
                }
                const div = document.createElement('div'); 
                div.className = "bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-2 relative group hover:border-blue-300 transition-colors"; 
                div.innerHTML = `<button onclick="deleteMatchLog(${rawIndex})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100 p-1" title="ê¸°ë¡ ì‚­ì œ"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button><div class="flex items-center justify-between text-xs mt-1"><div class="flex flex-col items-start w-[45%]"><div class="flex items-center gap-1.5"><span class="text-xs font-black text-slate-800 truncate">${m.winner}</span><span class="bg-emerald-100 text-emerald-600 text-[9px] px-1 py-0.5 rounded font-bold">WIN</span></div><div class="flex items-center gap-2 mt-1"><span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${winStats.w}ìŠ¹ ${winStats.l}íŒ¨</span><div class="flex gap-0.5">${winDots}</div></div></div><div class="text-[10px] font-bold text-slate-300">VS</div><div class="flex flex-col items-end w-[45%]"><div class="flex items-center gap-1.5"><span class="bg-rose-100 text-rose-600 text-[9px] px-1 py-0.5 rounded font-bold">LOSE</span><span class="text-xs font-medium text-slate-500 truncate">${m.loser}</span></div><div class="flex items-center gap-2 mt-1"><div class="flex gap-0.5">${loseDots}</div><span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${loseStats.w}ìŠ¹ ${loseStats.l}íŒ¨</span></div></div></div>`; 
                container.appendChild(div); 
            }); 
        }

        function updateAdminHistorySeasonSelector() { 
            const selector = document.getElementById('adminHistorySeason'); 
            selector.innerHTML = ''; 
            const opts = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)]; 
            opts.forEach(s => { 
                const opt = document.createElement('option'); 
                opt.value = s; 
                opt.textContent = s + (s === activeSeason ? " ğŸŸ¢" : ""); 
                selector.appendChild(opt); 
            }); 
            selector.value = viewHistorySeason; 
            selector.onchange = (e) => { viewHistorySeason = e.target.value; renderAdminMatches(); }; 
        }

        window.deleteMatchLog = (idx) => { 
            if (idx === -1) return; 
            if(!confirm("âš ï¸ ê²½ê³ : ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ë¡œê·¸ ëª©ë¡ì—ì„œë§Œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.\n- ì´ë¯¸ ë³€ë™ëœ ìŠ¹/íŒ¨ íšŸìˆ˜ë‚˜ ì ìˆ˜(ELO)ëŠ” ë˜ëŒì•„ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤.\n- ì ìˆ˜ ìˆ˜ì •ì´ í•„ìš”í•˜ë©´ 'ì„ ìˆ˜ ìˆ˜ì •' ë©”ë‰´ë¥¼ ì´ìš©í•˜ì„¸ìš”.")) return; 
            captureState(); 
            matchHistoryData.splice(idx, 1); 
            saveRankings(); 
            renderAdminMatches(); 
            alert("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); 
        };

        window.openMatchExportModal = () => { 
            const modal = document.getElementById('exportModal'); 
            if (modal) modal.classList.remove('hidden'); 
            const title = document.getElementById('exportModalTitle'); 
            if (title) title.textContent = "ğŸ“¤ í…ìŠ¤íŠ¸ ë‚´ë³´ë‚´ê¸° / ìˆ˜ì •"; 
            const options = document.getElementById('exportMatchOptions'); 
            if (options) { 
                options.classList.remove('hidden'); 
                options.innerHTML = `<div class="flex gap-2 w-full mb-2"><button onclick="generateExportText(15)" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">ìµœê·¼ 15ê²½ê¸°</button><button onclick="generateExportText(30)" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs transition border border-indigo-100">ìµœê·¼ 30ê²½ê¸°</button></div><div class="flex justify-end px-1"><label class="inline-flex items-center cursor-pointer hover:bg-slate-50 p-1 rounded transition"><input type="checkbox" id="hideRankToggle" onchange="generateExportText()" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer"><span class="ml-2 text-xs text-slate-500 font-bold select-none">ìˆœìœ„ ìˆ¨ê¸°ê¸°</span></label></div>`; 
            } 
            const textarea = document.getElementById('exportTextarea'); 
            if (textarea) textarea.value = ""; 
            window.lastExportCount = 15; 
            generateExportText(15); 
        };
        
        function getPlayerStatusLabel(p, realRankList) { 
            const total = (p.wins || 0) + (p.losses || 0); 
            if (total < 3) return `${p.name}(UR)`; 
            const rank = realRankList.findIndex(r => r.id === p.id) + 1; 
            return `${p.name}(${rank}ìœ„)`; 
        }

        window.generateExportText = (count) => { 
            if (count) window.lastExportCount = count; 
            else count = window.lastExportCount || 15; 
            const hideRank = document.getElementById('hideRankToggle')?.checked || false; 
            const targetSeason = viewHistorySeason || activeSeason; 
            const filtered = matchHistoryData.filter(m => (m.season || "ì‹œì¦Œ 1") === targetSeason && m.type !== 'draw'); 
            const targets = filtered.slice(0, count); 
            const textarea = document.getElementById('exportTextarea'); 
            if (!textarea) return; 
            if (targets.length === 0) { 
                textarea.value = `[${targetSeason}] ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.`; 
                return; 
            } 
            const processedTargets = targets.map(m => { 
                let dateStr = m.date; 
                try { 
                    const parts = dateStr.split('-'); 
                    if (parts.length === 3) { 
                        const month = parseInt(parts[1], 10); 
                        const day = parseInt(parts[2], 10); 
                        dateStr = `${month}ì›” ${day}ì¼`; 
                    } 
                } catch(e) {} 
                return { ...m, dateLabel: dateStr }; 
            }); 
            const dateCounts = processedTargets.reduce((acc, m) => { 
                acc[m.dateLabel] = (acc[m.dateLabel] || 0) + 1; 
                return acc; 
            }, {}); 
            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
            let result = ""; 
            let currentDate = ""; 
            processedTargets.forEach(m => { 
                if (m.dateLabel !== currentDate) { 
                    if (result !== "") result += "\n"; 
                    result += `ğŸ“… ${m.dateLabel} (ì´ ${dateCounts[m.dateLabel]}ê²½ê¸°)\n`; 
                    currentDate = m.dateLabel; 
                } 
                const getPlayerLabel = (name) => { 
                    if (hideRank) return name; 
                    const p = rankingsData.find(x => x.name === name); 
                    if (!p) return `${name}(?)`; 
                    return getPlayerStatusLabel(p, realRankList); 
                }; 
                result += `${getPlayerLabel(m.winner)} VS ${getPlayerLabel(m.loser)}\n`; 
            }); 
            textarea.value = result; 
        };

        window.copyExportText = () => { 
            const textarea = document.getElementById('exportTextarea'); 
            if (!textarea) return; 
            textarea.select(); 
            try { 
                const successful = document.execCommand('copy'); 
                if(successful) { 
                    showCustomAlert("âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); 
                } else { 
                    throw new Error('Copy failed'); 
                } 
            } catch (err) { 
                showCustomAlert("ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”."); 
            } 
        };

        window.updateRankerExport = (type) => { 
            const rankers = rankingsData.filter(p => (p.wins + p.losses) > 0).sort((a, b) => { 
                const aTotal = (a.wins || 0) + (a.losses || 0); 
                const bTotal = (b.wins || 0) + (b.losses || 0); 
                const aIsRanked = aTotal >= 3; 
                const bIsRanked = bTotal >= 3; 
                if (aIsRanked && !bIsRanked) return -1; 
                if (!aIsRanked && bIsRanked) return 1; 
                return (b.elo || 1000) - (a.elo || 1000); 
            }); 
            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
            let text = ""; 
            if (type === 'rank') { 
                text = rankers.map(p => getPlayerStatusLabel(p, realRankList)).join('\n'); 
            } else if (type === 'id') { 
                text = rankers.map(p => `${p.name} ${p.gameId || '-'}`).join('\n'); 
            } else { 
                text = rankers.map(p => `${p.name} ${p.trunkColor || '#1f2937'}`).join('\n'); 
            } 
            const textarea = document.getElementById('exportTextarea'); 
            if(textarea) textarea.value = text; 
        };

        window.updateAllPlayerExport = (type) => { 
            const allPlayers = [...rankingsData].sort((a, b) => a.name.localeCompare(b.name)); 
            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
            let text = ""; 
            if (type === 'name') { 
                text = allPlayers.map(p => p.name).join('\n'); 
            } else if (type === 'status') { 
                text = allPlayers.map(p => getPlayerStatusLabel(p, realRankList)).join('\n'); 
            } else if (type === 'id') { 
                text = allPlayers.map(p => `${p.name} ${p.gameId || '-'}`).join('\n'); 
            } else { 
                text = allPlayers.map(p => `${p.name} ${p.trunkColor || '#1f2937'}`).join('\n'); 
            } 
            const textarea = document.getElementById('exportTextarea'); 
            if(textarea) textarea.value = text; 
        };

        window.copyRankerList = () => { 
            try { 
                if (!rankingsData || rankingsData.length === 0) return showCustomAlert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."); 
                const rankers = rankingsData.filter(p => (p.wins + p.losses) > 0); 
                if (rankers.length === 0) return showCustomAlert("ë­í‚¹ì— ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."); 
                const modal = document.getElementById('exportModal'); 
                if (modal) modal.classList.remove('hidden'); 
                const title = document.getElementById('exportModalTitle'); 
                if (title) title.textContent = "ğŸ† ë­ì»¤ ëª…ë‹¨ ì¶”ì¶œ"; 
                const options = document.getElementById('exportMatchOptions'); 
                if (options) { 
                    options.classList.remove('hidden'); 
                    options.innerHTML = `<button onclick="updateRankerExport('rank')" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">ğŸ”¢ ìˆœìœ„ (ì´ë¦„+ìˆœìœ„/ë°°ì¹˜)</button><button onclick="updateRankerExport('id')" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-2 rounded-lg text-xs transition border border-emerald-100">ğŸ†” ID (ì´ë¦„+ID)</button><button onclick="updateRankerExport('color')" class="flex-1 bg-purple-50 text-purple-600 hover:bg-purple-100 font-bold py-2 rounded-lg text-xs transition border border-purple-100">ğŸ¨ ìƒ‰ìƒ (ì´ë¦„+ìƒ‰ìƒ)</button>`; 
                } 
                updateRankerExport('rank'); 
            } catch (e) { 
                showCustomAlert("ëª…ë‹¨ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
            } 
        };

        window.copyAllPlayerList = () => { 
            try { 
                if (!rankingsData || rankingsData.length === 0) return showCustomAlert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì´ê±°ë‚˜ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."); 
                if (rankingsData.length === 0) return showCustomAlert("ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤."); 
                const modal = document.getElementById('exportModal'); 
                if (modal) modal.classList.remove('hidden'); 
                const title = document.getElementById('exportModalTitle'); 
                if (title) title.textContent = "ğŸ“‹ ì „ì²´ ì„ ìˆ˜ ëª…ë‹¨ ì¶”ì¶œ"; 
                const options = document.getElementById('exportMatchOptions'); 
                if (options) { 
                    options.classList.remove('hidden'); 
                    options.innerHTML = `<div class="grid grid-cols-2 gap-2 w-full"><button onclick="updateAllPlayerExport('name')" class="bg-slate-50 text-slate-600 hover:bg-slate-100 font-bold py-2 rounded-lg text-xs transition border border-slate-200">ğŸ“‹ ê¸°ë³¸ (ì´ë¦„ë§Œ)</button><button onclick="updateAllPlayerExport('status')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">ğŸ“Š í˜„í™© (ì´ë¦„+êµ¬ë¶„)</button><button onclick="updateAllPlayerExport('id')" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-2 rounded-lg text-xs transition border border-emerald-100">ğŸ†” ID (ì´ë¦„+ID)</button><button onclick="updateAllPlayerExport('color')" class="bg-purple-50 text-purple-600 hover:bg-purple-100 font-bold py-2 rounded-lg text-xs transition border border-purple-100">ğŸ¨ ìƒ‰ìƒ (ì´ë¦„+ìƒ‰ìƒ)</button></div>`; 
                } 
                updateAllPlayerExport('name'); 
            } catch (e) { 
                showCustomAlert("ëª…ë‹¨ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); 
            } 
        };
        // --- ë³µì›ëœ í•¨ìˆ˜ ì˜ì—­ ë ---
        
        window.backupData = () => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ rankings: rankingsData, history: matchHistoryData, archives: seasonArchives, activeSeason: activeSeason }, null, 2)); const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `RFC_BACKUP_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(dl); dl.click(); dl.remove(); };
        function captureState() { const currentState = { rankings: JSON.parse(JSON.stringify(rankingsData)), matchHistory: JSON.parse(JSON.stringify(matchHistoryData)), seasonArchives: JSON.parse(JSON.stringify(seasonArchives)), activeSeason: activeSeason }; undoStack.push(currentState); if (undoStack.length > MAX_UNDO) undoStack.shift(); updateUndoUI(); }
        window.executeUndo = async () => { if (undoStack.length === 0) return; const prevState = undoStack.pop(); rankingsData = prevState.rankings; matchHistoryData = prevState.matchHistory; seasonArchives = prevState.seasonArchives; activeSeason = prevState.activeSeason; await saveRankings(true); renderRankings(); updateUndoUI(); alert("ì´ì „ ìƒíƒœë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤."); };
        function updateUndoUI() { const btn = document.getElementById('undoBtn'); const cnt = document.getElementById('undoCount'); if (undoStack.length > 0) { btn.classList.remove('hidden'); btn.classList.add('pop-in'); btn.disabled = false; cnt.textContent = undoStack.length; } else { btn.classList.add('hidden'); } }
        window.saveRankings = async function(isUndo = false) { const statusEl = document.getElementById('saveStatus'); const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); try { await runTransaction(db, async (transaction) => { const sfDoc = await transaction.get(docRef); if (!sfDoc.exists()) throw "Document does not exist!"; const payload = { rankings: rankingsData, matchHistory: matchHistoryData, seasonArchives: seasonArchives, activeSeason: activeSeason, date: new Date().toISOString() }; if(!isUndo) { payload.adminMemos = adminMemos; payload.ruleHtml = ruleHtml; } transaction.update(docRef, payload); }); statusEl.style.opacity = 1; setTimeout(() => statusEl.style.opacity = 0, 2000); } catch (e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); } }
        window.saveRules = () => { ruleHtml = document.getElementById('ruleHtmlInput').value; saveRankings(); alert("ê·œì¹™ ë””ìì¸ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."); };
        window.loadDefaultRuleHtml = () => { if(confirm("ê¸°ë³¸ ì˜ˆìœ ë””ìì¸ìœ¼ë¡œ ë˜ëŒë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?")) { document.getElementById('ruleHtmlInput').value = LATEST_RULE_HTML; } };
        window.addMemo = () => { const input = document.getElementById('newMemoInput'); const content = input.value.trim(); if (!content) return; adminMemos.unshift({ id: Date.now(), content: content, date: new Date().toLocaleString() }); input.value = ''; saveRankings(); renderMemos(); };
        window.deleteMemo = (id) => { if(!confirm("ì‚­ì œ?")) return; adminMemos = adminMemos.filter(m => m.id !== id); saveRankings(); renderMemos(); };
        window.switchTab = (tab) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById(tab + 'Section').classList.remove('hidden'); document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active'); };
        window.deleteSeason = (targetName) => { if (targetName === activeSeason) return showCustomAlert("í˜„ì¬ í™œì„± ì‹œì¦Œì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); showConfirmModal(`[${targetName}] ë° í•´ë‹¹ ì‹œì¦Œì˜ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => { captureState(); delete seasonArchives[targetName]; matchHistoryData = matchHistoryData.filter(m => m.season !== targetName); await saveRankings(); renderSeasonList(); showCustomAlert("ì‹œì¦Œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); }); };
        window.switchActiveSeason = (targetName) => { showConfirmModal(`[${targetName}] ì‹œì¦Œìœ¼ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async () => { captureState(); seasonArchives[activeSeason] = { rankings: JSON.parse(JSON.stringify(rankingsData)) }; const t = seasonArchives[targetName]; if (t) rankingsData = t.rankings || []; delete seasonArchives[targetName]; activeSeason = targetName; viewHistorySeason = activeSeason; await saveRankings(); updateSeasonUI(); renderSeasonList(); renderRankings(); updateAdminHistorySeasonSelector(); renderAdminMatches(); showCustomAlert("ì‹œì¦Œì´ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤."); }); };
        window.openRenameModal = (oldName) => { document.getElementById('renameOldName').value = oldName; document.getElementById('renameInput').value = oldName; document.getElementById('renameModal').classList.remove('hidden'); setTimeout(() => document.getElementById('renameInput').focus(), 50); };
        window.closeRenameModal = () => { document.getElementById('renameModal').classList.add('hidden'); };
        window.confirmRenameSeason = async () => { const oldName = document.getElementById('renameOldName').value; const newName = document.getElementById('renameInput').value.trim(); if(!newName || newName === oldName) { closeRenameModal(); return; } if(newName === activeSeason || seasonArchives[newName]) { showCustomAlert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‹œì¦Œ ì´ë¦„ì…ë‹ˆë‹¤."); return; } captureState(); if (oldName === activeSeason) { activeSeason = newName; if (seasonArchives[oldName]) delete seasonArchives[oldName]; } else { seasonArchives[newName] = seasonArchives[oldName]; delete seasonArchives[oldName]; } matchHistoryData.forEach(m => { if(m.season === oldName) m.season = newName; }); await saveRankings(); renderSeasonList(); updateSeasonUI(); closeRenameModal(); showCustomAlert("ì‹œì¦Œ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); };
        window.renameSeason = window.openRenameModal; 
        window.finishAndStartNewSeason = () => { const n = document.getElementById('newSeasonNameInput').value.trim(); if(!n) return showCustomAlert("ìƒˆ ì‹œì¦Œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); if(n === activeSeason || seasonArchives[n]) return showCustomAlert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‹œì¦Œ ì´ë¦„ì…ë‹ˆë‹¤."); showConfirmModal(`[${activeSeason}]ì„ ì¢…ë£Œí•˜ê³  [${n}]ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- í˜„ì¬ ë­í‚¹ì€ ë³´ê´€í•¨ì— ì €ì¥ë©ë‹ˆë‹¤.\n- ëª¨ë“  ì„ ìˆ˜ì˜ ì „ì ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.`, async () => { captureState(); seasonArchives[activeSeason] = { rankings: JSON.parse(JSON.stringify(rankingsData)) }; activeSeason = n; rankingsData.forEach(p => { p.previousRank = p.rank || rankingsData.indexOf(p) + 1; p.wins = 0; p.losses = 0; p.draws = 0; p.defenseCount = 0; p.elo = 1000; }); viewHistorySeason = activeSeason; await saveRankings(); updateSeasonUI(); renderSeasonList(); renderRankings(); updateAdminHistorySeasonSelector(); renderAdminMatches(); showCustomAlert(`ìƒˆ ì‹œì¦Œ [${n}]ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!`); }); };

        window.openDeletePlayersModal = () => {
            deleteSelectedIds.clear();
            document.getElementById('deleteSearchInput').value = '';
            document.getElementById('deleteAllCheckbox').checked = false;
            document.getElementById('deleteHistoryCheckbox').checked = false;
            document.getElementById('deletePlayersModal').classList.remove('hidden');
            window.renderDeleteList();
        };

        window.closeDeletePlayersModal = () => {
            document.getElementById('deletePlayersModal').classList.add('hidden');
        };

        window.renderDeleteList = () => {
            const listContainer = document.getElementById('deletePlayerList');
            const badge = document.getElementById('deleteCountBadge');
            const query = document.getElementById('deleteSearchInput').value.toLowerCase().replace(/\s/g, "");
            const queryJamo = Hangul.disassemble(query);
            
            listContainer.innerHTML = '';
            
            const filteredPlayers = rankingsData.filter(p => {
                const nameClean = p.name.replace(/\s/g, "").toLowerCase();
                if (nameClean.includes(query)) return true;
                if (p.choseong && (p.choseong.includes(query) || p.choseong.includes(queryJamo))) return true;
                if (p.jamo && p.jamo.includes(queryJamo)) return true;
                return false;
            }).sort((a, b) => a.name.localeCompare(b.name));

            if (filteredPlayers.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-xs text-slate-400 py-6">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
            } else {
                filteredPlayers.forEach(p => {
                    const isChecked = deleteSelectedIds.has(p.id) ? 'checked' : '';
                    const totalMatches = (p.wins || 0) + (p.losses || 0);
                    
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-2 bg-white rounded border border-slate-100 hover:bg-slate-50 transition cursor-pointer";
                    div.onclick = (e) => {
                        if(e.target.tagName !== 'INPUT') {
                            const cb = div.querySelector('input[type="checkbox"]');
                            cb.checked = !cb.checked;
                            window.toggleDeleteSelection(p.id, cb.checked);
                        }
                    };
                    
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <input type="checkbox" value="${p.id}" class="w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500" ${isChecked} onchange="window.toggleDeleteSelection('${p.id}', this.checked)">
                            <div class="flex items-center gap-2">
                                <img src="${p.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-8 h-8 rounded bg-slate-100 object-cover border border-slate-200" onerror="this.src='https://placehold.co/150?text=No+Img'">
                                <div>
                                    <div class="font-bold text-sm text-slate-700">${p.name}</div>
                                    <div class="text-[10px] text-slate-400">${totalMatches}ì „ | ${p.elo}ì </div>
                                </div>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
            
            badge.textContent = `${deleteSelectedIds.size}ëª… ì„ íƒë¨`;
            
            const allCheckbox = document.getElementById('deleteAllCheckbox');
            if (filteredPlayers.length > 0 && Array.from(filteredPlayers).every(p => deleteSelectedIds.has(p.id))) {
                allCheckbox.checked = true;
            } else {
                allCheckbox.checked = false;
            }
        };

        window.toggleDeleteSelection = (id, isChecked) => {
            if (isChecked) deleteSelectedIds.add(id);
            else deleteSelectedIds.delete(id);
            document.getElementById('deleteCountBadge').textContent = `${deleteSelectedIds.size}ëª… ì„ íƒë¨`;
        };

        window.toggleDeleteSelectAll = () => {
            const isChecked = document.getElementById('deleteAllCheckbox').checked;
            const query = document.getElementById('deleteSearchInput').value.toLowerCase().replace(/\s/g, "");
            const queryJamo = Hangul.disassemble(query);
            
            const filteredPlayers = rankingsData.filter(p => {
                const nameClean = p.name.replace(/\s/g, "").toLowerCase();
                if (nameClean.includes(query)) return true;
                if (p.choseong && (p.choseong.includes(query) || p.choseong.includes(queryJamo))) return true;
                if (p.jamo && p.jamo.includes(queryJamo)) return true;
                return false;
            });

            filteredPlayers.forEach(p => {
                if (isChecked) deleteSelectedIds.add(p.id);
                else deleteSelectedIds.delete(p.id);
            });
            
            window.renderDeleteList();
        };

        window.confirmDeletePlayers = () => {
            if (deleteSelectedIds.size === 0) return showCustomAlert("ì‚­ì œí•  ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            
            const deleteHistory = document.getElementById('deleteHistoryCheckbox').checked;
            const msg = `ì •ë§ ${deleteSelectedIds.size}ëª…ì˜ ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ì´ ì‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.${deleteHistory ? '\n- ê´€ë ¨ëœ ê³¼ê±° ê²½ê¸° ë¡œê·¸ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.' : ''}`;
            
            showConfirmModal(msg, async () => {
                captureState();
                const deletedNames = new Set();
                
                rankingsData = rankingsData.filter(p => {
                    if (deleteSelectedIds.has(p.id)) {
                        deletedNames.add(p.name);
                        return false;
                    }
                    return true;
                });
                
                if (deleteHistory) {
                    matchHistoryData = matchHistoryData.filter(m => {
                        return !deletedNames.has(m.winner) && !deletedNames.has(m.loser);
                    });
                }
                
                await saveRankings();
                renderRankings();
                if (typeof checkSeasonInactive === 'function') checkSeasonInactive();
                if (typeof enrichMatchHistory === 'function') enrichMatchHistory();
                if (typeof renderAdminMatches === 'function') renderAdminMatches();
                
                window.closeDeletePlayersModal();
                showCustomAlert(`âœ… ${deletedNames.size}ëª…ì˜ ì„ ìˆ˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            });
        };

        window.openNewPlayerModal = () => { const modal = document.getElementById('newPlayerModal'); if (modal) { modal.classList.remove('hidden'); setTimeout(() => document.getElementById('newPlayerNameInput').focus(), 50); } };
        window.showCustomAlert = (message) => { document.getElementById('alertMessage').innerText = message; document.getElementById('customAlertModal').classList.remove('hidden'); };
        window.closeAlertModal = () => { document.getElementById('customAlertModal').classList.add('hidden'); };
        window.confirmNewPlayer = async () => { const input = document.getElementById('newPlayerNameInput'); const name = input.value.trim(); if (!name) return showCustomAlert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); if (rankingsData.some(p => p.name === name)) { showCustomAlert(`âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹‰ë„¤ì„ì…ë‹ˆë‹¤: [${name}]\në‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.`); return; } const randomPin = Math.floor(1000 + Math.random() * 9000).toString(); const hashedPin = await hashPin(randomPin); captureState(); const today = getKSTDate(); const newId = generateUUID(); rankingsData.push({ id: newId, name, wins: 0, losses: 0, defenseCount: 0, previousRank: rankingsData.length + 1, careerHighRank: rankingsData.length + 1, elo: 1000, careerHighElo: 1000, lastMatchDate: today, password: hashedPin, trunkColor: '#1f2937' }); await saveRankings(); renderRankings(); document.getElementById('newPlayerModal').classList.add('hidden'); input.value = ''; showCustomAlert(`âœ… [${name}] ì„ ìˆ˜ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì´ˆê¸° ë¹„ë°€ë²ˆí˜¸: ${randomPin}\n(ì €ì¥ì€ ì•”í˜¸í™”ë˜ì–´ ë©ë‹ˆë‹¤)\n\nì„ ìˆ˜ì—ê²Œ ì´ ë²ˆí˜¸ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`); };
        
        window.updateRankBaseline = () => { showConfirmModal("ğŸ“‰ ìˆœìœ„ ë³€ë™í­(â–²â–¼)ì„ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ìˆœìœ„ê°€ ê¸°ì¤€ì´ ë˜ì–´ ë³€ë™í­ì´ 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.", async () => { captureState(); const rankedList = rankingsData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); rankedList.forEach((p, index) => { p.previousRank = index + 1; }); await saveRankings(); renderRankings(); setTimeout(() => showCustomAlert("ìˆœìœ„ ë³€ë™í­ì´ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤."), 100); }); };
        
        window.applyManualPenalty = () => { let idx = null; if (pPenTom) idx = pPenTom.getValue(); else { const el = document.getElementById('penaltyTargetSelect'); if(el) idx = el.value; } if (idx === "" || idx === null || idx === undefined) return showCustomAlert("íŒ¨ë„í‹°ë¥¼ ë¶€ì—¬í•  ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); const intIdx = parseInt(idx, 10); const p = rankingsData[intIdx]; if (!p) return showCustomAlert("ì„ ìˆ˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); const confirmMsg = `ğŸ’€ íŒ¨ë„í‹° ì‹¤í–‰ í™•ì¸\n\n[${p.name}] ì„ ìˆ˜ì—ê²Œ -30ì ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.\n\nğŸ“Š ì˜ˆìƒ ê²°ê³¼\nâ€¢ ê¸°ì¡´ ì ìˆ˜: ${p.elo}ì \nâ€¢ ì°¨ê° ì ìš©: -30ì \nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâ€¢ ìµœì¢… ì ìˆ˜: ${p.elo - 30}ì \n\nì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`; showConfirmModal(confirmMsg, async () => { captureState(); p.elo -= 30; rankingsData.sort((a, b) => b.elo - a.elo); await saveRankings(); renderRankings(); if(pPenTom) pPenTom.clear(); else document.getElementById('penaltyTargetSelect').value = ""; showCustomAlert(`[${p.name}] -30ì  ì°¨ê° ì™„ë£Œ.\ní˜„ì¬ ì ìˆ˜: ${p.elo}`); }); };

        window.resetBatchInactiveForm = () => { document.getElementById('inactiveDaysInput').value = 30; document.getElementById('penaltyScoreInput').value = 30; document.getElementById('inactiveListArea').classList.add('hidden'); document.getElementById('inactiveUserList').innerHTML = ''; batchPenaltyTargets = []; };
        window.checkBatchInactiveUsers = () => { const daysInput = document.getElementById('inactiveDaysInput'); const scoreInput = document.getElementById('penaltyScoreInput'); const days = parseInt(daysInput.value) || 30; const score = parseInt(scoreInput.value) || 30; const today = new Date(getKSTDate()); const rankedPlayers = rankingsData.filter(p => (p.wins + p.losses) > 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); batchPenaltyTargets = []; const listEl = document.getElementById('inactiveUserList'); listEl.innerHTML = ''; rankingsData.forEach(p => { const totalMatches = (p.wins || 0) + (p.losses || 0); if (totalMatches === 0) return; if(!p.lastMatchDate) return; const last = new Date(p.lastMatchDate); const diffTime = today - last; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(diffDays >= days) { const rank = rankedPlayers.findIndex(rp => rp.id === p.id) + 1; batchPenaltyTargets.push({ ...p, diffDays, rank }); } }); batchPenaltyTargets.sort((a, b) => b.diffDays - a.diffDays); const area = document.getElementById('inactiveListArea'); if(batchPenaltyTargets.length > 0) { document.getElementById('inactiveCountDisplay').textContent = batchPenaltyTargets.length; batchPenaltyTargets.forEach(t => { const li = document.createElement('li'); li.className = "flex justify-between items-center border-b border-slate-50 last:border-0 pb-1 mb-1 last:pb-0 last:mb-0"; li.innerHTML = `<div class="flex items-center gap-1.5"><span class="text-[10px] font-black text-blue-600 min-w-[24px] text-right">#${t.rank}</span><span class="font-bold text-slate-700">${t.name}</span><span class="text-[10px] bg-slate-100 text-slate-500 px-1 rounded">${t.elo}ì </span></div><span class="text-red-500 font-bold text-[10px]">${t.diffDays}ì¼ ì „</span>`; listEl.appendChild(li); }); const btn = document.getElementById('btnApplyBatchPenalty'); btn.innerHTML = `<span>ğŸ’€</span> ì¼ê´„ -${score}ì  ì ìš©í•˜ê¸°`; btn.onclick = () => confirmBatchPenalty(days, score); area.classList.remove('hidden'); area.classList.add('pop-in'); } else { area.classList.add('hidden'); showCustomAlert(`${days}ì¼ ì´ìƒ ë¯¸ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.\n(ì „ì  0íšŒ ë° Unranked ì œì™¸)`); } };
        window.confirmBatchPenalty = (days, score) => { const count = batchPenaltyTargets.length; if(count === 0) return; const msg = `ğŸ’€ ì¥ê¸° ë¯¸ì°¸ì—¬ì ì¼ê´„ íŒ¨ë„í‹°\n\nê¸°ì¤€: ${days}ì¼ ì´ìƒ ë¯¸ì°¸ì—¬\nëŒ€ìƒ: ì´ ${count}ëª…\në‚´ìš©: ì „ì› ELO -${score}ì  ì°¨ê°\n\nì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`; showConfirmModal(msg, async () => { captureState(); const targetIds = new Set(batchPenaltyTargets.map(t => t.id)); rankingsData.forEach(p => { if(targetIds.has(p.id)) { p.elo -= score; } }); rankingsData.sort((a, b) => b.elo - a.elo); await saveRankings(); renderRankings(); document.getElementById('inactiveListArea').classList.add('hidden'); batchPenaltyTargets = []; showCustomAlert(`âœ… ${count}ëª…ì—ê²Œ -${score}ì  íŒ¨ë„í‹°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`); }); };
window.fixDataIntegrity = () => { 
    const rankedPlayers = rankingsData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
    let fixedRankCount = 0; 
    let fixedDateCount = 0; 
    const threshold = 15; 
    rankingsData.forEach(p => { 
        const total = (p.wins || 0) + (p.losses || 0); 
        if (total >= 3) { 
            const realRank = rankedPlayers.findIndex(rp => rp.id === p.id) + 1; 
            const prev = p.previousRank || 999; 
            if (Math.abs(prev - realRank) >= threshold || prev > rankedPlayers.length + 5) { 
                p.previousRank = realRank; fixedRankCount++; 
            } 
        } 
        if (total === 3 && !p.rankInDate && p.lastMatchDate) { 
            p.rankInDate = p.lastMatchDate; fixedDateCount++; 
        } 
    }); 
    
    // [ì‚­ì œ] ë² í…Œë‘ í˜„ìƒê¸ˆ ë³µêµ¬ ë¡œì§ ì œê±°ë¨

    if (fixedRankCount > 0 || fixedDateCount > 0) { 
        captureState(); saveRankings(); renderRankings(); showCustomAlert(`âœ… ë°ì´í„° ë³´ì • ì™„ë£Œ\n\n- ìˆœìœ„ ë³€ë™í­ ì •ìƒí™”: ${fixedRankCount}ëª…\n- New ë±ƒì§€(ë‚ ì§œ) ë³µêµ¬: ${fixedDateCount}ëª…`); 
    } else { 
        showCustomAlert("ë³´ì •í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nëª¨ë“  ë°ì´í„°ê°€ ì •ìƒì…ë‹ˆë‹¤."); 
    } 
};        
        window.resetAllStats = () => { if (!rankingsData || rankingsData.length === 0) return showCustomAlert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); const msg = `ğŸ“Š [${activeSeason}] ì „ì  ì´ˆê¸°í™” í™•ì¸\n\ní˜„ì¬ ì‹œì¦Œì˜ ë‹¤ìŒ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\n1. ëª¨ë“  ì„ ìˆ˜ì˜ ìŠ¹/íŒ¨/ë¬´/ë°©ì–´ì „ íšŸìˆ˜ (0ìœ¼ë¡œ ì´ˆê¸°í™”)\n2. í˜„ì¬ ì‹œì¦Œì˜ ê²½ê¸° ê¸°ë¡ ë¡œê·¸ (ì „ì²´ ì‚­ì œ)\n\n(ì£¼ì˜: ELO ì ìˆ˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)\n\nì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`; showConfirmModal(msg, async () => { try { captureState(); rankingsData.forEach(p => { p.wins = 0; p.losses = 0; p.draws = 0; p.defenseCount = 0; }); matchHistoryData = matchHistoryData.filter(m => m.season !== activeSeason); await saveRankings(); renderRankings(); enrichMatchHistory(); updateAdminHistorySeasonSelector(); renderAdminMatches(); showCustomAlert("âœ… í˜„ì¬ ì‹œì¦Œ ì „ì ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch (e) { showCustomAlert("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message); } }); };
        window.resetAllElo = () => { if (!rankingsData || rankingsData.length === 0) return showCustomAlert("ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); showConfirmModal(`âš¡ [${activeSeason}] ELO ì´ˆê¸°í™” í™•ì¸\n\ní˜„ì¬ ì‹œì¦Œì˜ ëª¨ë“  ì„ ìˆ˜ ì ìˆ˜ë¥¼\n[1000ì ]ìœ¼ë¡œ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì£¼ì˜: ì „ì  íšŸìˆ˜ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)`, async () => { captureState(); rankingsData.forEach(p => { p.elo = 1000; p.careerHighElo = 1000; }); await saveRankings(); renderRankings(); showCustomAlert("ëª¨ë“  ì„ ìˆ˜ì˜ ELOê°€ 1000ì ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); }); };
        window.resetEverything = () => { showConfirmModal("ğŸš¨ ì‹œìŠ¤í…œ ì „ì²´ë¥¼ ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n- ëª¨ë“  ì‹œì¦Œ ê¸°ë¡ ì‚­ì œ\n- ëª¨ë“  ì„ ìˆ˜ ìŠ¤íƒ¯ ì´ˆê¸°í™”\n- ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", async () => { matchHistoryData = []; seasonArchives = {}; activeSeason = "ì‹œì¦Œ 1"; rankingsData.forEach(p => { p.wins=0; p.losses=0; p.defenseCount=0; p.elo=1000; p.careerHighElo=1000; }); await saveRankings(); location.reload(); }); };
        window.resetAllPasswords = async () => { if (!confirm("âš ï¸ ì •ë§ ëª¨ë“  ì„ ìˆ˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¬ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n1. ëª¨ë“  ì„ ìˆ˜ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ëœë¤í•œ 4ìë¦¬ ìˆ«ìë¡œ ë³€ê²½ë©ë‹ˆë‹¤.\n2. ë³€ê²½ëœ ëª…ë‹¨(ì´ë¦„: ë²ˆí˜¸)ì´ ê´€ë¦¬ìì˜ í´ë¦½ë³´ë“œì— ìë™ ë³µì‚¬ë©ë‹ˆë‹¤.\n3. ë‹¨í†¡ë°© ë“±ì— ë°”ë¡œ ë¶™ì—¬ë„£ê¸° í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")) return; captureState(); let reportList = "ğŸ“¢ [RFC] ë¹„ë°€ë²ˆí˜¸ ì „ì²´ ì´ˆê¸°í™” ëª…ë‹¨\n(ê°œì¸ ì •ë³´ì´ë¯€ë¡œ ë³¸ì¸ ê²ƒë§Œ í™•ì¸í•˜ì„¸ìš”)\n\n"; const updatePromises = rankingsData.map(async (p) => { const plainPin = Math.floor(1000 + Math.random() * 9000).toString(); reportList += `${p.name}: ${plainPin}\n`; p.password = await hashPin(plainPin); }); await Promise.all(updatePromises); await saveRankings(); try { await navigator.clipboard.writeText(reportList); alert("âœ… ì „ì²´ ë¹„ë°€ë²ˆí˜¸ê°€ ì¬ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nëª…ë‹¨ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\në‹¨í†¡ë°©ì— 'ë¶™ì—¬ë„£ê¸°' í•˜ì„¸ìš”."); } catch (err) { alert("ì¬ë°œê¸‰ì€ ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë¸Œë¼ìš°ì € ê¶Œí•œ ë¬¸ì œ)"); } };
        window.resetIndividualPassword = async () => { const randomPin = Math.floor(1000 + Math.random() * 9000).toString(); const pwInput = document.getElementById('editPassword'); if(pwInput) pwInput.value = randomPin; try { await navigator.clipboard.writeText(randomPin); alert(`âœ… ìƒˆ ë¹„ë°€ë²ˆí˜¸ [${randomPin}] ìƒì„± ì™„ë£Œ!\n\ní´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.\nê¼­ í•˜ë‹¨ì˜ [ì €ì¥í•˜ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.`); } catch (err) { alert(`ìƒˆ ë¹„ë°€ë²ˆí˜¸: ${randomPin}\n(ë³µì‚¬ ì‹¤íŒ¨, ìˆ˜ë™ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”)\n\nê¼­ [ì €ì¥í•˜ê¸°]ë¥¼ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤.`); } };
        function checkSeasonInactive() { const list = document.getElementById('seasonInactiveList'); list.innerHTML = ''; const m = matchHistoryData.filter(m => m.season === activeSeason); const an = new Set(); m.forEach(m => { an.add(m.winner); an.add(m.loser); }); const inact = rankingsData.filter(p => !an.has(p.name)); document.getElementById('seasonInactiveCount').textContent = inact.length + "ëª…"; inact.forEach(p => { list.innerHTML += `<li>${p.name}</li>`; }); }
        window.toggleInactiveList = () => document.getElementById('seasonInactiveList').classList.toggle('hidden');
        let confirmCallback = null;
        window.showConfirmModal = (message, callback) => { document.getElementById('confirmMessage').innerText = message; document.getElementById('customConfirmModal').classList.remove('hidden'); confirmCallback = callback; };
        window.closeConfirmModal = () => { document.getElementById('customConfirmModal').classList.add('hidden'); confirmCallback = null; };
        document.getElementById('confirmOkBtn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmModal(); });
window.openEditModal = (index) => { 
    const p = rankingsData[index]; 
    if (!p) return; 
    
    // ê¸°ë³¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    document.getElementById('editPlayerId').value = p.id; 
    document.getElementById('editOriginalName').value = p.name; 
    document.getElementById('editName').value = p.name || ""; 
    document.getElementById('editGameId').value = p.gameId || ""; 
    
    // [ì¤‘ìš”] ìŠ¤íƒ¯ ë° í˜„ìƒê¸ˆ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ ë¶€ë¶„ì´ ì—†ìœ¼ë©´ ì´ì „ ê°’ì´ ë‚¨ìŠµë‹ˆë‹¤)
    document.getElementById('editElo').value = p.elo || 1000; 
    document.getElementById('editWins').value = p.wins || 0; 
    document.getElementById('editLosses').value = p.losses || 0; 
    
    // â–¼â–¼â–¼ ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ì…ë‹ˆë‹¤ â–¼â–¼â–¼
    // ì„ ìˆ˜ì˜ í˜„ìƒê¸ˆ(bounty)ì´ ìˆìœ¼ë©´ ê°€ì ¸ì˜¤ê³ , ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì´ˆê¸°í™”
    document.getElementById('editBounty').value = (p.bounty !== undefined) ? p.bounty : 0;
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

    const imgUrl = p.imageUrl || ""; 
    document.getElementById('editImageUrlInput').value = imgUrl; 
    window.updatePreview(imgUrl); 
    document.getElementById('editHeight').value = p.height || ""; 
    document.getElementById('editReach').value = p.reach || ""; 
    document.getElementById('editStance').value = p.stance || "Orthodox"; 
    
    // ìƒ‰ìƒ ì„ íƒ ë¡œì§
    const tColor = p.trunkColor || '#1f2937'; 
    document.getElementById('editTrunkColor').value = tColor; 
    const allPresets = document.querySelectorAll('.color-preset'); 
    let matched = false; 
    allPresets.forEach(el => { 
        const presetColor = el.dataset.color; 
        el.classList.remove('active'); 
        if (presetColor && presetColor.toLowerCase() === tColor.toLowerCase()) { 
            el.classList.add('active'); matched = true; 
        } 
    }); 
    if (!matched) { 
        const firstCustom = document.querySelector('.custom-picker-slot'); 
        if (firstCustom) { 
            firstCustom.style.backgroundColor = tColor; 
            firstCustom.dataset.color = tColor; 
            firstCustom.classList.add('active'); 
            const input = firstCustom.querySelector('input[type="color"]'); 
            if(input) input.value = tColor; 
        } 
    } 
    
    document.getElementById('editPassword').value = ""; 
    
    // ìŠ¤íƒ€ì¼ íƒœê·¸ ë¡œì§
    const container = document.getElementById('styleTagsContainer'); 
    container.innerHTML = ''; 
    const currentStyles = p.tags || []; 
    STYLE_OPTIONS.forEach(style => { 
        const checked = currentStyles.includes(style) ? 'checked' : ''; 
        const id = `style_${style}`; 
        container.innerHTML += `<div><input type="checkbox" id="${id}" value="${style}" class="hidden style-checkbox" ${checked}><label for="${id}" class="cursor-pointer inline-block bg-white border border-slate-200 text-slate-500 px-3 py-1.5 rounded-full text-xs font-bold transition select-none hover:bg-slate-50">${style}</label></div>`; 
    }); 
    
    document.getElementById('editModal').classList.remove('hidden'); 
};        
        window.updatePreview = (url) => { const img = document.getElementById('previewImage'); if (!url) { img.src = "https://placehold.co/150?text=No+Img"; } else { img.src = url; } };
        window.removeImage = () => { document.getElementById('editImageUrlInput').value = ""; window.updatePreview(""); };
        window.savePlayerDetails = async () => { 
    const id = document.getElementById('editPlayerId').value; if (!id) return; 
    const index = rankingsData.findIndex(r => r.id === id); if (index === -1) return showCustomAlert("ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); 
    const p = rankingsData[index]; 
    const newName = document.getElementById('editName').value.trim(); if (!newName) return showCustomAlert("ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."); 
    
    captureState(); 
    
    if (newName !== p.name) { 
        if (rankingsData.some((other, i) => i !== index && other.name === newName)) { return showCustomAlert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤."); } 
        const oldName = p.name; 
        matchHistoryData.forEach(m => { if (m.winner === oldName) m.winner = newName; if (m.loser === oldName) m.loser = newName; if (m.blue === oldName) m.blue = newName; }); 
        p.name = newName; 
    } 
    
    p.gameId = document.getElementById('editGameId').value.trim(); 
    
    // [ì¤‘ìš”] ìŠ¤íƒ¯ ì €ì¥ ë¡œì§ (í˜„ìƒê¸ˆ í¬í•¨)
    p.elo = parseInt(document.getElementById('editElo').value) || 1000; 
    p.wins = parseInt(document.getElementById('editWins').value) || 0; 
    p.losses = parseInt(document.getElementById('editLosses').value) || 0; 
    
    // â–¼â–¼â–¼ ì—¬ê¸°ê°€ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„ì…ë‹ˆë‹¤ â–¼â–¼â–¼
    p.bounty = parseInt(document.getElementById('editBounty').value) || 0;
    // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²
    
    p.imageUrl = document.getElementById('editImageUrlInput').value.trim(); 
    p.height = document.getElementById('editHeight').value.trim(); 
    p.reach = document.getElementById('editReach').value.trim(); 
    p.stance = document.getElementById('editStance').value; 
    p.trunkColor = document.getElementById('editTrunkColor').value; 
    
    const newPw = document.getElementById('editPassword').value.trim(); 
    if (newPw) { p.password = await hashPin(newPw); } 
    
    const selectedStyles = []; 
    document.querySelectorAll('.style-checkbox:checked').forEach(cb => { selectedStyles.push(cb.value); }); 
    p.tags = selectedStyles; 
    
    await saveRankings(); 
    renderRankings(); 
    document.getElementById('editModal').classList.add('hidden'); 
    showCustomAlert("âœ… ì„ ìˆ˜ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); 
};
        window.tryDeletePlayer = () => { const id = document.getElementById('editPlayerId').value; if(!id) return; const index = rankingsData.findIndex(r => r.id === id); if(index === -1) return showCustomAlert("ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); const p = rankingsData[index]; showConfirmModal(`âš ï¸ ì •ë§ [${p.name}] ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, async () => { captureState(); rankingsData.splice(index, 1); await saveRankings(); document.getElementById('editModal').classList.add('hidden'); renderRankings(); setTimeout(() => alert("ì„ ìˆ˜ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."), 100); }); };
        window.deletePlayer = window.tryDeletePlayer;
        window.openProfile = (id) => { 
    currentProfileId = id; 
    const p = rankingsData.find(x => x.id === id); 
    if (!p) return; 
    const rankedPlayers = rankingsData.filter(r => (Number(r.wins || 0) + Number(r.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
    const isRank1 = rankedPlayers.length > 0 && rankedPlayers[0].id === id; 
    document.getElementById('pModalName').textContent = p.name; 
    document.getElementById('pModalCrown').classList.toggle('hidden', !isRank1); 
    document.getElementById('pModalGameId').textContent = `ID: ${p.gameId || '-'}`; 
    document.getElementById('pModalImg').src = p.imageUrl || "https://placehold.co/150?text=No+Img"; 
    const filterEl = document.getElementById('pModalSeason'); 
    filterEl.innerHTML = '<option value="all">ì „ì²´ ê¸°ë¡ (All Time)</option><option value="current">í˜„ì¬ ì‹œì¦Œ (Current)</option>'; 
    Object.keys(seasonArchives).sort().reverse().forEach(s => { filterEl.innerHTML += `<option value="${s}">${s}</option>`; }); 
    filterEl.value = 'current'; 
    filterEl.onchange = (e) => updateProfileStats(id, e.target.value); 
    const tier = getTier(p.wins, p.losses); 
    const tierEl = document.getElementById('pModalTierBadge'); 
    tierEl.textContent = tier.name; 
    tierEl.className = `text-[10px] font-bold px-2 py-0.5 rounded shadow-sm ${tier.color}`; 
    document.getElementById('pModalHeight').textContent = p.height ? p.height + 'cm' : '-'; 
    document.getElementById('pModalReach').textContent = p.reach ? p.reach + 'cm' : '-'; 
    document.getElementById('pModalStance').textContent = p.stance || '-'; 
    
    // [ì‚­ì œ] ë² í…Œë‘ í›ˆì¥ í‘œì‹œ ë¡œì§ ì œê±°ë¨
    
    const tagsContainer = document.getElementById('pModalTags'); 
    tagsContainer.innerHTML = ''; 
    (p.tags || []).forEach(tag => { tagsContainer.innerHTML += `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">#${tag}</span>`; }); 
    updateProfileStats(id, 'current'); 
    const editBtn = document.getElementById('profileEditBtn'); 
    if (editBtn) { 
        editBtn.onclick = () => { 
            closeProfile(); 
            const freshIndex = rankingsData.findIndex(r => r.id === id); 
            if (freshIndex !== -1) { openEditModal(freshIndex); } 
            else { showCustomAlert("ì„ ìˆ˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìƒˆë¡œê³ ì¹¨ ê¶Œì¥)"); } 
        }; 
    } 
    document.getElementById('profileModal').classList.remove('hidden'); 
};
        window.closeProfile = () => { document.getElementById('profileModal').classList.add('hidden'); currentProfileId = null; }
        
        window.updateProfileStats = (id, filter) => { 
            const p = rankingsData.find(x => x.id === id); 
            if (!p) return; 
            let matches = enrichedHistory.filter(m => (m.winner === p.name || m.loser === p.name) && m.type !== 'draw'); 
            if (filter === 'current') matches = matches.filter(m => m.season === activeSeason); 
            else if (filter !== 'all') matches = matches.filter(m => m.season === filter); 
            matches.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            
            let wins = 0, losses = 0; 
            matches.forEach(m => { if (m.winner === p.name) wins++; else losses++; }); 
            const total = wins + losses; 
            const winRate = total > 0 ? Math.round((wins / total) * 100) : 0; 
            
            document.getElementById('pBigWins').textContent = wins; 
            document.getElementById('pBigLosses').textContent = losses; 
            document.getElementById('pModalWinRate').textContent = `${winRate}%`; 
            document.getElementById('pModalElo').textContent = p.elo || 1000; 
            document.getElementById('pModalHighElo').textContent = p.careerHighElo || p.elo || 1000; 
            
            const container = document.getElementById('pModalMatchList'); 
            container.innerHTML = ''; 
            
            if (matches.length === 0) { 
                container.innerHTML = `<div class="text-center text-xs text-slate-400 py-4">í•´ë‹¹ ê¸°ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                return; 
            } 
            
            matches.forEach(m => { 
                const isWin = m.winner === p.name; 
                const resultText = isWin ? 'W' : 'L'; 
                const resultColor = isWin ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'; 
                const oppName = isWin ? m.loser : m.winner; 
                const oppStats = m.snapshot[oppName] || { w:0, l:0, h:[] }; 
                const oppRecordStr = `${oppStats.w}ìŠ¹ ${oppStats.l}íŒ¨`; 
                
                let oppDots = ''; 
                (oppStats.h || []).forEach(res => { 
                    if (res === 'W') oppDots += `<div class="w-1 h-1 rounded-full bg-emerald-400"></div>`; 
                    else oppDots += `<div class="w-1 h-1 rounded-full bg-rose-400"></div>`; 
                }); 
                
                let scoreBadge = ''; 
                if (isWin && m.winnerChange !== undefined) { 
                    scoreBadge = `<span class="text-[13px] font-black text-emerald-600 shrink-0">+${m.winnerChange}</span>`; 
                } else if (!isWin && m.loserChange !== undefined) { 
                    scoreBadge = `<span class="text-[13px] font-black text-rose-600 shrink-0">${m.loserChange}</span>`; 
                } 

                let oppRankBadge = '';
                const oppRankVal = isWin ? m.loserRankBefore : m.winnerRankBefore;
                if (oppRankVal !== undefined) {
                    if (oppRankVal > 0) {
                        oppRankBadge = `<span class="bg-slate-200 text-slate-500 text-[11px] px-2 py-0.5 rounded-md font-bold leading-none no-underline shadow-sm">${oppRankVal}ìœ„</span>`;
                    } else {
                        oppRankBadge = `<span class="bg-slate-100 text-slate-400 text-[11px] px-2 py-0.5 rounded-md font-bold leading-none no-underline shadow-sm border border-slate-200">ë°°ì¹˜ì¤‘</span>`;
                    }
                } else {
                    oppRankBadge = `<span class="bg-slate-100 text-slate-400 text-[11px] px-2 py-0.5 rounded-md font-bold leading-none no-underline shadow-sm border border-slate-200" title="ê³¼ê±° ê¸°ë¡">-</span>`;
                }

                const oppProfile = rankingsData.find(u => u.name === oppName);
                const oppLink = oppProfile ? `onclick="openProfile('${oppProfile.id}')"` : '';
                const oppCursor = oppProfile ? 'cursor-pointer hover:underline hover:text-blue-600' : '';

                const div = document.createElement('div'); 
                div.className = "flex items-center justify-between text-xs p-3 bg-slate-50 rounded-xl border border-slate-100"; 
                div.innerHTML = `<div class="flex items-center gap-3 w-full"><div class="flex items-center gap-1.5 shrink-0"><span class="font-bold ${resultColor} w-8 h-8 flex items-center justify-center rounded-lg text-sm shadow-sm">${resultText}</span>${scoreBadge}</div><div class="flex flex-col w-full overflow-hidden"><div class="flex justify-between items-center w-full"><span class="font-bold text-slate-700 text-sm truncate flex items-center gap-1.5 ${oppCursor}" ${oppLink}>vs ${oppName}${oppRankBadge}</span><span class="text-slate-900 font-medium text-[11px] shrink-0">${m.date}</span></div><div class="flex items-center gap-2 mt-0.5"><span class="text-[11px] text-slate-400 font-medium bg-white px-1.5 py-0.5 rounded border border-slate-100">ë‹¹ì‹œ: ${oppRecordStr}</span><div class="flex gap-0.5">${oppDots}</div></div></div></div>`; 
                container.appendChild(div); 
            }); 
        };
function renderRankings() { 
        const list = document.getElementById('rankingList'); list.innerHTML = ''; 

        // [ìˆ˜ì • 1] ì „ì²´ ë­í‚¹ ê³„ì‚° (ì±”í”¼ì–¸ 1ìˆœìœ„ -> ELO 2ìˆœìœ„)
        const globalRankedPlayers = rankingsData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3)
            .sort((a, b) => {
                if (a.isChampion) return -1; // ì±”í”¼ì–¸ ì•ìœ¼ë¡œ
                if (b.isChampion) return 1;  // ì±”í”¼ì–¸ ì•ìœ¼ë¡œ
                return (b.elo || 1000) - (a.elo || 1000); // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
            });

        // ê²€ìƒ‰ì–´ ì²˜ë¦¬
        const query = searchQuery ? searchQuery.replace(/\s/g, "") : "";
        const queryJamo = Hangul.disassemble(query);
        
        // ê²€ìƒ‰ í•„í„°ë§
        const filteredData = rankingsData.filter(p => {
            const name = p.name || "";
            const nameClean = name.replace(/\s/g, "").toLowerCase();
            if (nameClean.includes(query)) return true;
            if (p.choseong && (p.choseong.includes(query) || p.choseong.includes(queryJamo))) return true;
            if (p.jamo && p.jamo.includes(queryJamo)) return true;
            return false;
        });

        // [ìˆ˜ì • 2] í™”ë©´ í‘œì‹œìš© ë¦¬ìŠ¤íŠ¸ ì •ë ¬ (ì±”í”¼ì–¸ 1ìˆœìœ„ -> ELO 2ìˆœìœ„)
        const ranked = filteredData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) >= 3)
            .sort((a, b) => {
                if (a.isChampion) return -1;
                if (b.isChampion) return 1;
                return (b.elo || 1000) - (a.elo || 1000);
            });

        // â–¼â–¼â–¼ ì´ ì•„ë«ì¤„ë¶€í„°ëŠ” ê¸°ì¡´ ì½”ë“œ(const placement...) ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤ â–¼â–¼â–¼
        const placement = filteredData.filter(p => {
        const total = Number(p.wins || 0) + Number(p.losses || 0);
        return total > 0 && total < 3;
    }).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
    const unranked = filteredData.filter(p => (Number(p.wins || 0) + Number(p.losses || 0)) === 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
    
    const now = Date.now();
    const shouldHighlight = (id) => activeHighlight.ids.includes(id) && now < activeHighlight.endTime;

    if (filteredData.length === 0) { list.innerHTML = `<div class="text-center text-xs text-slate-400 py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }

    ranked.forEach((item) => { 
        const globalIndex = rankingsData.indexOf(item); 
        const realRank = globalRankedPlayers.findIndex(p => p.id === item.id) + 1;
        const tier = getTier(item.wins, item.losses, item.elo, item.isChampion);
        const totalMatches = (item.wins || 0) + (item.losses || 0);
        
        let cardClass = tier.class;
        if (item.isChampion) {
    cardClass = 'bg-yellow-50 border-yellow-400 ring-2 ring-yellow-300 shadow-yellow-200';
}
        let rankNumClass = "rank-num-normal";
        
        // [ì‚­ì œë¨] ë² í…Œë‘ ê´€ë ¨ ë³€ìˆ˜ ì‚­ì œ

        if (realRank === 1) { rankNumClass = "rank-num-1 font-black"; cardClass = 'rank-1-glow'; } 
        else if (realRank === 2) { rankNumClass = "rank-num-2 font-black"; cardClass = 'rank-2-glow'; } 
        else if (realRank === 3) { rankNumClass = "rank-num-3 font-black"; cardClass = 'rank-3-glow'; } 
        else { if (realRank <= 10) rankNumClass = "rank-num-top10"; }

        // í˜„ìƒê¸ˆ ë±ƒì§€
        let bountyStatHtml = '';
        if (item.bounty && item.bounty > 0) {
              bountyStatHtml = `<span class="bounty-pill-dark" title="í˜„ìƒê¸ˆ">ğŸ’°+${item.bounty}</span>`;
        }

        // [ì¶”ê°€] 3ì—°ìŠ¹ ì´ìƒ ì‹œ ë¶ˆê½ƒ í‘œì‹œ
        let streakHtml = '';
        if (item.currentStreak >= 3) {
            streakHtml = `<span class="ml-1 text-[10px] text-orange-600 font-bold">ğŸ”¥${item.currentStreak}ì—°ìŠ¹</span>`;
        }

        const prevRank = item.previousRank || realRank; 
        const diff = prevRank - realRank; 
        let ch = "";
        if (totalMatches === 3 && isRecentRankIn(item.rankInDate)) {
             ch = `<span class="text-indigo-600 font-black text-[10px] bg-indigo-50 px-1.5 py-0.5 rounded border border-indigo-100 animate-pulse">New</span>`;
        } else {
             ch = diff > 0 ? `<span class="rank-up">â–²${diff}</span>` : (diff < 0 ? `<span class="rank-down">â–¼${Math.abs(diff)}</span>` : '<span class="rank-keep">-</span>');
        }
        
        if (shouldHighlight(item.id)) cardClass += ' highlight-slow';

        list.innerHTML += `
            <div id="rank-card-${item.id}" class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-white hover:shadow-md ${cardClass}" onclick="openProfile('${item.id}')">
                <div class="w-10 text-center mr-2"><span class="${rankNumClass}">${realRank}</span><div class="text-[10px]">${ch}</div></div>
                <div class="shrink-0 relative mr-3">
                    <img src="${item.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-10 h-10 rounded-lg bg-slate-100 object-cover border border-slate-100" onerror="this.src='https://placehold.co/150?text=No+Img'">
                    ${item.isChampion ? `<div class="absolute -top-2 -right-2 text-xl filter drop-shadow-md animate-bounce-slow" title="Current Champion">ğŸ‘‘</div>` : ''}
                </div>
                <div class="flex-grow min-w-0">
                    <div class="font-bold text-sm text-slate-800 flex items-center gap-2">
                        <div class="w-1.5 h-4 rounded-sm shadow-sm ring-1 ring-inset ring-black/10" style="background: ${item.trunkColor || '#1f2937'};" title="íŠ¸ë í¬ ìƒ‰ìƒ"></div>
                        <span class="truncate">${item.name}</span>
                        <span class="text-[9px] px-1.5 py-0.5 rounded-full ${tier.color} font-bold tracking-wide uppercase shadow-sm">${tier.name}</span>
                        ${streakHtml}
                    </div>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <span class="bg-amber-100 text-amber-800 text-[10px] px-1.5 py-0.5 rounded border border-amber-200 font-bold">âš¡${item.elo}</span>
                        <span class="text-xs text-slate-400">| ${item.wins}ìŠ¹ ${item.losses}íŒ¨</span>
                        ${bountyStatHtml}
                    </div>
                </div>
                <button onclick="event.stopPropagation(); openEditModal(${globalIndex})" class="p-2 text-slate-300 hover:text-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                </button>
            </div>`; 
    }); 

    if (placement.length > 0) {
        list.innerHTML += `<div class="relative py-4"><div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200"></div></div><div class="relative flex justify-center"><span class="bg-[#f8fafc] px-3 text-xs font-bold text-slate-400">ğŸ£ ë°°ì¹˜ê³ ì‚¬ ì§„í–‰ì¤‘ (3ê²½ê¸°)</span></div></div>`;
        placement.forEach((item) => {
            const globalIndex = rankingsData.indexOf(item);
            const highlightClass = shouldHighlight(item.id) ? 'highlight-slow' : '';
            list.innerHTML += `<div id="rank-card-${item.id}" class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-slate-50 opacity-90 hover:opacity-100 ${highlightClass}" onclick="openProfile('${item.id}')"><div class="w-10 text-center mr-2"><span class="text-lg">ğŸ£</span></div><div class="shrink-0 relative mr-3"><img src="${item.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-10 h-10 rounded-lg bg-slate-100 object-cover border border-slate-100" onerror="this.src='https://placehold.co/150?text=No+Img'"></div><div class="flex-grow min-w-0"><div class="font-bold text-sm text-slate-600 flex items-center gap-2"><div class="w-1.5 h-4 rounded-sm shadow-sm ring-1 ring-inset ring-black/10" style="background: ${item.trunkColor || '#1f2937'};" title="íŠ¸ë í¬ ìƒ‰ìƒ"></div><span class="truncate">${item.name}</span><span class="text-[9px] px-1.5 py-0.5 rounded-full bg-slate-100 text-slate-500 border border-slate-200 font-bold tracking-wide uppercase shadow-sm">Placement</span></div><div class="flex items-center gap-1.5 mt-0.5"><span class="bg-amber-50 text-amber-600/70 text-[10px] px-1.5 py-0.5 rounded border border-amber-100 font-bold">âš¡${item.elo} (ê°€)</span><span class="text-xs text-slate-400">| ${item.wins}ìŠ¹ ${item.losses}íŒ¨</span></div></div><button onclick="event.stopPropagation(); openEditModal(${globalIndex})" class="p-2 text-slate-300 hover:text-blue-600 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button></div>`;
        });
    }

    if(unranked.length > 0) {
        list.innerHTML += `<div class="relative py-4"><div class="absolute inset-0 flex items-center" aria-hidden="true"><div class="w-full border-t border-slate-200"></div></div><div class="relative flex justify-center"><span class="bg-[#f8fafc] px-3 text-xs font-bold text-slate-300">- Unranked Players -</span></div></div>`;
        unranked.forEach((item) => {
            const globalIndex = rankingsData.indexOf(item);
            const highlightClass = shouldHighlight(item.id) ? 'highlight-slow' : '';
            list.innerHTML += `<div id="rank-card-${item.id}" class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-slate-50 opacity-80 hover:opacity-100 ${highlightClass}" onclick="openProfile('${item.id}')"><div class="w-10 text-center mr-2"><span class="rank-unranked">-</span></div><div class="shrink-0 relative mr-3"><img src="${item.imageUrl || 'https://placehold.co/150?text=No+Img'}" class="w-10 h-10 rounded-lg bg-slate-100 object-cover border border-slate-100 grayscale" onerror="this.src='https://placehold.co/150?text=No+Img'"></div><div class="flex-grow min-w-0"><div class="font-bold text-sm text-slate-500 flex items-center gap-2"><div class="w-1.5 h-4 rounded-sm shadow-sm ring-1 ring-inset ring-black/10" style="background: ${item.trunkColor || '#1f2937'};" title="íŠ¸ë í¬ ìƒ‰ìƒ"></div><span class="truncate">${item.name}</span></div><div class="flex items-center gap-1.5 mt-0.5"><span class="bg-slate-100 text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-slate-200 font-bold">New</span><span class="text-xs text-slate-400">| 0ìŠ¹ 0íŒ¨</span></div></div><button onclick="event.stopPropagation(); openEditModal(${globalIndex})" class="p-2 text-slate-300 hover:text-blue-600 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg></button></div>`;
        });
    }
    populateMatchSelectors();
}

        window.populateMatchSelectors = () => { 
            if (p1Tom) { p1Tom.destroy(); p1Tom = null; } 
            if (p2Tom) { p2Tom.destroy(); p2Tom = null; } 
            if (pPenTom) { pPenTom.destroy(); pPenTom = null; } 
            const s1 = document.getElementById('p1Select'); 
            const s2 = document.getElementById('p2Select'); 
            const sPen = document.getElementById('penaltyTargetSelect'); 
            if(!s1 || !s2) return; 
            
            const sortedRankedIndices = rankingsData.map((p, i) => ({ ...p, originalIndex: i })).filter(p => (p.wins + p.losses) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)).map(p => p.originalIndex); 
            const playerOptions = rankingsData.map((p, index) => { 
                const rankIndex = sortedRankedIndices.indexOf(index); 
                const isRanked = rankIndex !== -1; 
                const totalMatches = (p.wins || 0) + (p.losses || 0); 
                let rankPrefix = ''; 
                if (isRanked) rankPrefix = `${rankIndex + 1}. `; 
                else if (totalMatches > 0) rankPrefix = `[ë°°ì¹˜] `; 
                else rankPrefix = `[New] `; 
                const displayName = `${rankPrefix}${p.name}`; 
                return { value: index, text: `${displayName} (${p.elo})`, displayName: displayName, name: p.name, gameId: p.gameId || '-', choseong: p.choseong, jamo: p.jamo, elo: p.elo || 1000, isRanked: isRanked }; 
            }); 
            playerOptions.sort((a, b) => { 
                const typeA = a.isRanked ? 2 : (a.text.includes('[ë°°ì¹˜]') ? 1 : 0); 
                const typeB = b.isRanked ? 2 : (b.text.includes('[ë°°ì¹˜]') ? 1 : 0); 
                if (typeA !== typeB) return typeB - typeA; 
                if (b.elo !== a.elo) return b.elo - a.elo; 
                return a.name.localeCompare(b.name); 
            }); 
            if (typeof TomSelect === 'undefined') { console.error("Tom Select library not loaded."); return; } 
            const config = { 
                options: playerOptions, valueField: 'value', labelField: 'text', searchField: ['text'], create: false, maxOptions: null, 
                onInitialize: function() { this.control_input.setAttribute('type', 'search'); }, 
                score: function(search) { 
                    const term = search.toLowerCase().replace(/\s/g, ""); 
                    const termJamo = Hangul.disassemble(term); 
                    return function(item) { 
                        if (item.name.toLowerCase().replace(/\s/g, "").includes(term)) return 100; 
                        if (item.choseong && (item.choseong.includes(term) || item.choseong.includes(termJamo))) return 80; 
                        if (item.jamo && item.jamo.includes(termJamo)) return 60; 
                        return 0; 
                    }; 
                }, 
                render: { 
                    option: function(data, escape) { 
                        const rankClass = data.isRanked ? "font-bold text-slate-700" : "text-slate-500"; 
                        return `<div class="flex flex-col py-1 leading-tight"><div><span class="${rankClass}">${escape(data.displayName)}</span> <span class="text-xs text-slate-400">(${data.elo})</span></div><div class="text-[10px] text-slate-400">ID: ${escape(data.gameId)}</div></div>`; 
                    }, 
                    item: function(data, escape) { 
                        return `<div class="flex flex-col w-full leading-tight py-0.5"><div class="truncate"><span class="font-bold text-slate-700">${escape(data.displayName)}</span> <span class="text-xs text-gray-400">(${data.elo})</span></div><div class="text-[10px] text-gray-400 truncate">${escape(data.gameId)}</div></div>`; 
                    } 
                } 
            }; 
            const previewConfig = { ...config, onChange: function(value) { updateMatchPreview(); } }; 
            const redConfig = { ...config, onChange: function(value) { updateMatchPreview(); }, onInitialize: function() { this.control_input.setAttribute('type', 'search'); this.wrapper.classList.add('red-theme'); } }; 
            try { 
                p1Tom = new TomSelect('#p1Select', previewConfig); 
                p2Tom = new TomSelect('#p2Select', redConfig); 
                if(sPen) pPenTom = new TomSelect('#penaltyTargetSelect', config); 
            } catch(e) { console.error("Tom Select initialization failed:", e); } 
        };
    </script>
</body>
</html>
