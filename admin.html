<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC 랭킹 매니저 (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .rank-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; border-bottom: 1px solid #f1f5f9; }
        .rank-card:last-child { border-bottom: none; }
        .rank-up { color: #dc2626; font-weight: 800; } .rank-down { color: #2563eb; font-weight: 800; } .rank-keep { color: #9ca3af; }
        
        .tier-bronze, .tier-silver, .tier-gold, .tier-platinum { background: #ffffff; border-left: none; }

        .rank-num-1 { color: #d97706; font-size: 1.2rem; font-weight: 900; font-style: italic; letter-spacing: -1px; } 
        .rank-num-2 { color: #64748b; font-size: 1.2rem; font-weight: 800; font-style: italic; letter-spacing: -1px; } 
        .rank-num-3 { color: #b45309; font-size: 1.2rem; font-weight: 800; font-style: italic; letter-spacing: -1px; } 
        .rank-num-top10 { color: #059669; font-size: 1.1rem; font-weight: 800; } 
        .rank-num-normal { color: #94a3b8; font-size: 1.0rem; font-weight: 700; }
        .rank-unranked { color: #cbd5e1; font-size: 1.0rem; font-weight: 700; }
        
        .style-checkbox:checked + label { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }
        
        .boxrec-win { background: linear-gradient(180deg, #16a34a 0%, #15803d 100%); }
        .boxrec-loss { background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%); }

        .tab-btn { @apply text-slate-500 border-b-2 border-transparent hover:text-slate-700 font-medium transition-colors; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 font-bold; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f1f1; } ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-enter { animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .color-preset { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .color-preset:hover { transform: scale(1.1); }
        .color-preset.active { border-color: #3b82f6; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3b82f6; }
        .color-preset.active::after { content: '✔'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }

        .ts-control { border-radius: 0.5rem !important; border-color: #e2e8f0 !important; padding: 0.6rem 0.75rem !important; box-shadow: none !important; font-size: 0.875rem !important; background-color: #fff !important; display: flex !important; align-items: center !important; flex-wrap: nowrap !important; overflow: hidden !important; }
        .ts-control.focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important; }
        .ts-control .item { white-space: nowrap !important; overflow: hidden !important; text-overflow: clip !important; max-width: 100% !important; padding-right: 2px !important; }
        .ts-wrapper.has-items .ts-control > input { width: 1px !important; flex: 0 0 1px !important; min-width: 0 !important; opacity: 0; }
        .ts-wrapper:not(.has-items) .ts-control > input { width: 100% !important; }
        .ts-dropdown { border-radius: 0.5rem !important; border-color: #e2e8f0 !important; margin-top: 4px !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important; overflow: hidden !important; z-index: 50 !important; width: max-content !important; min-width: 100% !important; }
        .ts-dropdown .ts-dropdown-content { max-height: 500px !important; }
        .ts-dropdown .option { padding: 0.5rem 0.75rem !important; font-size: 0.875rem !important; white-space: nowrap !important; }
        .ts-dropdown .active { background-color: #eff6ff !important; color: #1e40af !important; }

        @keyframes slowFade {
            0% { transform: scale(1); background-color: #ffffff; z-index: 1; }
            0.5% { transform: scale(1.03); background-color: #93c5fd !important; box-shadow: 0 0 20px rgba(37, 99, 235, 0.4); z-index: 50; border-color: #2563eb; }
            5% { transform: scale(1.01); background-color: #bfdbfe !important; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2); z-index: 50; border-color: #60a5fa; }
            100% { transform: scale(1); background-color: #ffffff !important; z-index: 1; border-color: #e2e8f0; }
        }
        .highlight-slow {
            animation: slowFade 60s cubic-bezier(0.22, 1, 0.36, 1) forwards !important;
        }

        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            background: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3e%3cline x1='18' y1='6' x2='6' y2='18'%3e%3c/line%3e%3cline x1='6' y1='6' x2='18' y2='18'%3e%3c/line%3e%3c/svg%3e") no-repeat center center;
            cursor: pointer;
            margin-left: 8px;
        }
    </style>
</head>
<body class="text-slate-800 relative min-h-screen">

    <div id="customAlertModal" class="fixed inset-0 bg-slate-900/80 z-[10001] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeAlertModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-amber-100 mb-4">
                    <svg class="h-6 w-6 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">알림</h3>
                <p id="alertMessage" class="text-sm text-slate-600 mb-6 whitespace-pre-wrap leading-relaxed">내용</p>
                <button onclick="closeAlertModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg transition">확인</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="fixed inset-0 bg-slate-900/80 z-[10000] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeConfirmModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">⚠️ 확인이 필요합니다</h3>
                <p id="confirmMessage" class="text-sm text-slate-600 mb-6 whitespace-pre-wrap">정말 실행하시겠습니까?</p>
                <div class="flex justify-center gap-3">
                    <button onclick="closeConfirmModal()" class="bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-5 py-2.5 rounded-xl text-sm font-bold transition">취소</button>
                    <button id="confirmOkBtn" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg shadow-red-500/30 transition">확인 (실행)</button>
                </div>
            </div>
        </div>
    </div>

    <button id="undoBtn" onclick="executeUndo()" class="fixed bottom-6 right-6 z-50 bg-slate-800 text-white px-5 py-3 rounded-full shadow-xl font-bold flex items-center gap-2 transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed hidden">
        <span class="text-lg">↩️</span> 실행 취소 (<span id="undoCount">0</span>)
    </button>

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-slate-200">
            <div class="text-4xl mb-2">🥊</div>
            <h2 class="text-2xl font-black text-slate-800 mb-6">RFC Admin Security</h2>
            <div id="loginFormContainer">
                <input type="email" id="adminEmail" placeholder="admin@rfc.com" class="w-full p-3 border border-slate-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
                <input type="password" id="adminPw" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
                <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg transition transform active:scale-95 shadow-lg shadow-blue-500/30">시스템 접속</button>
            </div>
            <div id="autoLoginMsg" class="hidden mt-4 text-emerald-600 font-bold text-sm animate-pulse">
                ⚡ 개발자 자동 로그인 중...
            </div>
        </div>
    </div>

    <div id="mainContent" class="max-w-6xl mx-auto p-4 hidden min-h-screen flex flex-col">
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">RFC 매니저</h1>
                <span id="currentSeasonBadge" class="bg-slate-800 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">Loading...</span>
                <span id="saveStatus" class="text-xs font-medium text-emerald-500 transition-opacity opacity-0">✅ 저장됨 (Secure)</span>
            </div>
            <div class="mt-2 md:mt-0 text-xs text-slate-400 font-medium">
                <span id="adminVersionDisplay">v4.38</span>
            </div>
        </header>

        <div class="bg-white rounded-t-2xl border-b border-slate-200 px-4 flex gap-6 mb-4 shadow-sm overflow-x-auto">
            <button onclick="switchTab('main')" id="tabMain" class="tab-btn active py-4 whitespace-nowrap">🔥 랭킹/경기</button>
            <button onclick="switchTab('history')" id="tabHistory" class="tab-btn py-4 whitespace-nowrap">⚔️ 경기 기록</button>
            <button onclick="switchTab('season')" id="tabSeason" class="tab-btn py-4 whitespace-nowrap">📅 시즌 관리</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn py-4 whitespace-nowrap">🛠️ 데이터/백업</button>
            <button onclick="switchTab('settings')" id="tabSettings" class="tab-btn py-4 whitespace-nowrap">⚙️ 설정/메모</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            <div class="lg:col-span-4 space-y-6">
                <div id="mainSection" class="tab-content">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 mb-6 relative z-30">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                            <h3 class="font-bold text-slate-700">⚔️ 경기 결과 입력</h3>
                            <button onclick="resetMatchInputs()" class="text-xs bg-white border border-slate-200 text-slate-500 hover:text-blue-600 hover:border-blue-200 px-2.5 py-1.5 rounded-lg font-bold transition flex items-center gap-1 shadow-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                초기화
                            </button>
                        </div>
                        <div class="p-5">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 mb-1 pl-1">📅 경기 날짜</label>
                                    <div class="flex gap-2">
                                        <input type="date" id="matchDateInput" class="flex-grow border border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700 outline-none focus:border-blue-500 bg-white">
                                        <button onclick="setMatchDate('yesterday')" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">어제</button>
                                        <button onclick="setMatchDate('today')" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">오늘</button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-blue-600 mb-1 pl-1">🔵 Blue (검색가능)</label>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-grow min-w-0">
                                                <select id="p1Select" class="w-full text-sm outline-none" placeholder="선수 검색..."></select>
                                            </div>
                                            <div id="p1TrunkIndicator" class="w-3 h-6 rounded border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="바지 색상"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-red-600 mb-1 pl-1">🔴 Red (검색가능)</label>
                                        <div class="flex items-center gap-2">
                                            <div class="flex-grow min-w-0">
                                                <select id="p2Select" class="w-full text-sm outline-none" placeholder="선수 검색..."></select>
                                            </div>
                                            <div id="p2TrunkIndicator" class="w-3 h-6 rounded border border-slate-300 shadow-sm shrink-0 bg-slate-100" title="바지 색상"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 bg-slate-50 p-1.5 rounded-xl border border-slate-200">
                                    <label class="cursor-pointer flex items-center justify-center gap-2 p-2.5 rounded-lg hover:bg-blue-50 transition border border-transparent has-[:checked]:bg-blue-100 has-[:checked]:border-blue-300 has-[:checked]:shadow-sm">
                                        <input type="radio" name="winner" value="blue" class="w-4 h-4 accent-blue-600" onchange="updateMatchPreview()">
                                        <span class="text-xs font-bold text-blue-700">Blue 승</span>
                                    </label>
                                    <label class="cursor-pointer flex items-center justify-center gap-2 p-2.5 rounded-lg hover:bg-red-50 transition border border-transparent has-[:checked]:bg-red-100 has-[:checked]:border-red-300 has-[:checked]:shadow-sm">
                                        <input type="radio" name="winner" value="red" class="w-4 h-4 accent-red-600" onchange="updateMatchPreview()">
                                        <span class="text-xs font-bold text-red-700">Red 승</span>
                                    </label>
                                </div>
                                <div id="matchPreview" class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 border border-gray-200 hidden"><div id="previewContent" class="space-y-1"></div></div>
                                <button onclick="applyMatch()" class="w-full bg-gradient-to-r from-slate-800 to-slate-900 hover:from-black text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">경기 확정</button>
                                <button onclick="updateRankBaseline()" class="w-full bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold py-3 rounded-xl text-xs transition border border-slate-200">📉 순위 변동(▲▼) 리셋</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">
                            👤 선수 관리 도구 
                            <span id="totalPlayerCount" class="font-normal ml-1">(0명)</span>
                        </h3>
                        <div class="flex gap-2 mb-3">
                            <button onclick="openNewPlayerModal()" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-3 rounded-xl border border-emerald-100 transition">+ 선수 등록</button>
                            <button onclick="openDeletePlayersModal()" class="flex-1 bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-xl border border-red-100 transition flex items-center justify-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                선수 삭제
                            </button>
                        </div>
                        
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-3">
                            <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-orange-700">💀 패널티 부여 (-30점)</h4></div>
                            <div class="flex gap-2">
                                <div class="flex-grow min-w-0">
                                    <select id="penaltyTargetSelect" class="w-full text-xs outline-none" placeholder="대상 선택..."></select>
                                </div>
                                <button onclick="applyManualPenalty()" class="bg-white text-orange-700 font-bold px-3 py-2 rounded-lg text-xs border border-orange-200 transition hover:bg-orange-100 whitespace-nowrap">실행</button>
                            </div>
                        </div>

                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-3 mb-3">
                            <h4 class="text-xs font-bold text-slate-700 mb-2 flex items-center gap-1">
                                <span>💤</span> 장기 미참여자 관리
                            </h4>
                            <div class="flex gap-2 items-center mb-2">
                                <div class="flex items-center gap-1">
                                    <input type="number" id="inactiveDaysInput" value="30" class="w-14 border border-slate-300 p-1.5 rounded text-xs text-center font-bold outline-none focus:border-blue-500" min="1">
                                    <span class="text-[11px] text-slate-500 font-bold">일</span>
                                </div>
                                <span class="text-slate-300">|</span>
                                <div class="flex items-center gap-1">
                                    <span class="text-red-500 font-bold text-xs">-</span>
                                    <input type="number" id="penaltyScoreInput" value="30" class="w-14 border border-red-200 bg-white p-1.5 rounded text-xs text-center font-bold text-red-600 outline-none focus:border-red-500" min="1">
                                    <span class="text-[11px] text-slate-500 font-bold">점</span>
                                </div>
                                <div class="flex-grow"></div>
                                <button onclick="checkBatchInactiveUsers()" class="bg-white border border-slate-300 text-slate-600 hover:bg-slate-100 font-bold px-3 py-1.5 rounded-lg text-xs transition shadow-sm whitespace-nowrap">조회</button>
                                <button onclick="resetBatchInactiveForm()" class="bg-white border border-slate-300 text-slate-500 hover:text-slate-700 hover:bg-slate-100 font-bold px-2 py-1.5 rounded-lg text-xs transition shadow-sm" title="초기화">🔄</button>
                            </div>
                            
                            <div id="inactiveListArea" class="hidden mt-3 pt-3 border-t border-slate-200">
                                <p class="text-[10px] text-slate-400 mb-2 font-bold">검색된 대상자 (<span id="inactiveCountDisplay">0</span>명)</p>
                                <ul id="inactiveUserList" class="max-h-32 overflow-y-auto bg-white border border-slate-200 rounded-lg p-2 text-[11px] text-slate-600 space-y-1 mb-3 shadow-inner"></ul>
                                <button id="btnApplyBatchPenalty" class="w-full bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 font-bold py-2.5 rounded-lg text-xs transition shadow-sm flex justify-center items-center gap-1">
                                    <span>💀</span> 패널티 적용하기
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="historySection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden flex flex-col h-[calc(100vh-180px)]">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">⚔️ 경기 기록 Log</h3>
                            <button onclick="openMatchExportModal()" class="bg-white border border-slate-200 text-slate-600 hover:text-blue-600 text-xs font-bold px-3 py-1.5 rounded-lg transition shadow-sm flex items-center gap-1">
                                <span>📤</span> 텍스트 내보내기
                            </button>
                        </div>
                        <div class="p-3 border-b border-slate-100">
                             <select id="adminHistorySeason" class="w-full text-sm font-bold text-slate-700 bg-white border border-slate-200 rounded-lg p-2.5 outline-none focus:ring-2 focus:ring-blue-500"></select>
                        </div>
                        <div id="adminMatchListContainer" class="flex-grow overflow-y-auto p-3 space-y-3 bg-slate-50/50">
                            <div class="text-center text-xs text-slate-400 py-10">기록 불러오는 중...</div>
                        </div>
                    </div>
                </div>

                <div id="seasonSection" class="tab-content hidden">
                    <div class="space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><h3 class="font-bold text-slate-700 mb-3 border-b pb-2">📅 시즌 목록</h3><div id="seasonListContainer" class="space-y-2 max-h-60 overflow-y-auto mb-2"></div><p class="text-[10px] text-slate-400 mt-2">* 목록에서 삭제하면 사용자 화면에서도 즉시 사라집니다.</p></div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5"><div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-700">😴 미참여 선수</h3><span id="seasonInactiveCount" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">0명</span></div><div class="text-xs text-slate-500 mb-3">현재 시즌(<span class="currentSeasonName font-bold"></span>) 경기 기록 없음</div><button onclick="toggleInactiveList()" class="text-xs text-blue-500 font-bold underline mb-2">목록 보기/숨기기</button><ul id="seasonInactiveList" class="hidden bg-slate-50 p-2 rounded text-xs text-slate-600 space-y-1 mb-3 max-h-40 overflow-y-auto border border-slate-200"></ul></div>
                        <div class="bg-purple-50 rounded-2xl shadow-sm border border-purple-100 overflow-hidden p-5"><h3 class="font-bold text-purple-800 mb-2">🚀 시즌 종료 및 시작</h3><p class="text-xs text-purple-600 mb-4">현재 시즌을 마감하고 새 시즌을 시작합니다.</p><div class="flex gap-2"><input type="text" id="newSeasonNameInput" class="flex-grow border border-purple-200 rounded-lg p-2 text-sm focus:outline-none focus:border-purple-400" placeholder="새 시즌 이름"><button onclick="finishAndStartNewSeason()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg text-xs shadow transition whitespace-nowrap">시즌 시작</button></div></div>
                    </div>
                </div>

                <div id="toolsSection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 space-y-4">
                        <h3 class="font-bold text-slate-700">🛠️ 데이터 도구</h3>
                        <div class="grid grid-cols-2 gap-2"><input type="file" id="importFile" accept=".json" class="hidden"><button onclick="document.getElementById('importFile').click()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg text-xs">📂 데이터 복원</button><button onclick="backupData()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg text-xs">💾 데이터 백업</button></div>
                        
                        <div class="pt-4 border-t border-slate-100 space-y-2">
                            <h4 class="text-xs font-bold text-indigo-600">🔧 데이터 보정</h4>
                            <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-xs font-bold text-indigo-800">데이터 무결성 검사 및 수정</span>
                                </div>
                                <p class="text-[10px] text-indigo-600 mb-2 leading-snug">
                                    1. 과도한 순위 변동폭(예: +34) 초기화<br>
                                    2. 3전 선수들의 누락된 '진입 날짜' 복구 (New 뱃지 활성화)
                                </p>
                                <button onclick="fixDataIntegrity()" class="w-full bg-white text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs border border-indigo-200 shadow-sm transition">
                                    ✨ 데이터 진단 및 복구 실행
                                </button>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100 space-y-2">
                            <h4 class="text-xs font-bold text-blue-600">👥 선수 명단 추출</h4>
                            <div class="grid grid-cols-1 gap-2">
                                <button onclick="copyRankerList()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-3 rounded-lg text-xs border border-blue-100">🏆 랭커 명단</button>
                                <button onclick="copyAllPlayerList()" class="bg-slate-50 text-slate-600 hover:bg-slate-100 font-bold py-3 rounded-lg text-xs border border-slate-200">📋 전체 선수 명단</button>
                            </div>
                        </div>
                        <div class="pt-4 border-t border-slate-100 space-y-2">
                            <h4 class="text-xs font-bold text-red-500">초기화 (주의)</h4>
                            <button onclick="resetAllStats()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">📊 현재 시즌 전적 초기화</button>
                            <button onclick="resetAllElo()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">⚡ 현재 시즌 ELO 초기화</button>
                            <button onclick="resetAllPasswords()" class="w-full bg-orange-50 text-orange-600 hover:bg-orange-100 font-bold py-3 rounded-lg text-xs border border-orange-200 mt-2">🔑 전체 비밀번호 재발급 (명단 복사)</button>
                            <button onclick="resetEverything()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-lg text-xs border border-red-200 mt-2">🧨 시스템 전체 리셋</button>
                        </div>
                    </div>
                </div>

                <div id="settingsSection" class="tab-content hidden">
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-slate-700">📢 사용자 공지사항 관리</h3>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="noticeActiveToggle" class="sr-only peer" onchange="saveNoticeSettings()">
                                    <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                                    <span class="ml-2 text-xs font-bold text-slate-600">공지 활성화</span>
                                </label>
                            </div>
                            <textarea id="noticeContentInput" class="w-full h-24 p-3 text-xs border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-slate-50 resize-none mb-3" placeholder="공지 내용을 입력하세요..."></textarea>
                            <button onclick="saveNoticeSettings()" class="w-full bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs border border-indigo-100 transition">공지 저장하기</button>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                            <h3 class="font-bold text-slate-700 mb-2">📜 규칙 HTML 편집</h3>
                            <textarea id="ruleHtmlInput" class="w-full h-48 p-3 text-xs font-mono border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 resize-none mb-3" placeholder="HTML 코드를 입력하세요..."></textarea>
                            <div class="flex gap-2">
                                <button onclick="loadDefaultRuleHtml()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-2.5 rounded-lg text-xs hover:bg-slate-200 transition">↺ 기본 디자인 불러오기</button>
                                <button onclick="saveRules()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg text-xs transition">규칙 저장하기</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 flex flex-col h-[400px]">
                            <h3 class="font-bold text-slate-700 mb-3 flex justify-between">📝 관리자 메모장</h3>
                            <div id="memoListContainer" class="flex-grow overflow-y-auto space-y-2 mb-3 pr-1 bg-slate-50 rounded-lg p-2 border border-slate-100"><div class="text-center text-xs text-gray-400 py-4">작성된 메모가 없습니다.</div></div>
                            <div class="flex gap-2"><input type="text" id="newMemoInput" class="flex-grow border border-slate-200 rounded-lg p-2.5 text-sm focus:outline-none focus:border-blue-500" placeholder="메세지 남기기..." onkeypress="if(event.key==='Enter') addMemo()"><button onclick="addMemo()" class="bg-slate-800 hover:bg-slate-900 text-white font-bold px-4 rounded-lg text-xs transition whitespace-nowrap">등록</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[calc(100vh-140px)]">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                    <div><h3 class="font-bold text-slate-700">🔥 실시간 랭킹</h3><p class="text-[10px] text-slate-400 font-medium mt-0.5">현재 활성 시즌: <span class="currentSeasonName text-blue-600 font-bold"></span></p></div>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input type="search" id="searchInput" placeholder="선수/초성 검색" class="w-[155px] text-xs border border-slate-200 rounded-lg pl-9 pr-2 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-xs">🔍</div>
                        </div>
                        <div class="flex gap-2"><button onclick="window.open('index.html')" class="bg-white border border-slate-200 text-slate-600 text-xs font-bold py-2 px-3 rounded-lg hover:bg-slate-50">🌐 사이트 보기</button><button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow hover:bg-indigo-700">💾 저장</button></div>
                    </div>
                </div>
                <div id="rankingList" class="flex-grow overflow-y-auto p-2 space-y-1.5 bg-slate-50/50"></div>
            </div>
        </div>
    </div>

    <div id="deletePlayersModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) closeDeletePlayersModal()">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div class="flex items-center gap-2">
                    <h3 class="text-lg font-bold text-slate-800">🗑️ 선수 삭제</h3>
                    <span id="deleteCountBadge" class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full whitespace-nowrap">0명 선택됨</span>
                </div>
                <div class="relative">
                    <input type="search" id="deleteSearchInput" placeholder="이름/초성 검색" class="w-[155px] border p-2 pl-9 rounded-lg text-sm bg-slate-50 focus:outline-none focus:ring-2 focus:ring-red-500 transition" oninput="renderDeleteList()">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none text-sm">🔍</div>
                </div>
            </div>

            <div class="flex items-center gap-2 mb-2 px-1">
                <input type="checkbox" id="deleteAllCheckbox" class="w-4 h-4 text-red-600 rounded border-gray-300 focus:ring-red-500 cursor-pointer" onchange="toggleDeleteSelectAll()">
                <label for="deleteAllCheckbox" class="text-xs text-slate-500 font-bold cursor-pointer select-none">전체 선택</label>
            </div>

            <div id="deletePlayerList" class="flex-grow overflow-y-auto border border-slate-200 rounded-lg p-2 space-y-1 bg-slate-50 min-h-[200px]"></div>

            <div class="mt-3 bg-red-50 p-3 rounded-lg border border-red-100">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="deleteHistoryCheckbox" class="w-4 h-4 text-red-600 rounded border-red-300 focus:ring-red-500">
                    <div class="text-xs text-red-700 font-bold">
                        <span>경기 기록도 함께 삭제</span>
                        <p class="text-[10px] font-normal text-red-500 mt-0.5 leading-snug">선택 시, 해당 선수가 포함된 모든 과거 경기 로그가 영구 삭제됩니다. (상대방의 전적 횟수는 유지되지만 로그는 사라짐)</p>
                    </div>
                </label>
            </div>

            <div class="flex justify-end gap-2 mt-4 pt-2 border-t">
                <button onclick="closeDeletePlayersModal()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">취소</button>
                <button onclick="confirmDeletePlayers()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">삭제하기</button>
            </div>
        </div>
    </div>

    <div id="newPlayerModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('newPlayerModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">👤 새 선수 등록</h3>
            <p class="text-xs text-gray-500 mb-3">등록할 선수의 이름을 입력해주세요.</p>
            <input type="text" id="newPlayerNameInput" class="w-full border p-3 rounded-lg text-sm mb-4 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="선수 이름" onkeypress="if(event.key==='Enter') confirmNewPlayer()">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('newPlayerModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">취소</button>
                <button onclick="confirmNewPlayer()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">등록하기</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('editModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">✏️ 선수 정보 수정</h3>
            <input type="hidden" id="editPlayerId"><input type="hidden" id="editOriginalName">
            <div class="flex gap-6 mb-6">
                <div class="relative w-48 h-48 shrink-0 group">
                    <img id="previewImage" src="" class="w-full h-full rounded-2xl object-cover border border-slate-200 bg-slate-50 shadow-sm" onerror="this.src='https://placehold.co/150?text=No+Img'">
                    <button onclick="removeImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1.5 shadow-md hover:bg-red-600 transition opacity-0 group-hover:opacity-100" title="이미지 삭제">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414-1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div class="flex-grow flex flex-col justify-between py-1">
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1.5 block">프로필 이미지 URL</label>
                        <input type="text" id="editImageUrlInput" placeholder="이미지 주소 붙여넣기..." class="w-full border border-slate-300 p-2.5 rounded-lg text-xs bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" oninput="updatePreview(this.value)">
                        <p class="text-[10px] text-gray-400 mt-1.5 leading-snug">* 디스코드/카톡 이미지 우클릭 → <strong>'주소 복사'</strong></p>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-500 mb-1.5 block">시즌 전적 & 점수 (수동 조절)</label>
                        <div class="flex gap-2">
                            <div class="flex-1"><div class="relative"><input type="number" id="editWins" class="w-full border border-emerald-200 bg-emerald-50 p-2.5 rounded-lg text-sm text-center font-bold text-emerald-700 focus:outline-none focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-emerald-400 font-medium select-none">승</span></div></div>
                            <div class="flex-1"><div class="relative"><input type="number" id="editLosses" class="w-full border border-rose-200 bg-rose-50 p-2.5 rounded-lg text-sm text-center font-bold text-rose-700 focus:outline-none focus:border-rose-500 focus:ring-1 focus:ring-rose-500"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-rose-400 font-medium select-none">패</span></div></div>
                            <div class="flex-1"><div class="relative"><input type="number" id="editElo" class="w-full border border-amber-200 bg-amber-50 p-2.5 rounded-lg text-sm text-center font-bold text-amber-700 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-amber-400 font-medium select-none">점</span></div></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-12 gap-3 mb-3">
                <div class="col-span-4"><label class="text-xs text-gray-500 block mb-1">이름</label><input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold bg-white focus:outline-none focus:border-blue-500"></div>
                <div class="col-span-4"><label class="text-xs text-gray-500 block mb-1">Game ID</label><input type="text" id="editGameId" class="w-full border p-2 rounded text-sm bg-white focus:outline-none focus:border-blue-500" placeholder="ID 입력"></div>
                <div class="col-span-4"><label class="text-xs text-gray-500 block mb-1 font-bold text-blue-600">비밀번호</label><div class="flex gap-1"><input type="text" id="editPassword" class="w-full border p-2 rounded text-sm font-mono font-bold bg-blue-50 text-blue-700 focus:outline-none focus:border-blue-500" placeholder="변경 시 입력"><button onclick="resetIndividualPassword()" class="bg-slate-200 text-slate-700 px-2 rounded-lg text-xs hover:bg-slate-300 font-bold transition flex items-center justify-center shadow-sm" title="랜덤 초기화">🔄</button></div></div>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div><label class="text-xs text-gray-500 block mb-1">키 (cm)</label><input type="text" id="editHeight" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-blue-500"></div>
                <div><label class="text-xs text-gray-500 block mb-1">리치 (cm)</label><input type="text" id="editReach" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-blue-500"></div>
                <div><label class="text-xs text-gray-500 block mb-1">스탠스</label><select id="editStance" class="w-full border p-2 rounded text-sm bg-white focus:outline-none focus:border-blue-500"><option value="Orthodox">Orthodox</option><option value="Southpaw">Southpaw</option><option value="Switch">Switch</option></select></div>
            </div>
            <div class="mb-4"><label class="text-xs text-gray-500 block mb-2">바지 색상 (10가지 프리셋)</label><div id="trunkColorPresets" class="flex flex-wrap gap-2"></div><input type="hidden" id="editTrunkColor"></div>
            <div class="mb-6 p-3 bg-slate-50 rounded border border-slate-200"><label class="block text-xs font-bold text-slate-600 mb-2">🥊 스타일 태그</label><div id="styleTagsContainer" class="flex flex-wrap gap-2"></div></div>
            <div class="flex justify-between items-center">
                <button type="button" onclick="tryDeletePlayer()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold transition border border-red-200">🗑️ 선수 삭제</button>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">취소</button>
                    <button onclick="savePlayerDetails()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <div id="renameModal" class="fixed inset-0 bg-slate-900/80 z-[10002] hidden flex items-center justify-center backdrop-blur-sm" onclick="if(event.target === this) closeRenameModal()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">✏️ 시즌 이름 변경</h3>
            <input type="hidden" id="renameOldName">
            <input type="text" id="renameInput" class="w-full border p-3 rounded-lg text-sm mb-6 focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" placeholder="새 시즌 이름" onkeypress="if(event.key==='Enter') confirmRenameSeason()">
            <div class="flex justify-end gap-2">
                <button onclick="closeRenameModal()" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">취소</button>
                <button onclick="confirmRenameSeason()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">변경</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center" onclick="if(event.target === this) document.getElementById('exportModal').classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
            <h3 id="exportModalTitle" class="text-lg font-bold text-slate-800 mb-2 border-b pb-2">📤 텍스트 내보내기 / 수정</h3>
            <p class="text-[11px] text-slate-500 mb-3">
                텍스트를 자유롭게 수정 후 복사하거나, <strong>[이름 ID]</strong> 형식으로 작성하여 일괄 업데이트할 수 있습니다.
            </p>
            <div id="exportMatchOptions" class="flex gap-2 mb-3 hidden"></div>
            <textarea id="exportTextarea" class="w-full h-64 p-3 text-xs font-mono border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white resize-none mb-4" placeholder="상단 버튼을 눌러 기록을 생성하세요..."></textarea>
            <div class="flex justify-between items-center gap-2">
                <button onclick="document.getElementById('exportModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">닫기</button>
                <div class="flex gap-2">
                    <button onclick="applyBatchIdUpdate()" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-1">
                        <span>💾</span> ID 일괄 적용
                    </button>
                    <button onclick="copyExportText()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-1">
                        <span>📋</span> 복사
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-[10000] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeProfile()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] max-w-3xl mx-auto h-[92vh] overflow-y-auto modal-enter flex flex-col">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center cursor-pointer border-b border-slate-100" onclick="closeProfile()"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-5 pb-8 relative mt-2">
                <div class="absolute top-0 right-4 flex gap-3 z-20">
                    <button id="profileEditBtn" class="text-blue-600 hover:text-blue-800 p-2 text-sm font-bold flex items-center gap-1 bg-blue-50 rounded-lg px-3 py-2 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> 정보 수정</button>
                    <button onclick="closeProfile()" class="text-slate-400 hover:text-slate-600 p-2 text-2xl font-bold">✕</button>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-center mb-4"><h2 class="text-3xl font-black text-slate-800 flex items-center justify-center gap-2 tracking-tight"><span id="pModalCrown" class="text-2xl hidden">👑</span><span id="pModalName">Name</span></h2><div class="flex items-center justify-center gap-2 mt-1"><span id="pModalGameId" class="text-xs text-slate-500 font-bold bg-slate-100 px-2 py-0.5 rounded">ID: -</span><span id="pModalTierBadge" class="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-400">Tier</span></div></div>
                    <div class="mb-5 relative"><img id="pModalImg" src="" class="w-48 h-48 rounded-2xl object-cover border-4 border-white shadow-xl bg-slate-50" onerror="this.src='https://placehold.co/150?text=No+Img'"></div>
                    <div class="w-full max-w-sm mb-6">
                        <div class="flex justify-end mb-2"><select id="pModalSeason" class="text-xs font-bold text-slate-600 bg-slate-100 border border-slate-200 rounded px-2 py-1 outline-none focus:border-blue-500"><option value="all">전체 기록 (All Time)</option><option value="current">현재 시즌 (Current)</option></select></div>
                        <div class="flex w-full rounded-lg overflow-hidden shadow-md"><div class="flex-1 boxrec-win text-white p-1.5 text-center border-r border-white/20"><div class="text-3xl font-black leading-none" id="pBigWins">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Wins</div></div><div class="flex-1 boxrec-loss text-white p-1.5 text-center"><div class="text-3xl font-black leading-none" id="pBigLosses">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Losses</div></div></div>
                        <div class="flex bg-slate-50 border border-slate-200 border-t-0 rounded-b-lg divide-x divide-slate-200 text-center py-2 shadow-sm"><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Win Rate</div><div class="text-sm font-black text-slate-700" id="pModalWinRate">0%</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Elo Rating</div><div class="text-sm font-black text-amber-600" id="pModalElo">1000</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Career High</div><div class="text-sm font-black text-slate-700" id="pModalHighElo">1000</div></div></div>
                    </div>
                    <div class="w-full space-y-6"><div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm"><div class="grid grid-cols-3 gap-4 text-center"><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Height</div><div id="pModalHeight" class="font-bold text-slate-700 text-sm">-</div></div><div class="border-x border-slate-100"><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Reach</div><div id="pModalReach" class="font-bold text-slate-700 text-sm">-</div></div><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Stance</div><div id="pModalStance" class="font-bold text-slate-700 text-sm">-</div></div></div><div id="pModalTags" class="flex flex-wrap gap-1.5 justify-center mt-3"></div></div><div><h3 class="text-xs font-bold text-slate-400 uppercase mb-2 pl-1">Bout History</h3><div id="pModalMatchList" class="space-y-2 pb-10"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        
        const AUTO_LOGIN_EMAIL = ""; 
        const AUTO_LOGIN_PW = "";
        
        // [System] Admin Version Control
        const ADMIN_VERSION = "v4.38"; 
        const UPDATE_NOTE = "Fix: Empty Data Init & Hangul";

        function initVersionUI() {
            try {
                document.title = `RFC 랭킹 매니저 [${ADMIN_VERSION}]`;
                const adminVerEl = document.getElementById('adminVersionDisplay');
                if(adminVerEl) {
                    adminVerEl.innerHTML = `<span class="font-bold text-slate-600">${ADMIN_VERSION}</span> <span class="text-slate-400 font-normal ml-1 text-[11px]">${UPDATE_NOTE}</span>`;
                }
            } catch (e) {
                console.warn("Version UI Update Failed", e);
            }
        }
        initVersionUI();

        const firebaseConfig = { apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk", authDomain: "rfk-ranking.firebaseapp.com", projectId: "rfk-ranking", storageBucket: "rfk-ranking.firebasestorage.app", messagingSenderId: "675366165774", appId: "1:675366165774:web:795d34c56eab630b4dcb5f", measurementId: "G-CXPDZQ8GTL" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = 'ranking-manager-default';
        
        let rankingsData = []; let matchHistoryData = []; let seasonArchives = {}; let activeSeason = "시즌 1"; let adminMemos = []; let ruleHtml = "";
        let undoStack = []; const MAX_UNDO = 10;
        let searchQuery = "";
        let enrichedHistory = [];
        let viewHistorySeason = "";
        let currentProfileId = null;
        let p1Tom, p2Tom, pPenTom;
        let activeHighlight = { ids: [], endTime: 0 };
        let deleteSelectedIds = new Set();
        let lastCheckedIndex = null; 
        
        let batchPenaltyTargets = [];

        // [New] 고급 한글 검색 유틸리티 (자모 분해, 겹받침 처리)
        const Hangul = {
            CHO: ["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],
            JUNG: ["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"],
            JONG: ["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"],
            // 겹받침 분해 맵
            COMPLEX_JONG: {
                'ㄳ':'ㄱㅅ', 'ㄵ':'ㄴㅈ', 'ㄶ':'ㄴㅎ', 'ㄺ':'ㄹㄱ', 'ㄻ':'ㄹㅁ', 'ㄼ':'ㄹㅂ', 
                'ㄽ':'ㄹㅅ', 'ㄾ':'ㄹㅌ', 'ㄿ':'ㄹㅍ', 'ㅀ':'ㄹㅎ', 'ㅄ':'ㅂㅅ'
            },
            
            // 초성 추출 (기존 getChoseong 대체)
            getCho: function(str) {
                let result = "";
                for(let i=0; i<str.length; i++) {
                    const code = str.charCodeAt(i) - 44032;
                    if(code > -1 && code < 11172) result += this.CHO[Math.floor(code / 588)];
                    else result += str.charAt(i);
                }
                return result;
            },

            // 완전 자모 분해 (삶 -> ㅅㅏㄹㅁ)
            disassemble: function(str) {
                let result = "";
                for (let i = 0; i < str.length; i++) {
                    const char = str.charAt(i);
                    const code = char.charCodeAt(0) - 44032;
                    
                    if (code > -1 && code < 11172) {
                        const choIdx = Math.floor(code / 588);
                        const jungIdx = Math.floor((code - (choIdx * 588)) / 28);
                        const jongIdx = code % 28;
                        
                        const cho = this.CHO[choIdx];
                        const jung = this.JUNG[jungIdx];
                        let jong = this.JONG[jongIdx];

                        // 겹받침 분해 (ex: ㄺ -> ㄹㄱ)
                        if(this.COMPLEX_JONG[jong]) {
                            jong = this.COMPLEX_JONG[jong];
                        }

                        result += cho + jung + jong;
                    } else {
                        result += char;
                    }
                }
                return result;
            }
        };

        const STYLE_OPTIONS = ["인파이터", "아웃복서", "슬러거", "하드 펀처", "바디 스내처", "볼륨 펀처", "스위치 히터", "브롤러", "카운터 펀처", "복서-펀처", "슬릭", "샤프슈터", "패스트 핸드"];
        
        const COLOR_PRESETS = [
            { name: "Black", code: "#1f2937" }, 
            { name: "Half B/W", code: "linear-gradient(to bottom, #1f2937 50%, #f8fafc 50%)" },
            { name: "White", code: "#f8fafc" }, 
            { name: "Gray", code: "#94a3b8" },
            { name: "Red", code: "#ef4444" }, { name: "Orange", code: "#f97316" }, { name: "Amber", code: "#f59e0b" },
            { name: "Gold", code: "#FFD700" }, { name: "Yellow", code: "#eab308" }, { name: "Lime", code: "#84cc16" }, 
            { name: "Green", code: "#22c55e" }, { name: "Emerald", code: "#10b981" }, { name: "Teal", code: "#14b8a6" }, 
            { name: "Sky", code: "#0ea5e9" }, { name: "Blue", code: "#3b82f6" }, { name: "Indigo", code: "#6366f1" }, 
            { name: "Purple", code: "#a855f7" }, { name: "Fuchsia", code: "#d946ef" }, { name: "Pink", code: "#ec4899" }, 
            { name: "Rose", code: "#f43f5e" }
        ];
        
        const LATEST_RULE_HTML = `
<div class="space-y-5 text-slate-700 font-sans">
    <div class="bg-gradient-to-br from-indigo-50 to-blue-50 p-4 rounded-2xl border border-indigo-100 shadow-sm">
        <h3 class="font-bold text-indigo-700 mb-2 text-sm flex items-center gap-1">
            <span class="text-lg">🐣</span> 배치고사 (첫 3경기)
        </h3>
        <ul class="text-xs space-y-1.5 opacity-90">
            <li>• <strong>랭킹 미진입:</strong> 3경기 완료 전까지 순위표에 표시되지 않습니다.</li>
            <li>• <strong>점수 부스팅:</strong> 제자리 찾기를 위해 변동폭이 <strong>1.5배</strong>(K=90) 적용됩니다.</li>
        </ul>
    </div>
    <div>
        <h3 class="font-bold text-slate-800 mb-2 text-sm flex items-center gap-1">
            <span class="text-lg">🏆</span> 정식 랭킹 & 티어 보너스
        </h3>
        <p class="text-xs text-slate-500 mb-2">전적에 따라 <strong>승패 배율</strong>과 <strong>참여 점수</strong>가 달라집니다.</p>
        <div class="grid grid-cols-2 gap-2 text-xs">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <div class="font-bold text-slate-500 mb-1 flex justify-between">
                    <span>🥈 SILVER (3~6전)</span>
                    <span class="text-blue-600">+7점</span>
                </div>
                <div class="space-y-0.5 text-[10px]">
                    <div class="flex justify-between"><span>승리</span> <span class="text-blue-600 font-bold">x1.1</span></div>
                    <div class="flex justify-between"><span>패배</span> <span class="text-red-500 font-bold">x0.9</span></div>
                </div>
            </div>
            <div class="bg-white p-3 rounded-xl border border-yellow-300 shadow-sm ring-1 ring-yellow-100">
                <div class="font-bold text-amber-600 mb-1 flex justify-between">
                    <span>🥇 GOLD (7~12전)</span>
                    <span class="text-blue-600">+9점</span>
                </div>
                <div class="space-y-0.5 text-[10px]">
                    <div class="flex justify-between"><span>승리</span> <span class="text-blue-600 font-bold">x1.2</span></div>
                    <div class="flex justify-between"><span>패배</span> <span class="text-red-500 font-bold">x0.8</span></div>
                </div>
            </div>
            <div class="col-span-2 bg-gradient-to-r from-cyan-50 to-white p-3 rounded-xl border border-cyan-200 shadow-sm">
                <div class="font-bold text-cyan-700 mb-1 flex justify-between items-center">
                    <span>💎 PLATINUM (13전~)</span>
                    <span class="bg-cyan-100 text-cyan-800 px-2 py-0.5 rounded text-[10px] border border-cyan-200">+13점 지급</span>
                </div>
                <div class="flex gap-4 text-[10px] text-cyan-900">
                    <span>승리 <strong class="text-blue-600">x1.2</strong></span>
                    <span>패배 <strong class="text-red-500">x0.8</strong></span>
                </div>
            </div>
        </div>
    </div>
    <div class="bg-rose-50 p-3 rounded-xl border border-rose-100">
        <span class="font-bold text-xs text-rose-800 block mb-1">💤 휴면 패널티</span>
        <span class="text-[11px] text-rose-600 leading-tight block">30일 미활동 시 <span class="font-bold underline">-30점</span> (1패) 자동 차감</span>
    </div>
</div>`;

        function getKSTDate() { return new Date().toLocaleDateString("en-CA", { timeZone: "Asia/Seoul" }); }
        
        // [수정됨] 티어 계산 및 뱃지 스타일 정의 (흰색 배경 + 유색 테두리 + 대문자 통일)
        function getTier(wins, losses) {
            const matches = (wins || 0) + (losses || 0);
            
            // 0~2전: BRONZE
            if (matches < 3) return { 
                name: 'BRONZE', 
                class: 'tier-bronze', 
                color: 'bg-white border border-amber-600 text-amber-700' 
            };
            
            // 3~6전: SILVER
            if (matches < 7) return { 
                name: 'SILVER', 
                class: 'tier-silver', 
                color: 'bg-white border border-slate-400 text-slate-500' 
            };
            
            // 7~12전: GOLD
            if (matches < 13) return { 
                name: 'GOLD', 
                class: 'tier-gold', 
                color: 'bg-white border border-yellow-500 text-yellow-600' 
            };
            
            // 13전 이상: PLATINUM (배경을 흰색으로 변경하여 통일감 부여)
            return { 
                name: 'PLATINUM', 
                class: 'tier-platinum', 
                color: 'bg-white border border-cyan-500 text-cyan-600' 
            };
        }

        async function hashPin(pin) { if (!pin) return ""; try { if (window.crypto && window.crypto.subtle) { const msgBuffer = new TextEncoder().encode(pin); const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer); const hashArray = Array.from(new Uint8Array(hashBuffer)); return hashArray.map(b => b.toString(16).padStart(2, '0')).join(''); } else { return pin; } } catch (e) { return pin; } }
        function generateUUID() { if (typeof crypto !== 'undefined' && crypto.randomUUID) { return crypto.randomUUID(); } return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8); return v.toString(16); }); }

        document.getElementById('btnLogin').addEventListener('click', () => { 
            const email = document.getElementById('adminEmail').value; 
            const pw = document.getElementById('adminPw').value; 
            signInWithEmailAndPassword(auth, email, pw).catch((e) => alert("로그인 실패: " + e.message)); 
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
                
                setTimeout(() => setMatchDate('today'), 100);
            } else {
                if(AUTO_LOGIN_EMAIL && AUTO_LOGIN_PW) {
                    document.getElementById('loginFormContainer').classList.add('hidden');
                    document.getElementById('autoLoginMsg').classList.remove('hidden');
                    signInWithEmailAndPassword(auth, AUTO_LOGIN_EMAIL, AUTO_LOGIN_PW).catch((e) => {
                        document.getElementById('loginFormContainer').classList.remove('hidden');
                        document.getElementById('autoLoginMsg').classList.add('hidden');
                    });
                } else {
                    document.getElementById('loginFormContainer').classList.remove('hidden');
                    document.getElementById('autoLoginMsg').classList.add('hidden');
                }
            }
        });

        document.getElementById('searchInput').addEventListener('input', (e) => { 
            searchQuery = e.target.value.toLowerCase(); // 공백 제거 안함 (띄어쓰기 포함 이름 고려)
            renderRankings(); 
        });
        
        const presetContainer = document.getElementById('trunkColorPresets');
        presetContainer.innerHTML = '';
        COLOR_PRESETS.forEach(color => { const div = document.createElement('div'); div.className = 'color-preset shadow-sm'; div.style.background = color.code; div.dataset.color = color.code; div.title = color.name; div.onclick = () => selectPresetColor(color.code, div); presetContainer.appendChild(div); });
        
        for(let i=1; i<=3; i++) { 
            const wrapper = document.createElement('div'); 
            wrapper.className = 'color-preset shadow-sm flex items-center justify-center bg-white border border-slate-200 custom-picker-slot relative'; 
            wrapper.title = `Custom Color ${i}`; 
            const badge = document.createElement('div'); 
            badge.className = 'absolute -top-1 -right-1 w-3.5 h-3.5 bg-blue-600 text-white rounded-full flex items-center justify-center text-[9px] font-bold pointer-events-none shadow-sm z-10 leading-none pb-0.5'; 
            badge.textContent = '+'; 
            wrapper.appendChild(badge); 
            const icon = document.createElement('span'); 
            icon.className = 'text-[12px] opacity-40 pointer-events-none icon-placeholder grayscale'; 
            icon.textContent = '🎨'; 
            wrapper.appendChild(icon); 
            const input = document.createElement('input'); 
            input.type = 'color'; 
            input.className = 'opacity-0 absolute inset-0 w-full h-full cursor-pointer'; 
            input.value = '#ffffff'; 
            input.addEventListener('input', (e) => { 
                const newColor = e.target.value; 
                wrapper.style.backgroundColor = newColor; 
                wrapper.dataset.color = newColor; 
                icon.style.display = 'none'; 
                selectPresetColor(newColor, wrapper); 
            }); 
            wrapper.appendChild(input); 
            presetContainer.appendChild(wrapper); 
        }

        function selectPresetColor(code, element) { 
            document.getElementById('editTrunkColor').value = code; 
            document.querySelectorAll('.color-preset').forEach(el => el.classList.remove('active')); 
            if(element) element.classList.add('active'); 
        }

        // [Fix] Modified loadData to handle empty database case
        function loadData() { 
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); 
            onSnapshot(docRef, (doc) => { 
                if (doc.exists()) { 
                    const data = doc.data(); 
                    rankingsData = data.rankings || []; 
                    matchHistoryData = data.matchHistory || []; 
                    seasonArchives = data.seasonArchives || {}; 
                    activeSeason = data.activeSeason || "시즌 1"; 
                    adminMemos = data.adminMemos || []; 
                    ruleHtml = data.ruleHtml || DEFAULT_RULE_HTML; 
                    if(!viewHistorySeason) viewHistorySeason = activeSeason; 
                    
                    updateSeasonUI(); 
                    renderMemos(); 
                    document.getElementById('ruleHtmlInput').value = ruleHtml; 
                    if(data.noticeData) { 
                        document.getElementById('noticeContentInput').value = data.noticeData.content || ""; 
                        document.getElementById('noticeActiveToggle').checked = data.noticeData.active || false; 
                    } 
                    
                    // [Modified] 데이터 전처리: 초성 및 자모 완전 분해 데이터 생성
                    rankingsData.forEach((p, i) => { 
                        if(p.defenseCount === undefined) p.defenseCount = 0; 
                        if(p.previousRank === undefined) p.previousRank = i + 1; 
                        if(p.careerHighRank === undefined) p.careerHighRank = i + 1; 
                        if(p.elo === undefined) p.elo = 1000; 
                        if(p.careerHighElo === undefined) p.careerHighElo = p.elo; 
                        if(!p.trunkColor) p.trunkColor = '#1f2937'; 
                        
                        // 검색용 데이터 생성
                        p.choseong = Hangul.getCho(p.name);       // 초성 (ㅎㄱㄷ)
                        p.jamo = Hangul.disassemble(p.name);      // 자모 분해 (ㅎㅗㅇㄱㅣㄹㄷㅗㅇ)
                    }); 
                    
                    renderRankings(); 
                    populateMatchSelectors(); 
                    renderSeasonList(); 
                    checkSeasonInactive(); 
                    enrichMatchHistory(); 
                    updateAdminHistorySeasonSelector(); 
                    renderAdminMatches(); 
                    if (currentProfileId) updateProfileStats(currentProfileId, document.getElementById('pModalSeason').value); 
                    if(document.getElementById('totalPlayerCount')) document.getElementById('totalPlayerCount').textContent = `(${rankingsData.length}명)`;
                } else {
                    console.log("No existing data found. Initializing empty state.");
                    // Initialize default empty state if DB is empty
                    rankingsData = [];
                    matchHistoryData = [];
                    seasonArchives = {};
                    activeSeason = "시즌 1";
                    ruleHtml = LATEST_RULE_HTML;
                    
                    updateSeasonUI();
                    renderRankings();
                    populateMatchSelectors();
                    renderSeasonList();
                    updateAdminHistorySeasonSelector();
                    renderAdminMatches();
                    
                    // Clear loading messages
                    if(document.getElementById('totalPlayerCount')) document.getElementById('totalPlayerCount').textContent = `(0명)`;
                }
            }, (error) => {
                console.error("Firebase Read Error:", error);
                alert("데이터를 불러오는 중 오류가 발생했습니다.\n" + error.message);
            }); 
        }

        window.saveNoticeSettings = async () => { const content = document.getElementById('noticeContentInput').value; const active = document.getElementById('noticeActiveToggle').checked; const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); try { await runTransaction(db, async (transaction) => { const sfDoc = await transaction.get(docRef); if (!sfDoc.exists()) throw "Doc missing"; transaction.set(docRef, { noticeData: { content, active } }, { merge: true }); }); const btn = document.querySelector('button[onclick="saveNoticeSettings()"]'); const originalText = btn.innerText; btn.innerText = "✅ 저장됨"; setTimeout(() => btn.innerText = originalText, 1500); } catch(e) { alert("공지 저장 실패"); } };

        function enrichMatchHistory() { const chronological = [...matchHistoryData].reverse(); const statsTracker = {}; enrichedHistory = chronological.map(match => { const winner = match.winner; const loser = match.loser; if (!statsTracker[winner]) statsTracker[winner] = { w: 0, l: 0, h: [] }; if (!statsTracker[loser]) statsTracker[loser] = { w: 0, l: 0, h: [] }; const snapshot = { [winner]: { ...statsTracker[winner] }, [loser]: { ...statsTracker[loser] } }; if (match.type !== 'draw') { statsTracker[winner].w += 1; statsTracker[winner].h = [...statsTracker[winner].h, 'W'].slice(-6); statsTracker[loser].l += 1; statsTracker[loser].h = [...statsTracker[loser].h, 'L'].slice(-6); } return { ...match, snapshot }; }); enrichedHistory.reverse(); }
        
        function renderAdminMatches() { 
            const container = document.getElementById('adminMatchListContainer'); 
            container.innerHTML = ''; 
            const filtered = enrichedHistory.filter(m => (m.season || "시즌 1") === viewHistorySeason && m.type !== 'draw'); 
            
            if (filtered.length === 0) { 
                container.innerHTML = `<div class="text-center text-xs text-slate-400 py-10">기록된 경기가 없습니다.</div>`; 
                return; 
            } 

            const dateCounts = filtered.reduce((acc, m) => {
                acc[m.date] = (acc[m.date] || 0) + 1;
                return acc;
            }, {});

            let lastDate = "";

            filtered.forEach((m, idx) => { 
                const rawIndex = matchHistoryData.findIndex(raw => raw.date === m.date && raw.winner === m.winner && raw.loser === m.loser); 
                const winStats = m.snapshot[m.winner] || { w:0, l:0, h:[] }; 
                const loseStats = m.snapshot[m.loser] || { w:0, l:0, h:[] }; 
                
                let winDots = ''; 
                (winStats.h || []).forEach(r => winDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`); 
                let loseDots = ''; 
                (loseStats.h || []).forEach(r => loseDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`); 
                
                if (m.date !== lastDate) {
                    const count = dateCounts[m.date];
                    const dateHeader = document.createElement('div');
                    dateHeader.className = "text-xs font-bold text-slate-500 mt-4 mb-2 px-1 flex items-center gap-1 sticky top-0 bg-f8fafc/90 backdrop-blur-sm z-10 py-1";
                    dateHeader.style.cssText = "background-color: rgba(248, 250, 252, 0.95); backdrop-filter: blur(2px);";
                    dateHeader.innerHTML = `<span>📅</span> ${m.date} <span class="text-slate-400 font-normal text-[11px] ml-1">(총 ${count}경기)</span>`;
                    container.appendChild(dateHeader);
                    lastDate = m.date;
                }

                const div = document.createElement('div'); 
                div.className = "bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-2 relative group hover:border-blue-300 transition-colors"; 
                
                div.innerHTML = `
                    <button onclick="deleteMatchLog(${rawIndex})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition opacity-0 group-hover:opacity-100 p-1" title="기록 삭제">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                    <div class="flex items-center justify-between text-xs mt-1">
                        <div class="flex flex-col items-start w-[45%]">
                            <div class="flex items-center gap-1.5">
                                <span class="text-xs font-black text-slate-800 truncate">${m.winner}</span>
                                <span class="bg-emerald-100 text-emerald-600 text-[9px] px-1 py-0.5 rounded font-bold">WIN</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${winStats.w}승 ${winStats.l}패</span>
                                <div class="flex gap-0.5">${winDots}</div>
                            </div>
                        </div>
                        <div class="text-[10px] font-bold text-slate-300">VS</div>
                        <div class="flex flex-col items-end w-[45%]">
                            <div class="flex items-center gap-1.5">
                                <span class="bg-rose-100 text-rose-600 text-[9px] px-1 py-0.5 rounded font-bold">LOSE</span>
                                <span class="text-xs font-medium text-slate-500 truncate">${m.loser}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <div class="flex gap-0.5">${loseDots}</div>
                                <span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${loseStats.w}승 ${loseStats.l}패</span>
                            </div>
                        </div>
                    </div>`; 
                container.appendChild(div); 
            }); 
        }

        function updateAdminHistorySeasonSelector() { const selector = document.getElementById('adminHistorySeason'); selector.innerHTML = ''; const opts = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)]; opts.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s + (s === activeSeason ? " 🟢" : ""); selector.appendChild(opt); }); selector.value = viewHistorySeason; selector.onchange = (e) => { viewHistorySeason = e.target.value; renderAdminMatches(); }; }
        window.deleteMatchLog = (idx) => { if (idx === -1) return; if(!confirm("⚠️ 경고: 이 기록을 삭제하시겠습니까?\n\n- 로그 목록에서만 사라집니다.\n- 이미 변동된 승/패 횟수나 점수(ELO)는 되돌아가지 않습니다.\n- 점수 수정이 필요하면 '선수 수정' 메뉴를 이용하세요.")) return; captureState(); matchHistoryData.splice(idx, 1); saveRankings(); renderAdminMatches(); alert("기록이 삭제되었습니다."); };

        window.openMatchExportModal = () => { const modal = document.getElementById('exportModal'); if (modal) modal.classList.remove('hidden'); const title = document.getElementById('exportModalTitle'); if (title) title.textContent = "📤 텍스트 내보내기 / 수정"; const options = document.getElementById('exportMatchOptions'); if (options) { options.classList.remove('hidden'); options.innerHTML = `<div class="flex gap-2 w-full mb-2"><button onclick="generateExportText(15)" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">최근 15경기</button><button onclick="generateExportText(30)" class="flex-1 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 font-bold py-2 rounded-lg text-xs transition border border-indigo-100">최근 30경기</button></div><div class="flex justify-end px-1"><label class="inline-flex items-center cursor-pointer hover:bg-slate-50 p-1 rounded transition"><input type="checkbox" id="hideRankToggle" onchange="generateExportText()" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer"><span class="ml-2 text-xs text-slate-500 font-bold select-none">순위 숨기기</span></label></div>`; } const textarea = document.getElementById('exportTextarea'); if (textarea) textarea.value = ""; window.lastExportCount = 15; generateExportText(15); };
        
        // [Added] Helper for Text Export Format
        function getPlayerStatusLabel(p, realRankList) {
            const total = (p.wins || 0) + (p.losses || 0);
            
            // [Option 3] UR (Unranked) Style for Placement & New players (< 3 matches)
            if (total < 3) return `${p.name}(UR)`;
            
            const rank = realRankList.findIndex(r => r.id === p.id) + 1;
            return `${p.name}(${rank}위)`;
        }

        window.generateExportText = (count) => { 
            if (count) window.lastExportCount = count; 
            else count = window.lastExportCount || 15; 
            
            const hideRank = document.getElementById('hideRankToggle')?.checked || false; 
            const targetSeason = viewHistorySeason || activeSeason; 
            const filtered = matchHistoryData.filter(m => (m.season || "시즌 1") === targetSeason && m.type !== 'draw'); 
            const targets = filtered.slice(0, count); 
            const textarea = document.getElementById('exportTextarea'); 
            
            if (!textarea) return; 
            if (targets.length === 0) { 
                textarea.value = `[${targetSeason}] 기록된 경기가 없습니다.`; 
                return; 
            } 

            const processedTargets = targets.map(m => {
                let dateStr = m.date;
                try {
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const month = parseInt(parts[1], 10);
                        const day = parseInt(parts[2], 10);
                        dateStr = `${month}월 ${day}일`;
                    }
                } catch(e) {}
                return { ...m, dateLabel: dateStr };
            });

            const dateCounts = processedTargets.reduce((acc, m) => {
                acc[m.dateLabel] = (acc[m.dateLabel] || 0) + 1;
                return acc;
            }, {});

            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000)); 
            
            let result = ""; 
            let currentDate = ""; 
            
            processedTargets.forEach(m => { 
                if (m.dateLabel !== currentDate) { 
                    if (result !== "") result += "\n"; 
                    result += `📅 ${m.dateLabel} (총 ${dateCounts[m.dateLabel]}경기)\n`; 
                    currentDate = m.dateLabel; 
                } 
                
                const getPlayerLabel = (name) => { 
                    if (hideRank) return name; 
                    const p = rankingsData.find(x => x.name === name); 
                    if (!p) return `${name}(?)`; 
                    
                    // [Modified] Use Status Helper
                    return getPlayerStatusLabel(p, realRankList);
                }; 
                result += `${getPlayerLabel(m.winner)} VS ${getPlayerLabel(m.loser)}\n`; 
            }); 
            
            textarea.value = result; 
        };

        window.copyExportText = () => { const textarea = document.getElementById('exportTextarea'); if (!textarea) return; textarea.select(); try { const successful = document.execCommand('copy'); if(successful) { showCustomAlert("✅ 클립보드에 복사되었습니다!"); } else { throw new Error('Copy failed'); } } catch (err) { showCustomAlert("복사 실패. 수동으로 복사해주세요."); } };
        
        window.updateRankerExport = (type) => { 
            // [Modified] Sort Logic: Ranked(>=3 matches) first, then Placement(<3 matches), then by ELO
            const rankers = rankingsData.filter(p => (p.wins + p.losses) > 0).sort((a, b) => {
                const aTotal = (a.wins || 0) + (a.losses || 0);
                const bTotal = (b.wins || 0) + (b.losses || 0);
                const aIsRanked = aTotal >= 3;
                const bIsRanked = bTotal >= 3;

                // Priority 1: Ranked Status (Ranked comes first)
                if (aIsRanked && !bIsRanked) return -1;
                if (!aIsRanked && bIsRanked) return 1;

                // Priority 2: ELO Descending
                return (b.elo || 1000) - (a.elo || 1000);
            });

            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
            
            let text = ""; 
            if (type === 'rank') { 
                text = rankers.map(p => getPlayerStatusLabel(p, realRankList)).join('\n'); 
            } else if (type === 'id') { 
                text = rankers.map(p => `${p.name} ${p.gameId || '-'}`).join('\n'); 
            } else { 
                text = rankers.map(p => `${p.name} ${p.trunkColor || '#1f2937'}`).join('\n'); 
            } 
            const textarea = document.getElementById('exportTextarea'); 
            if(textarea) textarea.value = text; 
        };

        window.updateAllPlayerExport = (type) => { 
            const allPlayers = [...rankingsData].sort((a, b) => a.name.localeCompare(b.name)); 
            const realRankList = rankingsData.filter(p => ((p.wins || 0) + (p.losses || 0)) >= 3).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));

            let text = ""; 
            if (type === 'name') { 
                text = allPlayers.map(p => p.name).join('\n'); 
            } else if (type === 'status') {
                text = allPlayers.map(p => getPlayerStatusLabel(p, realRankList)).join('\n');
            } else if (type === 'id') { 
                text = allPlayers.map(p => `${p.name} ${p.gameId || '-'}`).join('\n'); 
            } else { 
                text = allPlayers.map(p => `${p.name} ${p.trunkColor || '#1f2937'}`).join('\n'); 
            } 
            const textarea = document.getElementById('exportTextarea'); 
            if(textarea) textarea.value = text; 
        };

        window.copyRankerList = () => { 
            try { 
                if (!rankingsData || rankingsData.length === 0) return showCustomAlert("데이터를 불러오는 중이거나 선수가 없습니다."); 
                const rankers = rankingsData.filter(p => (p.wins + p.losses) > 0); 
                if (rankers.length === 0) return showCustomAlert("랭킹에 등록된 선수가 없습니다."); 
                const modal = document.getElementById('exportModal'); 
                if (modal) modal.classList.remove('hidden'); 
                const title = document.getElementById('exportModalTitle'); 
                if (title) title.textContent = "🏆 랭커 명단 추출"; 
                const options = document.getElementById('exportMatchOptions'); 
                if (options) { 
                    options.classList.remove('hidden'); 
                    options.innerHTML = `<button onclick="updateRankerExport('rank')" class="flex-1 bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">🔢 순위 (이름+순위/배치)</button><button onclick="updateRankerExport('id')" class="flex-1 bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-2 rounded-lg text-xs transition border border-emerald-100">🆔 ID (이름+ID)</button><button onclick="updateRankerExport('color')" class="flex-1 bg-purple-50 text-purple-600 hover:bg-purple-100 font-bold py-2 rounded-lg text-xs transition border border-purple-100">🎨 색상 (이름+색상)</button>`; 
                } 
                updateRankerExport('rank'); 
            } catch (e) { showCustomAlert("명단 생성 중 오류가 발생했습니다."); } 
        };

        window.copyAllPlayerList = () => { 
            try { 
                if (!rankingsData || rankingsData.length === 0) return showCustomAlert("데이터를 불러오는 중이거나 선수가 없습니다."); 
                if (rankingsData.length === 0) return showCustomAlert("등록된 선수가 없습니다."); 
                const modal = document.getElementById('exportModal'); 
                if (modal) modal.classList.remove('hidden'); 
                const title = document.getElementById('exportModalTitle'); 
                if (title) title.textContent = "📋 전체 선수 명단 추출"; 
                const options = document.getElementById('exportMatchOptions'); 
                if (options) { 
                    options.classList.remove('hidden'); 
                    options.innerHTML = `
                        <div class="grid grid-cols-2 gap-2 w-full">
                            <button onclick="updateAllPlayerExport('name')" class="bg-slate-50 text-slate-600 hover:bg-slate-100 font-bold py-2 rounded-lg text-xs transition border border-slate-200">📋 기본 (이름만)</button>
                            <button onclick="updateAllPlayerExport('status')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 font-bold py-2 rounded-lg text-xs transition border border-blue-100">📊 현황 (이름+구분)</button>
                            <button onclick="updateAllPlayerExport('id')" class="bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-2 rounded-lg text-xs transition border border-emerald-100">🆔 ID (이름+ID)</button>
                            <button onclick="updateAllPlayerExport('color')" class="bg-purple-50 text-purple-600 hover:bg-purple-100 font-bold py-2 rounded-lg text-xs transition border border-purple-100">🎨 색상 (이름+색상)</button>
                        </div>`; 
                } 
                updateAllPlayerExport('name'); 
            } catch (e) { showCustomAlert("명단 생성 중 오류가 발생했습니다."); } 
        };

        // [Added] Batch ID Update Function
        // [Modified] Replaced native alert/confirm with Custom Modals (Fix for popup issue)
        window.applyBatchIdUpdate = async () => {
            console.log("applyBatchIdUpdate called");
            const textarea = document.getElementById('exportTextarea');
            if (!textarea) return showCustomAlert("텍스트 입력창을 찾을 수 없습니다.");
            
            const text = textarea.value;
            if (!text.trim()) return showCustomAlert("입력된 내용이 없습니다.");

            const lines = text.split('\n').filter(line => line.trim() !== '');
            const updates = [];
            let notFoundCount = 0;
            let sameIdCount = 0;
            let formatErrorCount = 0;
            
            lines.forEach(line => {
                const trimmedLine = line.trim();
                // [Regex] (이름) (공백들) (ID) 패턴 매칭
                const match = trimmedLine.match(/^(.*?)[\s\t]+([^\s\t]+)$/);
                
                if (match) {
                    let name = match[1].trim();
                    let newId = match[2].trim();
                    
                    // '-' 또는 'null' 등의 텍스트는 빈 ID로 처리
                    if (['-', 'undefined', 'null', '(없음)'].includes(newId)) {
                        newId = '';
                    }

                    const player = rankingsData.find(p => p.name === name);
                    
                    if (player) {
                        const currentId = player.gameId || '';
                        if (currentId !== newId) {
                            updates.push({ player, newId });
                        } else {
                            sameIdCount++;
                        }
                    } else {
                        console.warn(`[Batch Update] Player not found: "${name}"`);
                        notFoundCount++;
                    }
                } else {
                    formatErrorCount++;
                }
            });

            if (updates.length === 0) {
                let msg = "⚠️ 변경할 내용이 없습니다.";
                if (notFoundCount > 0) msg += `\n- 이름 불일치: ${notFoundCount}명 (선수 명단 확인 필요)`;
                if (sameIdCount > 0) msg += `\n- 변경사항 없음: ${sameIdCount}명 (기존 ID와 동일)`;
                if (formatErrorCount > 0) msg += `\n- 형식 오류: ${formatErrorCount}줄 ("이름 ID" 형식이 아님)`;
                
                return showCustomAlert(msg);
            }

            const confirmMsg = `총 ${updates.length}명의 Game ID를 변경하시겠습니까?` + 
                               (notFoundCount > 0 ? `\n(실패: ${notFoundCount}명 - 이름 없음)` : '') +
                               `\n\n[변경 미리보기 (상위 5명)]\n${updates.slice(0, 5).map(u => `${u.player.name}: ${u.player.gameId || '(없음)'} ➔ ${u.newId || '(삭제)'}`).join('\n')}` +
                               (updates.length > 5 ? `\n...외 ${updates.length - 5}명` : '');

            // [Modified] Use showConfirmModal instead of native confirm
            showConfirmModal(confirmMsg, async () => {
                captureState(); 
                updates.forEach(u => {
                    u.player.gameId = u.newId;
                });
                await saveRankings();
                renderRankings();
                
                showCustomAlert(`✅ ${updates.length}명의 정보가 성공적으로 업데이트되었습니다.`);
                document.getElementById('exportModal').classList.add('hidden');
            });
        };
    </script>
</body>
</html>
