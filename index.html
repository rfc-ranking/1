<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ì „ (v3.29 Vivid Unranked)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .tier-bronze { border-left: 4px solid #ad8a56; background: linear-gradient(90deg, #fff 0%, #fdfbf7 100%); }
        .tier-silver { border-left: 4px solid #94a3b8; background: linear-gradient(90deg, #fff 0%, #f8fafc 100%); }
        .tier-gold { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, #fff 0%, #fffbeb 100%); }
        .rank-num-1 { color: #f59e0b; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .rank-num-2 { color: #94a3b8; font-size: 1.4rem; }
        .rank-num-3 { color: #ad8a56; font-size: 1.3rem; }
        .rank-num-normal { color: #94a3b8; font-size: 1.1rem; font-weight: 700; }
        .rank-unranked { color: #cbd5e1; font-size: 1.2rem; font-weight: 700; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; font-weight: 700; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; font-weight: 500; }
        .modal-enter { animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .boxrec-win { background: linear-gradient(180deg, #16a34a 0%, #15803d 100%); }
        .boxrec-loss { background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%); }
        
        /* ìŠ¤íƒ€ì¼ íƒœê·¸ ì²´í¬ íš¨ê³¼ */
        .style-checkbox:checked + label { background-color: #3b82f6 !important; color: white !important; border-color: #3b82f6 !important; }

        /* Color Preset Styling */
        .color-preset { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; position: relative; }
        .color-preset:hover { transform: scale(1.1); }
        .color-preset.active { border-color: #3b82f6; box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3b82f6; }
        .color-preset.active::after { content: 'âœ”'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-10 flex flex-col min-h-screen">

    <header class="bg-white sticky top-0 z-40 shadow-sm border-b border-slate-200">
        <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
            <div><h1 class="text-xl font-black italic tracking-tighter text-slate-900 flex items-center gap-1"><span class="text-blue-600">RFC</span> RANKING</h1><p id="currentDate" class="text-xs text-slate-400 font-medium mt-0.5">Loading...</p></div>
            <div class="flex gap-2"><button onclick="openRules()" class="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-200 transition">ğŸ“œ ê·œì¹™</button><div id="seasonBadge" class="bg-slate-900 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg shadow-slate-500/20">-</div></div>
        </div>
        <nav class="flex border-t border-slate-100 max-w-3xl mx-auto"><button onclick="switchTab('ranking')" id="tabRanking" class="tab-active flex-1 py-3 text-sm transition-colors text-center">ğŸ”¥ ë­í‚¹</button><button onclick="switchTab('matches')" id="tabMatches" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">âš”ï¸ ê¸°ë¡</button><button onclick="switchTab('hof')" id="tabHof" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">ğŸ›ï¸ ì „ë‹¹</button><button onclick="switchTab('tournament')" id="tabTournament" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">ğŸ† ëŒ€ì§„</button></nav>
    </header>

    <main class="max-w-3xl mx-auto p-3 flex-grow w-full">
        <div id="rankingSection" class="fade-in space-y-3">
            <div class="flex justify-between items-end px-1 pb-1"><span class="text-xs font-bold text-slate-400">Hybrid ELO ê¸°ì¤€ ì •ë ¬</span><div class="flex gap-2"><span class="text-[10px] text-slate-400 bg-white border px-2 py-1 rounded-full"><span class="text-emerald-500">â—</span> ìŠ¹ë¦¬</span><span class="text-[10px] text-slate-400 bg-white border px-2 py-1 rounded-full"><span class="text-rose-500">â—</span> íŒ¨ë°°</span></div></div>
            <div id="rankingList" class="space-y-2.5"><div class="text-center py-10 text-slate-400 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div></div>
        </div>
        
        <div id="matchesSection" class="hidden fade-in space-y-4">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between"><span class="text-sm font-bold text-slate-600">ì‹œì¦Œ ì„ íƒ</span><select id="seasonSelector" class="text-sm font-bold text-slate-800 bg-slate-50 border border-slate-200 rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500"></select></div>
            <div id="matchList" class="space-y-3"></div>
        </div>

        <div id="hofSection" class="hidden fade-in"><div id="hofContent" class="space-y-6"></div></div>
        <div id="tournamentSection" class="hidden fade-in"><div id="bracketContainer" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-x-auto min-h-[300px] flex items-center justify-center text-slate-400 text-sm">ì§„í–‰ ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div></div>
    </main>

    <footer class="text-center py-4 mt-4"><a href="admin.html" class="text-[10px] text-slate-300 hover:text-slate-500 transition-colors font-bold no-underline">Admin Access (Secured)</a></footer>

    <div id="profileModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeProfile()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] max-w-3xl mx-auto h-[92vh] overflow-y-auto modal-enter flex flex-col">
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center cursor-pointer border-b border-slate-100" onclick="closeProfile()"><div class="w-12 h-1.5 bg-slate-200 rounded-full"></div></div>
            <div class="px-5 pb-8 relative mt-2">
                <div class="absolute top-0 right-4 flex gap-3 z-20">
                    <button onclick="requestEdit()" class="text-slate-400 hover:text-blue-600 p-2 text-sm font-bold flex items-center gap-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg> ì •ë³´ ìˆ˜ì •</button>
                    <button onclick="closeProfile()" class="text-slate-400 hover:text-slate-600 p-2 text-2xl font-bold">âœ•</button>
                </div>
                <div class="flex flex-col items-center">
                    <div class="text-center mb-4"><h2 class="text-3xl font-black text-slate-800 flex items-center justify-center gap-2 tracking-tight"><span id="pModalCrown" class="text-2xl hidden">ğŸ‘‘</span><span id="pModalName">Name</span></h2><div class="flex items-center justify-center gap-2 mt-1"><span id="pModalGameId" class="text-xs text-slate-500 font-bold bg-slate-100 px-2 py-0.5 rounded">ID: -</span><span id="pModalTierBadge" class="text-[10px] text-white font-bold px-2 py-0.5 rounded bg-slate-400">Tier</span></div></div>
                    <div class="mb-5 relative"><img id="pModalImg" src="" class="w-48 h-48 rounded-2xl object-cover border-4 border-white shadow-xl bg-slate-50" onerror="this.src='https://placehold.co/150?text=No+Img'"></div>
                    <div class="w-full max-w-sm mb-6">
                        <div class="flex justify-end mb-2"><select id="pModalSeason" class="text-xs font-bold text-slate-600 bg-slate-100 border border-slate-200 rounded px-2 py-1 outline-none focus:border-blue-500"><option value="all">ì „ì²´ ê¸°ë¡ (All Time)</option><option value="current">í˜„ì¬ ì‹œì¦Œ (Current)</option></select></div>
                        <div class="flex w-full rounded-lg overflow-hidden shadow-md"><div class="flex-1 boxrec-win text-white p-1.5 text-center border-r border-white/20"><div class="text-3xl font-black leading-none" id="pBigWins">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Wins</div></div><div class="flex-1 boxrec-loss text-white p-1.5 text-center"><div class="text-3xl font-black leading-none" id="pBigLosses">0</div><div class="text-[10px] font-bold opacity-80 uppercase tracking-widest mt-1">Losses</div></div></div>
                        <div class="flex bg-slate-50 border border-slate-200 border-t-0 rounded-b-lg divide-x divide-slate-200 text-center py-2 shadow-sm"><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Win Rate</div><div class="text-sm font-black text-slate-700" id="pModalWinRate">0%</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Elo Rating</div><div class="text-sm font-black text-amber-600" id="pModalElo">1000</div></div><div class="flex-1"><div class="text-[10px] text-slate-400 font-bold uppercase">Career High</div><div class="text-sm font-black text-slate-700" id="pModalHighElo">1000</div></div></div>
                    </div>
                    <div class="w-full space-y-6"><div class="bg-white rounded-2xl p-4 border border-slate-100 shadow-sm"><div class="grid grid-cols-3 gap-4 text-center"><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Height</div><div id="pModalHeight" class="font-bold text-slate-700 text-sm">-</div></div><div class="border-x border-slate-100"><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Reach</div><div id="pModalReach" class="font-bold text-slate-700 text-sm">-</div></div><div><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Stance</div><div id="pModalStance" class="font-bold text-slate-700 text-sm">-</div></div></div><div id="pModalTags" class="flex flex-wrap gap-1.5 justify-center mt-3"></div></div><div><h3 class="text-xs font-bold text-slate-400 uppercase mb-2 pl-1">Bout History</h3><div id="pModalMatchList" class="space-y-2 pb-10"></div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="pinModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-xl w-80 text-center">
            <h3 class="text-lg font-bold text-slate-800 mb-2">ğŸ”’ ë³¸ì¸ ì¸ì¦</h3>
            <p class="text-xs text-slate-500 mb-4">í”„ë¡œí•„ ìˆ˜ì •ì„ ìœ„í•´ 4ìë¦¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br><span class="text-blue-500 font-bold mt-1 inline-block">(ì´ˆê¸° ë¹„ë²ˆì€ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜)</span></p>
            <input type="password" id="inputPin" maxlength="4" class="w-full text-center text-2xl font-bold tracking-[0.5em] border-b-2 border-slate-300 focus:border-blue-500 outline-none pb-2 mb-6" placeholder="â€¢â€¢â€¢â€¢">
            <div class="flex gap-2">
                <button onclick="closePinModal()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-xl text-sm">ì·¨ì†Œ</button>
                <button onclick="checkPin()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl text-sm">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="userEditModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md h-[90vh] overflow-y-auto p-6 relative">
            <h3 class="text-xl font-bold text-slate-800 mb-6 pb-2 border-b">âœï¸ ë‚´ ì •ë³´ ìˆ˜ì •</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs font-bold text-slate-500 mb-1 block">í”„ë¡œí•„ ì‚¬ì§„ (URL ì£¼ì†Œ)</label>
                    <div class="flex items-start gap-4">
                        <img id="userEditPreview" src="" class="w-16 h-16 rounded-2xl object-cover bg-slate-100 border border-slate-200" onerror="this.src='https://placehold.co/150?text=No+Img'">
                        <div class="flex-grow">
                            <input type="text" id="userImageUrlInput" placeholder="ì´ë¯¸ì§€ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°" class="w-full border p-3 rounded-xl text-xs font-bold bg-slate-50 focus:bg-white focus:border-blue-500 transition" oninput="updateUserPreview(this.value)">
                            <p class="text-[10px] text-slate-400 mt-1.5">
                                * ë””ìŠ¤ì½”ë“œ/ì¹´í†¡ ë“±ì— ì˜¬ë¦° ì‚¬ì§„ì˜ <strong>ì£¼ì†Œ(URL)</strong>ë¥¼ ë³µì‚¬í•´ ì˜¤ì„¸ìš”.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="text-xs font-bold text-slate-500 mb-2 block">ë°”ì§€ ìƒ‰ìƒ (10ê°€ì§€ í”„ë¦¬ì…‹)</label>
                    <div id="userTrunkColorPresets" class="flex flex-wrap gap-2">
                        </div>
                    <input type="hidden" id="userEditTrunkColor">
                </div>

                <div class="grid grid-cols-2 gap-3"><div><label class="text-xs font-bold text-slate-500 mb-1 block">í‚¤ (cm)</label><input type="text" id="userEditHeight" class="w-full border p-3 rounded-xl text-sm font-bold bg-slate-50"></div><div><label class="text-xs font-bold text-slate-500 mb-1 block">ë¦¬ì¹˜ (cm)</label><input type="text" id="userEditReach" class="w-full border p-3 rounded-xl text-sm font-bold bg-slate-50"></div></div>
                <div><label class="text-xs font-bold text-slate-500 mb-1 block">ìŠ¤íƒ ìŠ¤</label><select id="userEditStance" class="w-full border p-3 rounded-xl text-sm font-bold bg-slate-50"><option value="Orthodox">Orthodox (ì˜¤ë¥¸ì†)</option><option value="Southpaw">Southpaw (ì™¼ì†)</option><option value="Switch">Switch (ì–‘ì†)</option></select></div>
                <div><label class="text-xs font-bold text-slate-500 mb-1 block">Game ID</label><input type="text" id="userEditGameId" class="w-full border p-3 rounded-xl text-sm font-bold bg-slate-50"></div>
                <div><label class="text-xs font-bold text-slate-500 mb-1 block">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì„ íƒ)</label><input type="text" id="userEditPin" maxlength="4" class="w-full border p-3 rounded-xl text-sm font-bold bg-slate-50" placeholder="ë³€ê²½í•  ê²½ìš°ì—ë§Œ ì…ë ¥ (4ìë¦¬)"></div>
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-100"><label class="text-xs font-bold text-slate-500 mb-2 block">íŒŒì´íŒ… ìŠ¤íƒ€ì¼ (ìµœëŒ€ 3ê°œ)</label><div id="userStyleTags" class="flex flex-wrap gap-2"></div></div>
            </div>
            <div class="flex gap-3 mt-8"><button onclick="closeUserEdit()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3.5 rounded-xl text-sm">ì·¨ì†Œ</button><button onclick="saveUserProfile()" class="flex-1 bg-blue-600 text-white font-bold py-3.5 rounded-xl text-sm shadow-lg shadow-blue-500/30">ì €ì¥í•˜ê¸°</button></div>
        </div>
    </div>

    <div id="rulesModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeRules()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6 max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-black text-slate-800 mb-4 border-b pb-2">ğŸ“œ RFC ì ìˆ˜ ì‚°ì • ë°©ì‹</h2>
            <div id="ruleContentArea" class="space-y-5 text-sm text-slate-600">Loading...</div>
            <button onclick="closeRules()" class="w-full mt-6 bg-slate-800 text-white font-bold py-3 rounded-xl hover:bg-slate-900 transition">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk", authDomain: "rfk-ranking.firebaseapp.com", projectId: "rfk-ranking", storageBucket: "rfk-ranking.firebasestorage.app", messagingSenderId: "675366165774", appId: "1:675366165774:web:795d34c56eab630b4dcb5f", measurementId: "G-CXPDZQ8GTL" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const appId = 'ranking-manager-default';
        let rankingsData = []; let matchHistoryData = []; let enrichedMatchHistory = []; let seasonArchives = {}; let activeSeason = ""; let viewSeason = ""; let currentProfileId = null;
        const STYLE_OPTIONS = ["ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "í•˜ë“œ í€ì²˜", "ë°”ë”” ìŠ¤ë‚´ì²˜", "ë³¼ë¥¨ í€ì²˜", "ìŠ¤ìœ„ì¹˜ íˆí„°", "ë¸Œë¡¤ëŸ¬", "ì¹´ìš´í„° í€ì²˜", "ë³µì„œ-í€ì²˜", "ìŠ¬ë¦­", "ìƒ¤í”„ìŠˆí„°", "íŒ¨ìŠ¤íŠ¸ í•¸ë“œ"];
        const COLOR_PRESETS = [
            { name: "Black", code: "#1f2937" }, { name: "White", code: "#f8fafc" },
            { name: "Red", code: "#ef4444" }, { name: "Blue", code: "#3b82f6" },
            { name: "Green", code: "#22c55e" }, { name: "Yellow", code: "#eab308" },
            { name: "Purple", code: "#a855f7" }, { name: "Orange", code: "#f97316" },
            { name: "Pink", code: "#ec4899" }, { name: "Gray", code: "#94a3b8" }
        ];

        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
        
        // [Security] SHA-256 Hashing for Client Side Verification
        async function hashPin(pin) {
            if (!pin) return "";
            try {
                // crypto.subtle requires secure context (https)
                if (window.crypto && window.crypto.subtle) {
                    const msgBuffer = new TextEncoder().encode(pin);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                } else {
                    console.warn("Secure context required for crypto.subtle. Storing plaintext (not recommended for production).");
                    return pin; // Fallback for insecure environments
                }
            } catch (e) {
                console.error("Hashing failed:", e);
                return pin; // Fallback
            }
        }

        onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data(); rankingsData = data.rankings || []; matchHistoryData = data.matchHistory || []; activeSeason = data.activeSeason || "ì‹œì¦Œ 1"; seasonArchives = data.seasonArchives || {};
                const ruleArea = document.getElementById('ruleContentArea'); if(ruleArea) { if(data.ruleHtml) ruleArea.innerHTML = data.ruleHtml; else ruleArea.innerHTML = "ê·œì¹™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."; }
                if (!viewSeason) viewSeason = activeSeason;
                rankingsData.forEach(p => { if (!p.careerHighElo) p.careerHighElo = p.elo || 1000; });
                renderRankings();
                enrichMatchHistory(); updateUI();
                if (currentProfileId) updateProfileStats(currentProfileId, document.getElementById('pModalSeason').value);
            }
        });

        // Initialize User Edit Presets
        const presetContainer = document.getElementById('userTrunkColorPresets');
        COLOR_PRESETS.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-preset shadow-sm';
            div.style.backgroundColor = color.code;
            div.dataset.color = color.code; // [Fixed] Added data-color for robust comparison
            div.title = color.name;
            div.onclick = () => selectUserPresetColor(color.code, div);
            presetContainer.appendChild(div);
        });

        function selectUserPresetColor(code, element) {
            document.getElementById('userEditTrunkColor').value = code;
            document.querySelectorAll('#userEditModal .color-preset').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        function enrichMatchHistory() { const chronological = [...matchHistoryData].reverse(); const statsTracker = {}; enrichedMatchHistory = chronological.map(match => { const winner = match.winner; const loser = match.loser; if (!statsTracker[winner]) statsTracker[winner] = { w: 0, l: 0, h: [] }; if (!statsTracker[loser]) statsTracker[loser] = { w: 0, l: 0, h: [] }; const snapshot = { [winner]: { ...statsTracker[winner] }, [loser]: { ...statsTracker[loser] } }; if (match.type !== 'draw') { statsTracker[winner].w += 1; statsTracker[winner].h = [...statsTracker[winner].h, 'W'].slice(-6); statsTracker[loser].l += 1; statsTracker[loser].h = [...statsTracker[loser].h, 'L'].slice(-6); } return { ...match, snapshot }; }); enrichedMatchHistory.reverse(); }
        function updateUI() { const now = new Date(); document.getElementById('currentDate').textContent = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('seasonBadge').textContent = activeSeason; renderRankings(); updateSeasonSelector(); renderMatches(); renderHOF(); }
        function getTier(wins, losses) { const matches = (wins || 0) + (losses || 0); if (matches < 3) return { name: 'Bronze', class: 'tier-bronze', color: 'bg-amber-700' }; if (matches < 7) return { name: 'Silver', class: 'tier-silver', color: 'bg-slate-400' }; return { name: 'Gold', class: 'tier-gold', color: 'bg-yellow-500' }; }
        
        function renderRankings() { 
            const container = document.getElementById('rankingList'); container.innerHTML = ''; 
            const ranked = rankingsData.filter(p => (p.wins + p.losses) > 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
            const unranked = rankingsData.filter(p => (p.wins + p.losses) === 0).sort((a, b) => (b.elo || 1000) - (a.elo || 1000));

            ranked.forEach((p, idx) => { 
                const rank = idx + 1; const tier = getTier(p.wins, p.losses); const prevRank = p.previousRank || rank; const diff = prevRank - rank; 
                let diffHtml = `<span class="text-slate-300">-</span>`; if (diff > 0) diffHtml = `<span class="text-rose-500 font-bold text-xs">â–²${diff}</span>`; else if (diff < 0) diffHtml = `<span class="text-blue-500 font-bold text-xs">â–¼${Math.abs(diff)}</span>`; 
                let rankNumClass = "rank-num-normal"; if (rank === 1) rankNumClass = "rank-num-1 font-black"; else if (rank === 2) rankNumClass = "rank-num-2 font-black"; else if (rank === 3) rankNumClass = "rank-num-3 font-black"; 
                const myMatches = enrichedMatchHistory.filter(m => (m.winner === p.name || m.loser === p.name) && m.season === activeSeason && m.type !== 'draw').slice(0, 6); let dots = ''; myMatches.forEach(m => { if (m.winner === p.name) dots += `<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-sm"></div>`; else dots += `<div class="w-1.5 h-1.5 rounded-full bg-rose-500 shadow-sm"></div>`; }); 
                
                container.innerHTML += `
                    <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-3 relative overflow-hidden transition-transform active:scale-[0.99] cursor-pointer ${tier.class}" onclick="openProfile('${p.id}')">
                        <div class="flex flex-col items-center justify-center w-8 shrink-0"><span class="${rankNumClass}">${rank}</span><div class="mt-0.5">${diffHtml}</div></div>
                        <div class="shrink-0 relative">${p.imageUrl ? `<img src="${p.imageUrl}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100">` : `<div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-lg">ğŸ‘¤</div>`}${rank === 1 ? `<div class="absolute -top-1 -right-1 text-sm">ğŸ‘‘</div>` : ''}</div>
                        <div class="flex-grow min-w-0"><div class="flex items-center gap-1.5 mb-0.5">
                            <span class="font-bold text-slate-800 truncate text-sm">${p.name}</span><span class="text-[9px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 font-bold border border-slate-200">${tier.name}</span></div><div class="flex items-center gap-2 text-xs"><span class="font-bold text-amber-600 bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100">âš¡${p.elo || 1000}</span><span class="text-slate-300">|</span><span class="text-slate-500 font-medium">${p.wins}W ${p.losses}L</span></div></div><div class="flex flex-col items-end gap-1.5 shrink-0"><div class="flex gap-1 bg-slate-50 p-1 rounded-md">${dots || '<span class="text-[8px] text-slate-300">-</span>'}</div></div>
                    </div>`; 
            }); 

            if(unranked.length > 0) {
                container.innerHTML += `<div class="text-center text-xs text-slate-300 font-bold my-4">- Unranked Players -</div>`;
                unranked.forEach((p) => {
                    container.innerHTML += `
                        <div class="bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-3 relative overflow-hidden transition-transform active:scale-[0.99] cursor-pointer" onclick="openProfile('${p.id}')">
                            <div class="flex flex-col items-center justify-center w-8 shrink-0"><span class="rank-unranked">-</span></div>
                            <div class="shrink-0 relative">${p.imageUrl ? `<img src="${p.imageUrl}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100">` : `<div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-lg">ğŸ‘¤</div>`}</div>
                            <div class="flex-grow min-w-0"><div class="flex items-center gap-1.5 mb-0.5">
                                <span class="font-bold text-slate-500 truncate text-sm">${p.name}</span></div><div class="flex items-center gap-2 text-xs"><span class="bg-slate-100 text-slate-400 text-[10px] px-1.5 py-0.5 rounded border border-slate-200 font-bold">New</span><span class="text-slate-400 font-medium">0ìŠ¹ 0íŒ¨</span></div></div>
                        </div>`;
                });
            }
        }

        function updateSeasonSelector() { const selector = document.getElementById('seasonSelector'); selector.innerHTML = ''; const opts = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)]; opts.forEach(s => { const opt = document.createElement('option'); opt.value = s; opt.textContent = s + (s === activeSeason ? " (ì§„í–‰ì¤‘)" : ""); selector.appendChild(opt); }); selector.value = viewSeason; selector.onchange = (e) => { viewSeason = e.target.value; renderMatches(); renderHOF(); }; }
        
        function renderMatches() { 
            const container = document.getElementById('matchList'); 
            container.innerHTML = ''; 
            const filtered = enrichedMatchHistory.filter(m => (m.season || "ì‹œì¦Œ 1") === viewSeason && m.type !== 'draw'); 
            
            if (filtered.length === 0) { 
                container.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; 
                return; 
            } 
            
            filtered.forEach(m => { 
                const winStats = m.snapshot[m.winner] || { w:0, l:0, h:[] };
                const loseStats = m.snapshot[m.loser] || { w:0, l:0, h:[] };

                const winProfile = rankingsData.find(p => p.name === m.winner);
                const loseProfile = rankingsData.find(p => p.name === m.loser);
                
                const winClick = winProfile ? `onclick="openProfile('${winProfile.id}')"` : '';
                const loseClick = loseProfile ? `onclick="openProfile('${loseProfile.id}')"` : '';
                const cursorStyle = (profile) => profile ? "cursor-pointer hover:underline hover:text-blue-700" : "";

                let winDots = ''; (winStats.h || []).forEach(r => winDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`);
                let loseDots = ''; (loseStats.h || []).forEach(r => loseDots += `<div class="w-1.5 h-1.5 rounded-full ${r==='W'?'bg-emerald-400':'bg-rose-400'}"></div>`);

                const div = document.createElement('div'); 
                div.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-3"; 
                div.innerHTML = `
                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                        <span class="text-[10px] font-bold text-slate-400">${m.date}</span>
                    </div>
                    <div class="flex items-center justify-between text-sm">
                        <div class="flex flex-col items-start w-[45%] ${cursorStyle(winProfile)}" ${winClick}>
                            <div class="flex items-center gap-1.5">
                                <span class="text-sm font-black text-slate-800 truncate">${m.winner}</span>
                                <span class="bg-emerald-100 text-emerald-600 text-[9px] px-1 py-0.5 rounded font-bold">WIN</span>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${winStats.w}ìŠ¹ ${winStats.l}íŒ¨</span>
                                <div class="flex gap-0.5">${winDots}</div>
                            </div>
                        </div>
                        <div class="text-xs font-bold text-slate-300">VS</div>
                        <div class="flex flex-col items-end w-[45%] ${cursorStyle(loseProfile)}" ${loseClick}>
                            <div class="flex items-center gap-1.5">
                                <span class="bg-rose-100 text-rose-600 text-[9px] px-1 py-0.5 rounded font-bold">LOSE</span>
                                <span class="text-sm font-medium text-slate-500 truncate">${m.loser}</span>
                            </div>
                             <div class="flex items-center gap-2 mt-1">
                                <div class="flex gap-0.5">${loseDots}</div>
                                <span class="text-[9px] text-slate-400 font-medium bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">${loseStats.w}ìŠ¹ ${loseStats.l}íŒ¨</span>
                            </div>
                        </div>
                    </div>`; 
                container.appendChild(div); 
            }); 
        }

        function renderHOF() { const container = document.getElementById('hofContent'); let data = null; if (viewSeason === activeSeason) { if (rankingsData.length > 0) { data = { season: activeSeason + " (ì§„í–‰ì¤‘)", champion: rankingsData[0]?.name || "-", rank2: rankingsData[1]?.name || "-", rank3: rankingsData[2]?.name || "-" }; } } else { const arc = seasonArchives[viewSeason]; if (arc) { data = { season: viewSeason, champion: arc.champion, rank2: arc.rank2 || "-", rank3: arc.rank3 || "-" }; } } if (!data) { container.innerHTML = `<div class="text-center py-10 text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; } container.innerHTML = `<div class="text-center mb-6"><h3 class="text-lg font-black text-slate-800">${data.season}</h3></div><div class="grid grid-cols-3 gap-3 items-end text-center mb-8 px-2"><div class="bg-white p-3 rounded-t-xl border-t-4 border-slate-300 shadow-sm order-1 h-32 flex flex-col justify-end pb-2"><div class="text-2xl mb-1">ğŸ¥ˆ</div><div class="font-bold text-slate-700 text-sm truncate">${data.rank2}</div></div><div class="bg-white p-3 rounded-t-xl border-t-4 border-amber-400 shadow-md order-2 h-40 flex flex-col justify-end pb-4 relative z-10 -mx-1"><div class="text-4xl mb-1">ğŸ‘‘</div><div class="font-black text-slate-800 truncate">${data.champion}</div></div><div class="bg-white p-3 rounded-t-xl border-t-4 border-amber-700 shadow-sm order-3 h-28 flex flex-col justify-end pb-2"><div class="text-2xl mb-1">ğŸ¥‰</div><div class="font-bold text-slate-700 text-sm truncate">${data.rank3}</div></div></div>`; }
        window.openProfile = (id) => { currentProfileId = id; const p = rankingsData.find(x => x.id === id); if (!p) return; document.getElementById('pModalName').textContent = p.name; document.getElementById('pModalCrown').classList.toggle('hidden', rankingsData.indexOf(p) !== 0); document.getElementById('pModalGameId').textContent = `ID: ${p.gameId || '-'}`; document.getElementById('pModalImg').src = p.imageUrl || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='2'%3E%3Ccircle cx='12' cy='8' r='5'/%3E%3Cpath d='M20 21a8 8 0 0 0-16 0'/%3E%3C/svg%3E"; const filterEl = document.getElementById('pModalSeason'); filterEl.innerHTML = '<option value="all">ì „ì²´ ê¸°ë¡ (All Time)</option><option value="current">í˜„ì¬ ì‹œì¦Œ (Current)</option>'; Object.keys(seasonArchives).sort().reverse().forEach(s => { filterEl.innerHTML += `<option value="${s}">${s}</option>`; }); filterEl.value = 'current'; filterEl.onchange = (e) => updateProfileStats(id, e.target.value); const tier = getTier(p.wins, p.losses); const tierEl = document.getElementById('pModalTierBadge'); tierEl.textContent = tier.name; tierEl.className = `text-[10px] text-white font-bold px-2 py-0.5 rounded shadow-sm ${tier.color}`; document.getElementById('pModalHeight').textContent = p.height ? p.height + 'cm' : '-'; document.getElementById('pModalReach').textContent = p.reach ? p.reach + 'cm' : '-'; document.getElementById('pModalStance').textContent = p.stance || '-'; const tagsContainer = document.getElementById('pModalTags'); tagsContainer.innerHTML = ''; (p.tags || []).forEach(tag => { tagsContainer.innerHTML += `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">#${tag}</span>`; }); updateProfileStats(id, 'current'); document.getElementById('profileModal').classList.remove('hidden'); };
        window.closeProfile = () => { document.getElementById('profileModal').classList.add('hidden'); }
        
        window.updateProfileStats = (id, filter) => { 
            const p = rankingsData.find(x => x.id === id); 
            let matches = enrichedMatchHistory.filter(m => (m.winner === p.name || m.loser === p.name) && m.type !== 'draw'); 
            if (filter === 'current') matches = matches.filter(m => m.season === activeSeason); else if (filter !== 'all') matches = matches.filter(m => m.season === filter); 
            matches.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            let wins = 0, losses = 0; matches.forEach(m => { if (m.winner === p.name) wins++; else losses++; }); 
            const total = wins + losses; const winRate = total > 0 ? Math.round((wins / total) * 100) : 0; 
            document.getElementById('pBigWins').textContent = wins; document.getElementById('pBigLosses').textContent = losses; document.getElementById('pModalWinRate').textContent = `${winRate}%`; document.getElementById('pModalElo').textContent = p.elo || 1000; document.getElementById('pModalHighElo').textContent = p.careerHighElo || p.elo || 1000; 
            const container = document.getElementById('pModalMatchList'); container.innerHTML = ''; 
            if (matches.length === 0) { container.innerHTML = `<div class="text-center text-xs text-slate-400 py-4">í•´ë‹¹ ê¸°ê°„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; } 
            
            matches.forEach(m => { 
                const isWin = m.winner === p.name; const resultText = isWin ? 'W' : 'L'; const resultColor = isWin ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'; 
                const oppName = isWin ? m.loser : m.winner; 
                const oppStats = m.snapshot[oppName] || { w:0, l:0, h:[] }; const oppRecordStr = `${oppStats.w}ìŠ¹ ${oppStats.l}íŒ¨`; 
                let oppDots = ''; (oppStats.h || []).forEach(res => { if (res === 'W') oppDots += `<div class="w-1 h-1 rounded-full bg-emerald-400"></div>`; else oppDots += `<div class="w-1 h-1 rounded-full bg-rose-400"></div>`; }); 
                
                const oppProfile = rankingsData.find(u => u.name === oppName);
                const oppLink = oppProfile ? `onclick="openProfile('${oppProfile.id}')"` : '';
                const oppCursor = oppProfile ? 'cursor-pointer hover:underline hover:text-blue-600' : '';

                const div = document.createElement('div'); 
                div.className = "flex items-center justify-between text-xs p-3 bg-slate-50 rounded-xl border border-slate-100"; 
                div.innerHTML = `
                    <div class="flex items-center gap-3 w-full">
                        <span class="font-bold ${resultColor} w-8 h-8 flex items-center justify-center rounded-lg text-sm shrink-0">${resultText}</span>
                        <div class="flex flex-col w-full overflow-hidden">
                            <div class="flex justify-between items-center w-full">
                                <span class="font-bold text-slate-700 text-sm truncate ${oppCursor}" ${oppLink}>vs ${oppName}</span>
                                <span class="text-slate-300 font-medium text-[10px] shrink-0">${m.date}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-[10px] text-slate-400 font-medium bg-white px-1.5 py-0.5 rounded border border-slate-100">ë‹¹ì‹œ: ${oppRecordStr}</span>
                                <div class="flex gap-0.5">${oppDots}</div>
                            </div>
                        </div>
                    </div>`; 
                container.appendChild(div); 
            }); 
        };

        window.openRules = () => document.getElementById('rulesModal').classList.remove('hidden'); window.closeRules = () => document.getElementById('rulesModal').classList.add('hidden');
        window.switchTab = (tab) => { ['ranking', 'matches', 'hof', 'tournament'].forEach(t => { document.getElementById(t + 'Section').classList.add('hidden'); const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1)); btn.className = "tab-inactive flex-1 py-3 text-sm transition-colors text-center"; }); document.getElementById(tab + 'Section').classList.remove('hidden'); const activeBtn = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)); activeBtn.className = "tab-active flex-1 py-3 text-sm transition-colors text-center"; };

        let editTargetId = null;

        window.requestEdit = () => { if (!currentProfileId) return; editTargetId = currentProfileId; document.getElementById('inputPin').value = ''; document.getElementById('pinModal').classList.remove('hidden'); document.getElementById('inputPin').focus(); };
        window.closePinModal = () => document.getElementById('pinModal').classList.add('hidden');
        
        // [Security] Enhanced PIN Check (Plain vs Hash)
        window.checkPin = async () => { 
            const input = document.getElementById('inputPin').value; 
            const p = rankingsData.find(x => x.id === editTargetId); 
            const userPin = p.password || "0000"; 
            
            let isMatch = false;
            if (userPin.length === 4) {
                // Legacy support for plain text PINs
                if (input === userPin) isMatch = true;
            } else {
                // Check Hash
                const inputHash = await hashPin(input);
                if (inputHash === userPin) isMatch = true;
            }

            if (isMatch) { 
                closePinModal(); openUserEditModal(p); 
            } else { 
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); document.getElementById('inputPin').value = ''; 
            } 
        };

        function openUserEditModal(p) {
            document.getElementById('userEditHeight').value = p.height || ''; document.getElementById('userEditReach').value = p.reach || ''; document.getElementById('userEditStance').value = p.stance || 'Orthodox'; document.getElementById('userEditGameId').value = p.gameId || ''; document.getElementById('userEditPin').value = ''; 
            document.getElementById('userImageUrlInput').value = p.imageUrl || ''; document.getElementById('userEditPreview').src = p.imageUrl || 'https://placehold.co/150?text=No+Img';
            
            // [Fixed] User Edit Trunk Color Init (Robust Comparison)
            const tc = p.trunkColor || '#1f2937';
            document.getElementById('userEditTrunkColor').value = tc;
            document.querySelectorAll('#userEditModal .color-preset').forEach(el => {
                // Use dataset.color if available for precise matching
                const presetColor = el.dataset.color;
                if((presetColor && presetColor.toLowerCase() === tc.toLowerCase()) || 
                   el.style.backgroundColor === tc || 
                   (tc.toUpperCase() === el.style.backgroundColor.toUpperCase())) {
                    el.classList.add('active');
                } else {
                    el.classList.remove('active');
                }
            });

            const container = document.getElementById('userStyleTags'); container.innerHTML = ''; 
            STYLE_OPTIONS.forEach(s => { const safeId = `u-style-${s.replace(/\s+/g, '-')}`; const checked = (p.tags || []).includes(s); container.innerHTML += `<div><input type="checkbox" id="${safeId}" value="${s}" class="style-checkbox absolute opacity-0 w-0 h-0" ${checked ? 'checked' : ''}><label for="${safeId}" class="inline-block px-3 py-1 text-xs font-bold border border-slate-300 rounded-full cursor-pointer text-slate-500 hover:bg-slate-100 transition select-none">${s}</label></div>`; });
            document.getElementById('userEditModal').classList.remove('hidden');
        }

        window.closeUserEdit = () => document.getElementById('userEditModal').classList.add('hidden');
        window.updateUserPreview = (url) => { document.getElementById('userEditPreview').src = url || 'https://placehold.co/150?text=No+Img'; };

        // [Security] Transaction based save for User Edit
        window.saveUserProfile = async () => {
            if (!editTargetId) return;
            const newHeight = document.getElementById('userEditHeight').value.replace(/</g, "&lt;"); // [Security] Basic Sanitization
            const newReach = document.getElementById('userEditReach').value.replace(/</g, "&lt;");
            const newStance = document.getElementById('userEditStance').value;
            const newGameId = document.getElementById('userEditGameId').value.replace(/</g, "&lt;");
            const newImageUrl = document.getElementById('userImageUrlInput').value.trim().replace(/</g, "&lt;");
            const newTrunkColor = document.getElementById('userEditTrunkColor').value;
            const inputPin = document.getElementById('userEditPin').value;
            
            const checkedTags = document.querySelectorAll('#userStyleTags .style-checkbox:checked'); 
            const newTags = Array.from(checkedTags).map(cb => cb.value).slice(0, 3);

            let newPassword = null;
            if (inputPin && inputPin.length === 4) {
                newPassword = await hashPin(inputPin); // Hash new pin
            }

            try {
                await runTransaction(db, async (transaction) => {
                    const sfDoc = await transaction.get(docRef);
                    if (!sfDoc.exists()) throw "Doc missing";
                    
                    const data = sfDoc.data();
                    const rankings = data.rankings || [];
                    
                    // Find index in the LATEST data (not the stale local data)
                    const idx = rankings.findIndex(r => r.id === editTargetId);
                    if (idx === -1) throw "User not found";

                    // Update only specific fields
                    rankings[idx].height = newHeight;
                    rankings[idx].reach = newReach;
                    rankings[idx].stance = newStance;
                    rankings[idx].gameId = newGameId;
                    rankings[idx].imageUrl = newImageUrl;
                    rankings[idx].trunkColor = newTrunkColor;
                    rankings[idx].tags = newTags;
                    if (newPassword) rankings[idx].password = newPassword;

                    // Write back the FULL array with the single updated item
                    transaction.update(docRef, { rankings: rankings });
                });
                
                alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeUserEdit();
                if (currentProfileId === editTargetId) openProfile(currentProfileId); // Refresh UI
            } catch (e) {
                console.error(e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤ (ë‹¤ë¥¸ ì‚¬ëŒì´ ìˆ˜ì • ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤). ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        };
    </script>
</body>
</html>
